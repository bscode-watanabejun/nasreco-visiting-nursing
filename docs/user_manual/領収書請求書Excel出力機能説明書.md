# 領収書・請求書Excel出力機能説明書

## 概要

領収書・請求書Excel出力機能は、医療保険または介護保険の利用者について、領収書または請求書のExcel帳票を自動生成する機能です。

この機能により、手作業で領収書・請求書を作成する手間を省き、レセプトデータから自動的に帳票を生成できます。

---

## 出力できる条件

以下の条件をすべて満たす場合にのみ、Excel出力が可能です：

1. **医療保険または介護保険の利用者であること**
   - 医療保険と介護保険の両方に対応しています

2. **レセプトが確定済みであること**
   - 未確定のレセプトは出力できません

3. **以下の情報が登録されていること**
   - 患者情報（氏名、患者番号、カナ氏名など）
   - 保険証情報（医療保険証または介護保険証）
   - 訪問記録（対象月の訪問記録）

---

## 出力される内容

Excel帳票には、以下の情報が自動的に入力されます。各情報がどのセルに出力されるかを以下に示します。

### セルと出力内容の対応表

#### ヘッダー部分（2行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| B2 | 対象年月 | レセプトの対象年月を和暦形式で表示（例：令和7年11月分） | ✅ 実装済み |
| L2 | 書類種別 | 「請求書」または「領収書」を表示（ボタン選択に応じて自動設定） | ✅ 実装済み |
| U2 | 出力年月日 | Excel出力を実行した日付を和暦形式で表示（例：令和7年12月10日） | ✅ 実装済み |

#### 請求書番号・患者情報（4-7行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| E4 | 請求書No | 10桁の請求書番号（yyyymm + 連番4桁、例：20251200001）<br>出力日が変わると連番がリセットされます | ✅ 実装済み |
| E5 | 患者番号 | 患者の患者番号 | ✅ 実装済み |
| E6 | カナ氏名 | 患者のカタカナ氏名 | ✅ 実装済み |
| E7 | 氏名 | 患者の漢字氏名（姓 + 名） | ✅ 実装済み |

#### 施設情報（4行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| N4 | 施設情報 | 施設の住所、施設名、電話番号を改行区切りで表示<br>電話番号の前には「TEL：」を付与 | ✅ 実装済み |

#### 金額情報（9行目、11行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| C9 | 請求書/領収書の文言 | 請求書の場合：「下記の通り医療費及び介護費をご請求申し上げます」<br>領収書の場合：「下記の通り医療費及び介護費を領収いたしました」 | ✅ 実装済み |
| E11 | 合計金額 | 負担額の合計金額（医療保険の場合はU33、介護保険の場合はU53と同じ値） | ✅ 実装済み |
| M11 | 領収金額 | 領収書の場合：負担額の合計金額（E11と同じ値）<br>請求書の場合：0 | ✅ 実装済み |

#### 医療保険の場合（13行目、18-33行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| W13 | 負担割合 | 医療保険証の負担割合（例：1割、2割、3割） | ✅ 実装済み |
| D18-D27 | サービス名 | レセプト対象のサービス名（最大10個まで）<br>同じサービス名でグルーピングし、重複は表示しません | ✅ 実装済み |
| Q18-Q27 | 点数 | 各サービス名に対応する点数（最大10個まで）<br>末尾に「点」を付与（例：555点） | ✅ 実装済み |
| S18-S27 | 回数 | 各サービス名に対応する回数（最大10個まで）<br>訪問看護療養費明細書Excel出力の摘要欄の日数出力と同じ仕様 | ✅ 実装済み |
| U18-U27 | 単価 | 各サービス名に対応する単価（最大10個まで）<br>訪問看護療養費明細書Excel出力の摘要欄の金額出力と同じ仕様 | ✅ 実装済み |
| W18-W27 | 負担額 | 各サービス名に対応する負担額（最大10個まで）<br>計算式：回数 × 単価 × 負担割合（10円未満は四捨五入） | ✅ 実装済み |
| U30 | 点数の合計 | Q18-Q27の点数の合計 | ✅ 実装済み |
| U31 | 負担額の合計 | W18-W27の負担額の合計 | ✅ 実装済み |
| U33 | 負担額の合計 | U31と同じ値（E11とM11の合計金額として使用） | ✅ 実装済み |

#### 介護保険の場合（35行目、38-53行目）

| セル | 出力内容 | 説明 | 実装状況 |
|------|---------|------|---------|
| W35 | 負担割合 | 介護保険証の負担割合（例：1割、2割、3割） | ✅ 実装済み |
| D38-D47 | サービス名 | レセプト対象のサービス名（最大10個まで）<br>同じサービス名でグルーピングし、重複は表示しません | ✅ 実装済み |
| Q38-Q47 | 点数 | 各サービス名に対応する点数（最大10個まで）<br>末尾に「点」を付与（例：555点） | ✅ 実装済み |
| S38-S47 | 回数 | 各サービス名に対応する回数（最大10個まで）<br>訪問看護療養費明細書Excel出力の摘要欄の日数出力と同じ仕様 | ✅ 実装済み |
| U38-U47 | 単価 | 各サービス名に対応する単価（最大10個まで）<br>訪問看護療養費明細書Excel出力の摘要欄の金額出力と同じ仕様 | ✅ 実装済み |
| W38-W47 | 負担額 | 各サービス名に対応する負担額（最大10個まで）<br>計算式：回数 × 単価 × 負担割合（10円未満は四捨五入） | ✅ 実装済み |
| U51 | 負担額の合計 | W38-W47の負担額の合計 | ✅ 実装済み |
| U53 | 負担額の合計 | U51と同じ値（E11とM11の合計金額として使用） | ✅ 実装済み |

---

## 実装状況の凡例

- ✅ **実装済み**: データが自動的に出力されます

---

## 出力方法

### 手順

1. **レセプト一覧画面**から、出力したいレセプトを選択して詳細画面を開きます

2. レセプト詳細画面の右上にある**「領収書・請求書出力」**ボタンをクリックします

3. ドロップダウンメニューから、**「請求書」**または**「領収書」**を選択します

4. Excelファイルの生成が完了すると、自動的にダウンロードが開始されます

5. ダウンロードされたExcelファイルを開いて、内容を確認します

### ファイル名

ダウンロードされるExcelファイルの名前は、以下の形式です：

```
請求書_YYYYMM_患者番号.xlsx
領収書_YYYYMM_患者番号.xlsx
```

例：
- `請求書_202511_00001.xlsx`（2025年11月分、患者番号00001の請求書）
- `領収書_202511_00001.xlsx`（2025年11月分、患者番号00001の領収書）

---

## 注意事項

### 出力できない場合

以下の場合、Excel出力ができません：

- レセプトが未確定の場合
- 必要な情報が不足している場合（患者情報、保険証情報、訪問記録など）
- 医療保険または介護保険証が登録されていない場合

エラーメッセージが表示された場合は、内容を確認して必要な情報を登録してください。

### データの反映について

- Excel出力は、**出力時点のデータ**を基に生成されます
- 出力後にデータを変更しても、既にダウンロードしたExcelファイルには反映されません
- データを変更した場合は、再度Excel出力を実行してください

### 請求書番号について

請求書番号（E4セル）は、以下のルールで自動生成されます：

- **形式**: 10桁（yyyymm + 連番4桁）
  - 例：`20251200001`（2025年12月の1番目の請求書）
- **連番の管理**: 施設ごとに独立して管理されます
- **リセット**: 出力日が変わると連番がリセットされます（日付プレフィックスが変わるため）
- **重複防止**: データベースで管理されているため、サーバーを再起動しても重複しません

### サービス名のグルーピングについて

サービス名（D18-D27、D38-D47）は、訪問看護療養費明細書Excel出力の摘要欄の名称出力と同じ仕様でグルーピングされます：

- 同じサービスコードの訪問記録は、1つのサービス名として集計されます
- 基本療養費と管理療養費は別々のサービスとして表示されます
- 加算もサービスコードごとに集計されます
- 最大10個までのサービス名を表示できます（10個を超える場合は最初の10個のみ表示）

### 負担額の計算について

負担額（W18-W27、W38-W47）は、以下の計算式で算出されます：

```
負担額 = 回数 × 単価 × 負担割合
```

その後、10円未満は四捨五入されます。

**計算例**：
- 回数: 8回
- 単価: 5,550円
- 負担割合: 1割（10%）
- 合計金額: 8 × 5,550 = 44,400円
- 負担額: 44,400 × 0.1 = 4,440円

### 医療保険と介護保険の違いについて

- **医療保険の場合**: W13セルに負担割合、D18-D27、Q18-Q27、S18-S27、U18-U27、W18-W27、U30、U31、U33セルにデータを出力
- **介護保険の場合**: W35セルに負担割合、D38-D47、Q38-Q47、S38-S47、U38-U47、W38-W47、U51、U53セルにデータを出力
- どちらの場合も、E11とM11セルには負担額の合計が出力されます

---

## よくある質問

### Q1. 請求書と領収書の違いは何ですか？

A. 請求書は、利用者に対して医療費・介護費を請求する書類です。M11セルには0が表示されます。領収書は、医療費・介護費を受け取ったことを証明する書類です。M11セルには負担額の合計が表示されます。

### Q2. 請求書番号が重複することはありますか？

A. いいえ、請求書番号はデータベースで管理されているため、重複することはありません。施設ごとに独立して管理され、出力日が変わると連番がリセットされます。

### Q3. 複数のレセプトを一度に出力できますか？

A. 現時点では、1件ずつ出力する仕様です。複数レセプトの一括出力機能は、今後の実装予定です。

### Q4. Excelファイルを編集できますか？

A. はい、ダウンロードしたExcelファイルは自由に編集できます。ただし、編集した内容はシステムには反映されません。

### Q5. サービス名が10個を超える場合はどうなりますか？

A. サービス名は最大10個まで表示されます。10個を超える場合は、最初の10個のみが表示されます。コンソールに警告メッセージが出力されます。

### Q6. 負担額の計算が正しくない場合は？

A. 負担額は「回数 × 単価 × 負担割合」で計算され、10円未満は四捨五入されます。計算結果が正しくない場合は、以下の点を確認してください：
- 保険証の負担割合が正しく登録されているか
- 訪問記録のサービスコードが正しく設定されているか
- サービスコードマスタの点数が正しいか

---

## 関連機能

- **医療保険レセプトCSV出力**: オンライン請求用のCSVファイルを出力する機能
- **介護保険レセプトCSV出力**: 介護保険のオンライン請求用のCSVファイルを出力する機能
- **訪問看護療養費明細書Excel出力**: 医療保険の利用者向けの詳細なExcel帳票を出力する機能
- **レセプト詳細画面**: レセプトの詳細情報を確認・編集する画面

---

**最終更新日**: 2025年12月10日

**更新履歴**:
- 2025年12月10日: 領収書・請求書Excel出力機能の初版を作成
