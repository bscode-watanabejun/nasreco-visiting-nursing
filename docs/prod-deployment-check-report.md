# 本番環境への再デプロイ影響確認レポート

**確認日**: 2025年1月
**確認対象**: mainブランチの本番環境への再デプロイ
**確認内容**: 開発環境と本番環境のデータベース差異

---

## 📋 確認結果サマリー

### ✅ デプロイ安全性: **安全**

本番環境への再デプロイは安全です。スキーマ変更は既存データに影響を与えません。

---

## 🔍 スキーマ差異

### 1. テーブル一覧
- **本番環境**: 33テーブル
- **開発環境**: 33テーブル
- **結果**: ✅ 一致

### 2. カラム定義の差異

#### monthly_receiptsテーブル
**本番環境に存在しないカラム（追加予定）**:
- `partial_burden_amount` (integer, NULL許容)
- `reduction_category` (varchar(1), NULL許容)
- `reduction_rate` (integer, NULL許容)
- `reduction_amount` (integer, NULL許容)
- `certificate_number` (varchar(3), NULL許容)

**影響分析**:
- ✅ すべてNULL許容のため、既存データに影響なし
- ✅ 既存のレセプトデータはそのまま維持される
- ✅ 新規フィールドはNULLのまま
- ✅ CSV出力時はNULLの場合は空文字列として出力（仕様通り）

### 3. ENUM型
- ✅ すべて一致

### 4. インデックス
- ✅ 一致

---

## 📊 データ差異

### 施設情報
- **本番環境**: 10件
- **開発環境**: 10件
- **差異**: 施設コードの設定状況が異なる（運用上の違い）

**「訪問看護ステーションソレア春日部」**:
- ID: `2d4562ce-1aae-4d79-80ec-0b128654e466`
- 施設コード: `0690404`
- 都道府県コード: `11`（埼玉県）
- 住所: 埼玉県春日部市中央１丁目５８−４ 最高研ビル202
- 電話番号: 050-5846-2602

### ユーザー情報
- **本番環境**: 17名
- **開発環境**: 15名
- **ソレア春日部**: 4名（管理者2名、看護師1名、その他1名）

### 患者情報
- **本番環境**: 26名（アクティブ26名）
- **開発環境**: 30名（アクティブ30名）
- **ソレア春日部**: 4名（すべてアクティブ）

### 訪問記録
- **本番環境**: 197件
- **開発環境**: 236件
- **ソレア春日部**: 39件（完了済み14件）
- **訪問期間**: 2025年11月5日〜11月19日

### レセプト情報
- **本番環境**: 18件（確定済み1件、送信済み0件）
  - 医療保険: 9件
  - 介護保険: 9件
- **ソレア春日部**: 0件（まだレセプトが作成されていない）

### マスタデータ
- **サービスコードマスタ**: 
  - 本番環境の方が多い（医療保険: 229件 vs 208件）
  - 運用上の違いによるもの
- **加算マスタ**: ほぼ同じ
- **その他**: 運用上の違いによるデータ量の差異

---

## ⚠️ スキーマ変更の影響

### 追加されるカラム
1. `partial_burden_amount` - 一部負担金額
2. `reduction_category` - 減免区分（別表9）
3. `reduction_rate` - 減額割合（0-100%）
4. `reduction_amount` - 減額金額
5. `certificate_number` - 証明書番号（国保の場合のみ）

### 安全性
- ✅ **すべてNULL許容**: 既存データに影響なし
- ✅ **デフォルト値なし**: 既存レセプトはNULLのまま
- ✅ **既存データは変更されない**: データ整合性が保たれる
- ✅ **CSV出力**: NULLの場合は空文字列として出力（仕様通り）

---

## 📝 デプロイ時の注意事項

### 1. スキーマ変更の実行
本番環境で以下のコマンドを実行する必要があります：
```bash
npm run db:push
```

### 2. 実行タイミング
- アプリケーションの再デプロイ前に実行
- または、アプリケーションの再デプロイと同時に実行可能

### 3. 影響範囲
- ✅ 既存のレセプトデータ: 影響なし（NULLのまま維持）
- ✅ 既存の機能: 影響なし
- ✅ 新規機能: レセプト詳細画面に「一部負担金額・減免情報」セクションが追加される

---

## ✅ デプロイ安全性の最終確認

### スキーマ変更
- ✅ NULL許容カラムの追加のみで安全
- ✅ 既存データに影響なし
- ✅ データ整合性が保たれる

### データ整合性
- ✅ 既存のレセプトデータは変更されない
- ✅ 新規フィールドはNULLのまま
- ✅ CSV出力時はNULLの場合は空文字列として出力（仕様通り）

### 機能追加
- ✅ レセプト詳細画面に「一部負担金額・減免情報」セクションが追加される
- ✅ 既存のレセプトでも新規フィールドを入力可能
- ✅ 確定済みレセプトは編集不可（既存の動作と同じ）

### 「訪問看護ステーションソレア春日部」への影響
- ✅ 施設情報: 正常に確認できました
- ✅ ユーザー情報: 正常に確認できました（4名）
- ✅ 患者情報: 正常に確認できました（4名）
- ✅ 訪問記録: 正常に確認できました（39件）
- ✅ レセプト情報: 0件（影響なし）
- ✅ スキーマ変更: NULL許容カラムの追加のみで安全
- ✅ 既存データ: 変更されません
- ✅ 運用: 影響なし

---

## 📊 結論

### ✅ 本番環境への再デプロイは安全です

**理由**:
1. スキーマ変更はNULL許容カラムの追加のみ
2. 既存データに影響なし
3. データ整合性が保たれる
4. 「訪問看護ステーションソレア春日部」のデータや運用に影響なし

**推奨事項**:
1. 本番環境で`npm run db:push`を実行してスキーマ変更を適用
2. アプリケーションを再デプロイ
3. レセプト詳細画面で新機能が正常に動作することを確認

---

## 📋 確認スクリプト

以下のスクリプトで確認を実施しました：
- `scripts/compare-dev-prod-schema.ts` - スキーマ差異確認
- `scripts/check-prod-deployment-impact.ts` - デプロイ影響確認
- `scripts/check-prod-data-differences.ts` - データ差異確認
- `scripts/check-solera-kasukabe-data.ts` - ソレア春日部データ確認

