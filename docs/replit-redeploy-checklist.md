# Replitからの再デプロイ チェックリスト

## 📋 デプロイ前の確認事項

### 1. データベース関連

- [ ] **本番環境のデータベースバックアップを取得**
  - 主要テーブルのバックアップ
  - 特に重要なデータ（patients, users, facilities, nursing_records等）

- [ ] **スキーマの差分を確認**
  - 現在のmainブランチのスキーマと本番環境のスキーマに差分があるか
  - 差分がある場合、どのような変更が発生するか

- [ ] **データベース接続文字列の確認**
  - `DATABASE_URL`が本番環境の正しい接続文字列を指しているか
  - Replitの環境変数設定を確認

### 2. 環境変数

- [ ] **`DATABASE_URL`の設定確認**
  - 本番環境のデータベース接続文字列が設定されているか
  - 値: `postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require`

- [ ] **`SESSION_SECRET`の設定確認**
  - セッション暗号化用シークレットが設定されているか
  - 値が正しく設定されているか

- [ ] **`PORT`の設定確認**
  - `.replit`ファイルで5000に設定済み
  - 変更不要

- [ ] **`NODE_ENV`の設定確認**
  - デプロイ時に自動的に`production`に設定される
  - 確認不要

### 3. アプリケーションコード

- [ ] **mainブランチの最新コードを確認**
  - 最近のコミットを確認（最新10件を確認済み）
  - 重大な変更がないか確認

- [ ] **ビルドエラーの確認**
  - `npm run check`で型エラーがないか確認
  - `npm run build`でビルドエラーがないか確認

- [ ] **テストの確認**
  - テストが完了しているか
  - 既存機能への影響がないか

### 4. 運用

- [ ] **デプロイ時間の決定**
  - 推奨: 業務時間外（夜間または休日）
  - 実行時間: 約10-15分（バックアップ含む）

- [ ] **ユーザーへの通知**
  - 必要に応じてメンテナンス通知
  - ダウンタイムの可能性を通知

- [ ] **ロールバック手順の確認**
  - データベースのロールバック手順
  - アプリケーションのロールバック手順

## 🚀 デプロイ実行

### 実行手順

1. **Replitでデプロイを実行**
   - Replitのデプロイボタンをクリック
   - デプロイプロセスを監視

2. **デプロイプロセスの監視**
   - `npm run db:push`の実行状況を確認
   - `npm run build`の実行状況を確認
   - エラーの有無を確認

3. **デプロイ後の確認**
   - アプリケーションが正常に起動しているか
   - データベース接続が正常か
   - 主要機能が正常に動作するか

## ✅ デプロイ後の検証

### 機能確認

- [ ] ログインが正常に動作するか
- [ ] 訪問記録の表示が正常か
- [ ] サービスコードの選択が正常か
- [ ] 月次レセプトの作成が正常か
- [ ] データの表示が正常か

### データ確認

- [ ] データベースのデータが正常に表示されるか
- [ ] スキーマ変更によるデータ不整合がないか
- [ ] 外部キー制約が正常に機能しているか

### パフォーマンス確認

- [ ] レスポンス時間が正常か
- [ ] エラーログに異常がないか
- [ ] メモリ使用量が正常か

## 🔄 ロールバック手順

### ロールバック条件

以下の場合にロールバックを検討:
- スキーマ変更によるデータ不整合が発生した場合
- アプリケーションが起動しない場合
- 重大なバグが発見された場合
- ユーザーからの重大な報告があった場合

### ロールバック実行

1. **データベースのロールバック**
   - バックアップからデータベースを復元

2. **アプリケーションのロールバック**
   - 前のバージョンにデプロイを戻す
   - または、Replitで前のデプロイを再デプロイ

## 📝 実行記録

実行日時: _______________

実行者: _______________

実行結果:
- [ ] 成功
- [ ] 失敗（理由: _______________）

備考:
_________________________________

