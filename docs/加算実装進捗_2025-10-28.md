# 加算実装進捗レポート - 2025-10-28

## 📊 実装状況サマリー

### 完了項目
- ✅ **Week 1**: 退院時共同指導加算（医療保険）+ 特別管理指導加算
- ✅ **Week 2**: 退院時支援指導加算（基本 + 長時間）
- ✅ **Week 3**: 専門管理加算（介護 & 医療）

### 未実装項目
- ⏳ **Week 4**: 訪問看護情報提供療養費1

---

## 🎯 Week 1実装内容（完了）

### 実装した加算
1. **退院時共同指導加算（医療保険）**: 8,000円
   - コード: `medical_discharge_joint_guidance`
   - 条件: 退院日の訪問 + 多職種連携記録あり

2. **特別管理指導加算**: 2,000円
   - コード: `discharge_special_management_guidance`
   - 条件:
     - 退院時共同指導加算が同じ訪問記録で算定されている
     - 患者が特別管理の対象（`specialManagementTypes`が存在）

### 技術的実装
- **2フェーズ評価システムの導入**
  - Phase 1: 独立した加算を評価
  - Phase 2: 他の加算に依存する加算を評価
- **新規評価関数**
  - `evaluatePatientHasSpecialManagement()`: 患者の特別管理状態確認
  - `evaluateHasDischargeJointGuidanceInSameRecord()`: 同一訪問記録での加算算定確認
- **BonusCalculationContext拡張**
  - `specialManagementTypes`フィールド追加

### テスト結果
```
算定点数: 17,300点
- 退院時共同指導加算（医療保険）: +8,000点
- 特別管理指導加算: +2,000点
- 24時間対応体制加算: +6,800点
```

### コミット
- コミットID: `05e8a37`
- ブランチ: `develop` (リモートプッシュ済み)

---

## 🎯 Week 2実装内容（完了）

### 実装した加算
1. **退院時支援指導加算（基本）**: 6,000円
   - コード: `discharge_support_guidance_basic`
   - 条件: 退院日の訪問（`is_discharge_date = true`）

2. **退院時支援指導加算（長時間）**: 8,400円
   - コード: `discharge_support_guidance_long`
   - 条件: 退院日の訪問 + 90分超の訪問時間

### 技術的実装

#### 1. evaluateDurationBased関数の拡張
**新形式（conditions配列）に対応:**
```json
{
  "conditions": [
    {
      "durationMinutes": 90,
      "operator": "greater_than",
      "points": 8400,
      "description": "90分超の訪問"
    }
  ],
  "defaultPoints": 0
}
```

**旧形式との後方互換性維持:**
```json
{
  "duration_90": 520
}
```

#### 2. ソートロジックの重要な修正
**問題:** 固定点数（`fixedPoints`）のみでソートしていたため、条件分岐タイプ（`pointsType: "conditional"`）の加算が後回しになっていた

**修正内容 (server/bonus-engine.ts:973-979):**
```typescript
// 修正前
applicableBonuses.sort((a, b) => {
  const pointsA = a.fixedPoints || 0;
  const pointsB = b.fixedPoints || 0;
  return pointsB - pointsA; // 降順
});

// 修正後
applicableBonuses.sort((a, b) => {
  const orderA = a.displayOrder || 999;
  const orderB = b.displayOrder || 999;
  return orderA - orderB; // 昇順
});
```

**影響:** すべての加算の評価順序が`display_order`で統一され、条件分岐タイプも正しく優先評価される

#### 3. データベース設定
- `predefined_conditions`を標準形式に変更
- 相互排他設定（`cannot_combine_with`）
  - 基本版 ⇔ 長時間版
  - 長時間版 ⇔ 長時間訪問看護加算
- `display_order`設定
  - `discharge_support_guidance_long`: 29（優先）
  - `medical_long_visit`: 30
  - `discharge_support_guidance_basic`: 104

### テスト結果

**テストケース1（60分訪問）:**
```
退院時支援指導加算: 6,000点 ✅
```

**テストケース2（120分訪問）:**
```
算定点数: 15,700点
- 退院時支援指導加算（長時間）: +8,400点 ✅
- 24時間対応体制加算: +6,800点
```

### トラブルシューティング履歴

**問題1:** テストケース2で長時間版が適用されず、基本版6,000円 + 長時間訪問看護加算520円が適用された

**原因:**
- ソートロジックが`fixedPoints`ベース
- 基本版（6,000円）が長時間版（fixedPoints=null）より優先
- 基本版適用後、相互排他ルールで長時間版がスキップ

**解決策:** `display_order`ベースのソートに変更

### コミット
- コミットID: `05f4847`
- ブランチ: `develop` (リモートプッシュ済み)

---

## 🔧 システム全体への影響

### 評価エンジンの改善点
1. **2フェーズ評価**: 加算間の依存関係を正しく処理
2. **duration_basedパターン拡張**: 新旧両形式に対応
3. **ソートロジック統一**: `display_order`による優先順位制御

### 既存機能への互換性
- ✅ 既存の`duration_based`パターン（旧形式）は引き続き動作
- ✅ すべての加算が`display_order`で評価順序を制御可能
- ✅ 後方互換性を維持しながら新機能を追加

---

## 🎯 Week 3実装内容（完了）

### 実装した加算
1. **専門管理加算（医療保険）**: 2,500点
   - コード: `specialist_management`
   - 条件:
     - 専門研修を受けた看護師が訪問
     - 専門分野のケアを実施（緩和ケア、褥瘡ケア、人工肛門・膀胱ケア、特定行為）
     - 専門分野と実施ケアが一致
     - 月1回まで算定可能

2. **専門管理加算（介護保険）**: 250点
   - コード: `care_specialist_management`
   - 条件:
     - 専門研修を受けた看護師が訪問
     - 専門分野のケアを実施
     - 専門分野と実施ケアが一致
     - 月1回まで算定可能

### 技術的実装

#### 1. 評価関数の追加（bonus-engine.ts）
**新規評価関数**:
- `evaluateRequiresSpecializedNurse()`: 専門研修受講チェック
  - 看護師の`specialistCertifications`配列に資格が含まれているかを確認
- `evaluateSpecialtiesMatch()`: 専門分野とケア種類のマッチング
  - 専門分野名（緩和ケア、褥瘡ケア等）をケアタイプ（palliative_care、pressure_ulcer等）にマッピング
  - 看護師の資格と実施したケアが一致するかをチェック
- `evaluateMonthlyVisitLimit()`: 月次訪問制限チェック（既存関数、統合）
  - データベースで当月の同一加算適用回数を確認

**条件パターン追加**:
```typescript
case "requires_specialized_nurse":
  result = evaluateRequiresSpecializedNurse(context);
  break;

case "specialties_match":
  result = evaluateSpecialtiesMatch(condition.value, context);
  return result; // 独自評価のため早期リターン

case "monthly_visit_limit":
  result = { passed: true, reason: "月次訪問制限チェックは後続処理で実施" };
  break; // calculateBonuses内で非同期チェック実施
```

#### 2. コンテキスト拡張（routes.ts）
**BonusCalculationContextに追加**:
- `assignedNurse`: 訪問看護師の情報
  - `id`: 看護師ID
  - `fullName`: 氏名
  - `specialistCertifications`: 専門資格配列
- `specialistCareType`: 実施した専門的ケアの種類

**看護師情報の取得**:
```typescript
const assignedNurse = recordData.nurseId ? await db.query.users.findFirst({
  where: eq(users.id, recordData.nurseId),
  columns: {
    id: true,
    fullName: true,
    specialistCertifications: true,
  }
}) : undefined;
```

#### 3. フロントエンド実装（NursingRecords.tsx）
**記録詳細画面に専門的ケアの種類を表示**:
```tsx
{selectedRecord.specialistCareType && (
  <div>
    <p className="text-sm font-medium text-muted-foreground mb-2">専門的ケアの種類</p>
    <div className="bg-purple-50 border border-purple-200 rounded-md p-3">
      <p className="text-sm">
        {selectedRecord.specialistCareType === 'palliative_care' && '緩和ケア'}
        {selectedRecord.specialistCareType === 'pressure_ulcer' && '褥瘡ケア'}
        {selectedRecord.specialistCareType === 'stoma_care' && '人工肛門・人工膀胱ケア'}
        {selectedRecord.specialistCareType === 'specific_procedures' && '特定行為'}
      </p>
    </div>
  </div>
)}
```

#### 4. 専門分野マッピング
```typescript
const specialtyMapping: Record<string, string> = {
  '緩和ケア': 'palliative_care',
  '褥瘡ケア': 'pressure_ulcer',
  '人工肛門ケア': 'stoma_care',
  '人工膀胱ケア': 'stoma_care',
  '特定行為研修': 'specific_procedures',
};
```

#### 5. UI改善実装（2025-10-31追加）

**専門資格管理UI（UserManagement.tsx）**:
- ユーザー管理画面で看護師自身が専門資格を設定可能
- チェックボックス形式で4種類の資格を選択
  - 緩和ケア
  - 褥瘡ケア
  - 人工肛門・人工膀胱ケア
  - 特定行為研修
- 看護師ロールのみ表示・編集可能

**警告・推奨システム（NursingRecords.tsx）**:
```typescript
// ケアタイプと資格のマッピング
const careTypeToSpecialty: Record<string, string> = {
  'palliative_care': '緩和ケア',
  'pressure_ulcer': '褥瘡ケア',
  'stoma_care': '人工肛門・人工膀胱ケア',
  'specific_procedures': '特定行為研修',
};

// 選択されたケアに対応する資格を持っているかチェック
const hasMatchingCert = selectedCareSpecialty ? userCerts.includes(selectedCareSpecialty) : false;
```

**警告の種類**:
1. **赤い警告（destructive Alert）**: 選択したケアに対応する専門資格がない
   - 例: 「人工肛門・人工膀胱ケア」資格のみ保有で「緩和ケア」を選択
   - メッセージ: "「緩和ケア」の専門資格が登録されていません。専門管理加算は適用されません。"

2. **青い推奨（info Alert）**: 専門資格を持っているがケアを選択していない
   - 例: 「緩和ケア」資格保有でケア未選択
   - メッセージ: "あなたは専門資格（緩和ケア）を保有しています。専門的ケアを実施した場合は選択してください。"

**データ永続化の修正（storage.ts）**:
- `getUsersByFacilityPaginated()` のSELECT句に `specialistCertifications` を追加
- `getUsersByCompanyPaginated()` のSELECT句に `specialistCertifications` を追加
- これによりAPIレスポンスに専門資格情報が含まれるようになった

**キャッシュ管理の改善（useUsers.ts）**:
```typescript
onSuccess: (updatedUser) => {
  queryClient.invalidateQueries({ queryKey: userQueryKeys.lists() });
  // ユーザー更新時にcurrentUserキャッシュも無効化
  queryClient.invalidateQueries({ queryKey: ['currentUser'] });
}
```
- ユーザー情報更新後、`currentUser`のキャッシュを無効化
- 専門資格の変更が即座に全画面に反映される（ログアウト不要）

**UX改善（routes.ts）**:
- 権限エラーメッセージを詳細化
  - 修正前: "権限がありません"
  - 修正後: "他のユーザーの情報を変更する権限がありません。自分自身の情報のみ変更できます。"

### テスト結果

#### 自動テスト（test-specialist-management-bonus.mjs）
```
✅ テストケース1: 医療保険 + 緩和ケア（専門資格あり）
   → 専門管理加算: 2,500点

✅ テストケース2: 介護保険 + 褥瘡ケア（専門資格あり）
   → 専門管理加算（介護保険）: 250点

✅ テストケース3: 専門資格なし
   → 専門管理加算: 適用されない（期待通り）

総テスト数: 3
成功: 3
失敗: 0
```

#### 手動テスト（UI）
**テストケース1（医療保険 + 緩和ケア）**:
```
算定点数: 9,800点
- 24時間対応体制加算（看護業務負担軽減）: +6,800点
- 専門管理加算: +2,500点 ✅

専門的ケアの種類: 緩和ケア ✅
```

**テストケース2（介護保険 + 褥瘡ケア）**:
```
算定点数: 1,324点
- 緊急時訪問看護加算（I）（介護保険）: +574点
- 専門管理加算（介護保険）: +250点 ✅

専門的ケアの種類: 褥瘡ケア ✅
```

**テストケース3（専門資格なし）**:
```
算定点数: 7,300点
- 24時間対応体制加算（看護業務負担軽減）: +6,800点

専門的ケアの種類: 緩和ケア ✅
※ 専門管理加算は適用されない（期待通り）✅
```

### トラブルシューティング履歴

**問題1**: `nurseId`がコンテキストに含まれていなかった
- **原因**: `recordData`に`nurseId`が含まれていなかった
- **解決策**: `req.user.id`を`recordData`にスプレッドして追加

**問題2**: `specialties_match`の評価が失敗
- **原因**: 評価後に汎用operatorチェックが実行され、boolean値と配列を比較していた
- **解決策**: `specialties_match`ケースで早期リターンを追加

**問題3**: `monthly_visit_limit`条件が"Unknown condition type"エラー
- **原因**: `evaluatePredefinedCondition`のswitch文に`monthly_visit_limit`ケースがなかった
- **解決策**: 暫定的に`passed: true`を返し、`calculateBonuses`内の既存の非同期チェックに委譲

**問題4（UI実装）**: 専門資格が保存されない
- **原因**: `storage.ts`のユーザー一覧取得クエリで`specialistCertifications`がSELECT句に含まれていなかった
- **解決策**: `getUsersByFacilityPaginated()`と`getUsersByCompanyPaginated()`のSELECT句に追加

**問題5（UI実装）**: 専門資格の変更が即座に反映されない
- **原因**: `useCurrentUser`フックが5分間のキャッシュを持ち、ユーザー更新後も古いキャッシュが使用されていた
- **解決策**: ユーザー更新時に`currentUser`キャッシュを無効化（`queryClient.invalidateQueries`）

**問題6（UI実装）**: 対応しない専門資格を持っている場合に警告が表示されない
- **原因**: 「何らかの専門資格を持っているか」だけをチェックし、「選択したケアに対応する資格を持っているか」をチェックしていなかった
- **解決策**: ケアタイプと資格のマッピングを追加し、選択したケアに対応する資格の有無を正確にチェック

**問題7（データベース設定）**: 専門管理加算が実際の記録で適用されない（Critical）
- **原因1**: `predefined_conditions`がオブジェクト形式 `{"all": [...]}` で保存されていたが、加算エンジンは配列形式 `[...]` を期待
- **原因2**: 専門資格名の不一致（DB: `"人工肛門ケア"`, `"人工膀胱ケア"` / ユーザーデータ・UI: `"人工肛門・人工膀胱ケア"`）
- **解決策**:
  1. `predefined_conditions`を配列形式に修正
  2. 資格名を `"人工肛門・人工膀胱ケア"` に統一（DB、bonus-engine.ts、ユーザーデータ）
- **検証**: 10月31日の既存記録で加算が適用されていたことから、修正のタイミングを確認できた

**問題8（加算マスタ管理UI）**: 専門管理加算の条件が技術的なパターン名で表示
- **原因**: Week 3実装時に条件パターンの人間可読な説明を追加していなかった
- **表示内容**: "1 requires_specialized_nurse 2 specialties_match 3 monthly_visit_limit"
- **解決策**: BonusMasterManagement.tsxに以下を追加
  - `requires_specialized_nurse`: "看護師が専門資格を保有している"
  - `specialties_match`: "専門的ケアの種類と看護師の専門資格が一致（対象: 緩和ケア、褥瘡ケア、人工肛門・人工膀胱ケア、特定行為研修）"
  - `monthly_visit_limit`: "月次算定制限内（月1回まで）"

### データベース設定

**bonus_master テーブル**:
```sql
-- 医療保険
specialist_management
  - points_type: 'fixed'
  - fixed_points: 2500
  - predefined_conditions: [
      {"pattern": "requires_specialized_nurse", "operator": "equals", "value": true},
      {"pattern": "specialties_match", "value": ["緩和ケア", "褥瘡ケア", "人工肛門・人工膀胱ケア", "特定行為研修"]},
      {"pattern": "monthly_visit_limit", "value": 1}
    ]

-- 介護保険
care_specialist_management
  - points_type: 'fixed'
  - fixed_points: 250
  - predefined_conditions: 同上

-- ⚠️ 重要: JSON構造は配列形式 [...] であり、オブジェクト形式 {"all": [...]} ではない
-- ⚠️ 重要: 専門資格名は「人工肛門・人工膀胱ケア」（中黒で結合）で統一
```

### コミット履歴
1. **Week 3実装完了 - 専門資格管理UIと警告システムを追加**
   - 専門資格チェックボックスUI実装
   - 警告・推奨メッセージシステム実装
   - storage.ts、useUsers.ts、useCurrentUser.tsの修正

2. **Week 3 専門管理加算UI実装完了と専門資格名の統一**
   - データベース設定修正（JSON構造、資格名統一）
   - bonus-engine.ts の specialtyMapping 更新
   - 全4種類の専門的ケアで加算適用確認完了

3. **加算マスタ管理で専門管理加算の条件表示を改善**
   - 条件パターンの人間可読な説明を追加
   - 特殊な値（配列、数値）の表示処理を実装
   - BonusMasterManagement.tsx の UI/UX 改善

ブランチ: `main`

---

## 🌿 ブランチ管理状況

### アクティブなブランチ
```
main (現在のブランチ)
├─ Week 1実装
├─ Week 2実装
└─ Week 3実装
```

### 本番環境
```
main (origin/main)
└─ Week 1, 2, 3の変更はまだプッシュされていない
```

### クリーンアップ完了
- ✅ `feature/path-based-multitenancy` - 削除完了（mainにマージ済み）
- ✅ `feature/phase4-bonus-calculation-engine` - 削除完了（mainにマージ済み）

---

## 💡 重要な学び

### 1. ソートロジックの重要性
加算の評価順序は**点数の高さではなく、業務ロジック上の優先順位**で決めるべき。`display_order`を使用することで柔軟に制御可能。

### 2. 条件分岐タイプの加算
`pointsType: "conditional"`の加算は`fixedPoints`が`null`になるため、点数ベースのソートでは正しく評価されない。

### 3. 相互排他ルール
`cannot_combine_with`は強力だが、評価順序と組み合わせて使う必要がある。優先したい加算を先に評価する設計が重要。

### 4. データベース設定の重要性
加算エンジンはデータベース駆動型のため、コード変更なしでロジックを調整できる。ただし、設定ミスは実装ミスと同じ影響を持つ。

---

## 💡 Week 3での学び

### 1. 看護師情報のコンテキスト伝播
`nurseId`を`req.user.id`から取得し、加算計算コンテキストに明示的に含める必要がある。セッションユーザーと訪問看護師が同じ場合でも、コンテキストに明示的に渡す設計が重要。

### 2. 条件評価の早期リターンパターン
独自の評価ロジックを持つ条件（`specialties_match`）は、汎用のoperatorチェックをスキップするため早期リターンが必要。これにより型不一致エラーを防ぐ。

### 3. 非同期評価の委譲
`monthly_visit_limit`のような非同期評価が必要な条件は、同期的な`evaluatePredefinedCondition`では処理せず、`calculateBonuses`内の専用ロジックに委譲する設計が適切。

### 4. UIでの条件付き表示
専門的ケアの種類など、条件によって入力される情報は、記録詳細画面でも表示することでユーザーの理解と確認が容易になる。

### 5. 自動テストスクリプトの価値
手動UIテストは時間がかかるため、自動テストスクリプト（test-specialist-management-bonus.mjs）を作成することで、実装の正確性を迅速に検証できる。

### 6. ストレージレイヤーでのフィールド選択の重要性（UI実装）
ORMのクエリビルダーで明示的にフィールドを列挙する場合、新しいフィールドを追加したら必ずSELECT句にも追加する必要がある。`select()`や`db.select({...})`で明示的にフィールドを指定している箇所を全て確認すること。

### 7. キャッシュ管理の重要性（UI実装）
TanStack Queryのキャッシュ管理では、関連するクエリのキャッシュを適切に無効化する必要がある。特にユーザー情報のような複数の場所で参照されるデータは、更新時に全ての関連キャッシュを無効化すること。

### 8. UIバリデーションの正確性（UI実装）
警告やバリデーションメッセージは、単純な「あり/なし」ではなく、具体的な条件に基づいて表示する必要がある。ユーザーの意図と実際の状態を正確にマッチングすることで、誤った警告を防ぐ。

### 9. データベース設定のJSON構造（Critical）
加算エンジンはデータベース駆動型のため、`predefined_conditions`のJSON構造が重要。配列形式 `[...]` とオブジェクト形式 `{"all": [...]}` は異なる。コード側の期待する形式を正確に把握し、データベースに保存する必要がある。

### 10. ネーミングの一貫性（データ品質）
専門資格名などのマスタデータは、データベース、バックエンドコード、フロントエンドUIで完全に一致させる必要がある。特に日本語の表記揺れ（「人工肛門ケア」vs「人工肛門・人工膀胱ケア」）は注意が必要。

### 11. 加算マスタ管理UIの説明文（UX）
技術的なパターン名だけでなく、人間が理解できる説明文を提供することで、管理者が加算の適用条件を正しく理解できる。特に新規実装時は説明文の追加を忘れがち。

### 12. 過去データによる検証（デバッグ手法）
問題が発生した際、過去の正常動作していた記録を調べることで、いつから問題が発生したのか、何が変わったのかを特定できる。タイムスタンプベースのデータ分析は有効なデバッグ手法。

---

## 📞 次回セッション時のクイックスタート

```bash
# 現在のブランチ確認
git branch

# mainブランチにいることを確認
# いない場合は: git checkout main

# 最新の変更を確認
git log --oneline -5

# Week 4実装開始
# 1. 訪問看護情報提供療養費1の仕様確認
# 2. 実装計画の立案
# 3. 実装とテスト
```

---

**作成日**: 2025-10-28
**最終更新**: 2025-10-31（Week 3完了）
**次回予定**: Week 4 - 訪問看護情報提供療養費1の実装
