# 本番環境再デプロイ前のDB差異確認ガイド

このドキュメントは、Replitから本番環境へ再デプロイする前に、開発環境と本番環境のデータベース差異を確認する手順を説明します。

## 📋 概要

再デプロイ前に、以下の項目を確認します：

1. **スキーマの差異** - テーブルやカラムの違い
2. **マスターデータの差異** - サービスコード、加算マスタ等の違い
3. **テナントデータの確認** - 「訪問看護ステーションソレア春日部」のデータ保護
4. **本番環境の重要なデータ** - 確定済みレセプト等の保護が必要なデータ
5. **再デプロイの影響分析** - デプロイによる影響の有無

## 🚀 実行方法

### 前提条件

- Node.js 20以上がインストールされていること
- プロジェクトの依存関係がインストールされていること（`npm install`済み）

### 実行コマンド

プロジェクトルートから以下のコマンドを実行します：

```bash
npx tsx docs/release/check-deployment-impact.ts
```

または、`scripts`ディレクトリから：

```bash
npx tsx scripts/check-deployment-impact-comprehensive.ts
```

### 実行例

```bash
$ npx tsx docs/release/check-deployment-impact.ts

🔍 開発環境と本番環境の包括的なDB差異確認

⚠️  本番データベースに接続します（読み取り専用）

════════════════════════════════════════════════════════════════════════════════

📊 1. データベーススキーマの比較
────────────────────────────────────────────────────────────────────────────────
   本番環境のテーブル数: 33
   開発環境のテーブル数: 33
   ✅ テーブル構成は一致しています

   ⚠️  スキーマ差異:
      - facilities: 本番に存在しないカラム [care_insurance_facility_number]

...

✅ 包括的なDB差異確認が完了しました
```

## 📊 確認項目の詳細

### 1. スキーマの比較

- テーブル一覧の比較
- 各テーブルのカラム構造の比較
- 本番環境に存在しないカラムの検出

**注意**: 本番環境に存在しないカラムが検出された場合、Replitデプロイ時に自動で`npm run db:push`が実行され、スキーマが同期されます。

### 2. 施設情報の比較

- 本番環境と開発環境の施設一覧
- 「訪問看護ステーションソレア春日部」の存在確認

### 3. マスターデータの比較

以下のマスターデータを比較します：

- サービスコードマスタ
- 加算マスタ
- 訪問場所コード
- 職員資格コード
- 都道府県コード
- レセプト種別コード

**注意**: マスターデータの件数の差異は通常問題ありません。本番環境に追加のマスタデータが存在する場合があります。

### 4. ソレア春日部のテナントデータ確認

本番環境の「訪問看護ステーションソレア春日部」の以下のデータを確認します：

- 患者数
- 訪問記録数
- 月次レセプト数
- ユーザー数

**重要**: これらのデータは保護が必要です。再デプロイによって削除や変更されることはありません。

### 5. 本番環境にのみ存在する重要なデータ

- 確定済みレセプトの件数
- 送信済みレセプトの件数

**重要**: これらのデータは保護が必要です。

### 6. 全テーブルのデータ件数比較

主要テーブルのデータ件数を比較し、本番環境にデータが存在するテーブルを確認します。

### 7. 再デプロイの影響分析

スキーマ変更の影響を分析し、再デプロイが安全かどうかを判定します。

## ✅ 再デプロイの安全性判定

スクリプトの実行結果に基づいて、以下のように判定されます：

### ✅ 安全な場合

- スキーマ変更がNULL許容カラムの追加のみ
- 既存データに影響がない
- 警告事項がない

### ⚠️ 注意が必要な場合

- スキーマ変更に注意が必要な項目がある
- 警告事項がある

## 📝 Replitデプロイ時の自動処理

Replitから再デプロイする際、`.replit`ファイルの設定により、以下の処理が自動で実行されます：

```toml
[deployment]
build = ["sh", "-c", "npm run db:push && npm run build"]
run = ["npm", "run", "start"]
```

つまり：

1. **`npm run db:push`** - スキーマ同期が自動実行される
2. **`npm run build`** - アプリケーションのビルド
3. **`npm run start`** - 本番サーバーの起動

**重要**: 手動で`npm run db:push`を実行する必要はありません。Replitデプロイ時に自動で実行されます。

## 📋 デプロイ前のチェックリスト

スクリプト実行後、以下の項目を確認してください：

- [ ] 本番環境の`DATABASE_URL`が正しく設定されている（Replit環境変数）
- [ ] 本番環境の`SESSION_SECRET`が設定されている（Replit環境変数）
- [ ] 本番環境の`NODE_ENV=production`が設定されている（通常は自動）
- [ ] 本番環境のバックアップが取得されている（推奨）
- [ ] スキーマ変更が検出された場合、Replitデプロイ時に自動で適用されることを確認

## 📋 デプロイ後の確認事項

デプロイ後、以下の項目を確認してください：

- [ ] アプリケーションが正常に起動する
- [ ] ソレア春日部のデータが正常にアクセスできる
- [ ] 既存のレセプトデータが正常に表示される
- [ ] ユーザーログインが正常に動作する
- [ ] エラーログに異常がない

## 🔍 トラブルシューティング

### エラー: データベース接続エラー

- `DATABASE_URL`が正しく設定されているか確認
- ネットワーク接続を確認
- Neon PostgreSQLのステータスを確認

### エラー: テーブルが見つからない

- スキーマが正しく同期されているか確認
- `npm run db:push`を手動で実行して確認

### 警告: ソレア春日部が見つからない

- 施設名の表記を確認（「ソレア」「春日部」を含む）
- 本番環境の`facilities`テーブルを直接確認

## 📚 関連ドキュメント

- [CLAUDE.md](../../CLAUDE.md) - プロジェクト全体のガイダンス
- [RELEASE_NOTES.md](./RELEASE_NOTES.md) - リリースノート
- [deployment-impact-analysis.md](../deployment-impact-analysis.md) - デプロイ影響分析

## 🔄 更新履歴

- 2025-01-XX: 初版作成

