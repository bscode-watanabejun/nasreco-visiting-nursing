# リリースノート

このドキュメントは本番環境へのリリース履歴を記録します。

---

## 2025-11-07（午後予定）

### 🗓️ スケジュール管理の改善

#### 1. スケジュール画面から訪問記録詳細への遷移不具合を修正
**問題**: スケジュール一覧から「記録詳細」をクリックして詳細画面を見た後、「戻る」でスケジュールに戻り、再度「記録詳細」をクリックしても画面が遷移しない不具合がありました

**修正内容**:
- URLの戻り先を正しく指定するようにしました
- スケジュール画面と訪問記録詳細画面の行き来が確実に動作するようになりました

**コミット**: `bd28e84` - fix: スケジュール画面から訪問記録詳細画面への遷移不具合を修正

#### 2. スケジュール繰り返し作成時の時刻ズレを修正
**問題**: 毎週同じ時間（例：9:00-10:00）のスケジュールを繰り返し作成すると、18:00-19:00で登録されてしまう不具合がありました

**原因**: データベースがUTC（世界標準時）で保存する際、日本時間（JST）との9時間の時差を正しく処理できていませんでした

**修正内容**: 時刻の処理をUTC基準に変更し、正確に指定した時刻でスケジュールが作成されるようになりました

**コミット**: `1bea5f3` - fix: スケジュール繰り返し作成の時刻オフセット問題を修正

#### 3. 訪問記録作成・編集時のスケジュールステータス自動更新
**新機能**: 訪問記録を作成または編集すると、スケジュールのステータスが自動的に更新されるようになりました

**動作の詳細**:
- 訪問ステータスが「完了」→ スケジュールが「完了」に
- 訪問ステータスが「未実施」または「不在」→ スケジュールが「予定」に
- 訪問ステータスが「キャンセル」「拒否」「日程変更」→ スケジュールが「キャンセル」に

**追加修正**: スケジュール一覧から訪問記録詳細に遷移した際、常に最新のデータが表示されるようになりました

**コミット**: `f1e49aa` - fix: 訪問記録とスケジュールステータスの連携を改善

---

### 📝 訪問記録（記録管理）の改善

#### 1. 90分超過警告機能（新規追加）
**機能内容**:
- 訪問の開始時刻と終了時刻を入力し、訪問時間が90分を超えた場合、**基本記録タブに警告バナー**が表示されます
- 「レセプト・加算」タブで理由の入力が必要であることを通知します
- 訪問時間はリアルタイムで計算されます

**バリデーション強化**:
- 記録を「完成」状態で保存する際、90分超の訪問で理由が未入力の場合はエラーが表示され保存できません
- 緊急訪問看護加算にチェックを入れた場合も理由が必須になります
- 複数回訪問にチェックを入れた場合も理由が必須になります

**コミット**: `c843af1` - feat: 訪問記録UI改善 - 90分超警告とバリデーション強化

#### 2. 編集権限管理機能（新規追加）
**実装内容**:
- 訪問記録の編集権限が厳格に管理されるようになりました
- データベースに編集履歴テーブルが追加され、誰がいつ編集したかが記録されます

**権限の詳細**:
- **下書き・完成状態の記録**: 作成者本人または管理者のみが編集可能
- **レビュー済み記録**: 管理者のみが編集可能
- 編集権限がない場合は編集ボタンが無効化され、マウスを乗せると「編集権限がありません」と表示されます

**データベース変更**:
- `nursing_record_edit_history` テーブル追加（編集履歴記録）
- `nursing_records` テーブルに `lastEditedBy`、`editCount` カラム追加

**コミット**: `ce8ae58` - feat: 訪問記録画面のUI改善と編集権限管理機能の実装

#### 3. タブUIの改善
**変更内容**:
- 訪問記録画面が5タブ構成に変更されました
  1. **基本記録**: 開始/終了時間、訪問目的、観察事項
  2. **バイタル・ケア**: バイタルサイン（体温、血圧等）とケア内容
  3. **特管記録**: 特別管理の記録
  4. **レセプト・加算**: レセプト情報と加算管理
  5. **写真・メモ**: 写真とメモ

- スマートフォンでも見やすいように最適化されました（タブ名の省略表示など）

**コミット**: `ce8ae58` に含まれる

#### 4. その他のUI改善
**訪問看護指示書とケアプランのクリック領域**:
- 誤って展開してしまうことを防ぐため、文字部分のみがクリック可能になりました
- 行全体をクリックしても展開されなくなりました

**コミット**: `787b1ee` - refactor: 訪問看護指示書とケアプランのクリック領域を文字のみに制限

**記録未作成一覧画面のエラー修正**:
- 記録未作成一覧を開いた際に発生していたエラーを修正しました

**コミット**: `4ee9c77` - fix: 記録未作成一覧画面のnullエラーを修正

**その他の視覚的問題の修正**:

**コミット**: `060c414` - fix: 訪問記録UIの視覚的な問題を修正

---

### 👥 利用者管理（患者管理）の改善

#### 1. 保険証・公費情報の管理機能拡張
**追加された機能**:
- 患者詳細画面に保険証の詳細フィールドが追加されました
- 公費負担医療受給者証の登録・管理機能が追加されました（レセプト請求に使用）
- 訪問看護指示書の詳細フィールドが追加されました

**注意**: これらはレセプト（請求書）作成のための機能で、スタッフの方が日常的に使用する機能ではありません

**コミット**:
- `45ad446` - feat: Phase 3データベーススキーマ追加 - 訪問看護指示書フィールド
- `154e10d` - feat: Phase 3完了 - 公費管理と保険証・医師指示書の拡張フィールド対応
- `15ba456` - feat: 患者詳細画面にPhase 3保険証フィールド表示を追加

---

### 📱 実際の操作への影響まとめ

#### よく使う操作での変化:
1. **スケジュール → 記録詳細 → 戻る → 再度記録詳細**: 確実に動作するようになりました
2. **毎週のスケジュール作成**: 指定した時刻通りに正確に作成されます
3. **訪問記録の作成・編集**: 自動的にスケジュールステータスが更新されます
4. **90分超の訪問**: 警告が表示され、理由の入力が必須になります
5. **他のスタッフの記録**: 閲覧のみ可能で、誤って編集する心配がなくなりました

---

### 🔧 技術的な変更

#### データベーススキーマ変更
- `nursing_record_edit_history` テーブル追加
- `nursing_records` テーブルに以下のカラム追加:
  - `lastEditedBy`: 最終編集者ID
  - `editCount`: 編集回数

#### その他のバックエンド改善
- レセプト関連のマスタデータ投入スクリプトに重複対策を追加
- 介護保険の時間帯判定でタイムゾーン変換を正確に処理
- レセプトマスタ管理のアクセス制御（管理者のみ）

**コミット**:
- `80e3e2a` - fix: マスタデータ投入スクリプトに重複対策を追加
- `158214a` - fix: 介護保険の時間帯判定でタイムゾーン変換を追加
- `1a04d0d` - feat: レセプトマスタ管理のアクセス制御を実装

---

## リリース履歴

| リリース日 | 主な変更内容 | コミット範囲 |
|-----------|------------|------------|
| 2025-11-07 | スケジュール・訪問記録の改善、編集権限管理 | `1bea5f3`～`f1e49aa` |

