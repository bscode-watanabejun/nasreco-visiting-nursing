# Replitからの再デプロイ 最終影響分析レポート

## 📋 調査結果のサマリー

### デプロイプロセス

Replitのデプロイ設定により、以下の順序で実行されます：
1. `npm run db:push` - データベーススキーマの変更を反映
2. `npm run build` - アプリケーションのビルド
3. `npm run start` - 本番サーバーの起動

### スキーマ差分の確認結果

#### ✅ 主要テーブルの確認

| テーブル | 本番環境のカラム数 | スキーマファイルの定義 | 差分 |
|---------|-----------------|-------------------|------|
| bonus_calculation_history | 12件 | 12件 | なし |
| nursing_service_codes | 11件 | 11件 | なし |
| nursing_records | 49件 | 49件（推定） | なし |

#### ✅ 外部キー制約

- **総数**: 62件
- **サービスコード関連**: 2件（正常）
  - `bonus_calculation_history.service_code_id → nursing_service_codes.id`
  - `nursing_records.service_code_id → nursing_service_codes.id`

#### ✅ インデックス

- **総数**: 39件
- **サービスコード関連**: 1件（正常）

### 本番環境の現状

| 項目 | 状態 |
|------|------|
| テーブル数 | 32テーブル（すべて存在） |
| データ件数 | 訪問記録181件、患者25件、ユーザー17件等 |
| サービスコードマスタ | 21件（31から始まる誤ったコード） |
| スキーマ構造 | 正常 |

## 🔍 デプロイ時の影響予測

### スキーマ変更の可能性

#### カラムの追加・削除
- **主要テーブル**: 差分なし ✅
- **その他のテーブル**: 詳細な確認が必要

#### 型の変更
- drizzle-kit push実行時に検出される可能性
- カラムの型、制約、デフォルト値の違いが検出される可能性

#### 制約の変更
- 外部キー制約、チェック制約、ユニーク制約の違いが検出される可能性

### リスク評価

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| スキーマ変更によるデータ不整合 | 中 | 低 | バックアップ取得、差分確認 |
| カラムの削除によるデータ損失 | 高 | 低 | バックアップ取得 |
| 型変更によるエラー | 中 | 低 | 事前確認 |
| ダウンタイム | 中 | 高 | 業務時間外実行 |
| 環境変数の設定ミス | 高 | 低 | 事前確認 |

### 結論

**主要テーブルにはカラムの差分がないため、デプロイ時のスキーマ変更のリスクは低いと判断されます。**

ただし、型の違いや制約の違いはdrizzle-kit push実行時に検出される可能性があるため、デプロイ前にバックアップを取得し、デプロイ後は動作確認を実施することを強く推奨します。

## 📋 デプロイ前の必須確認事項

### 1. データベース関連

- [ ] **本番環境のデータベースバックアップを取得**
  - 主要テーブルのバックアップ
  - 特に重要なデータ（patients, users, facilities, nursing_records等）

- [ ] **スキーマの差分を確認**
  - ✅ 主要テーブルのカラム構造を確認済み（差分なし）
  - ⚠️  型の違いや制約の違いはdrizzle-kit push実行時に検出される可能性

### 2. 環境変数

- [ ] **`DATABASE_URL`の設定確認**
  - 本番環境のデータベース接続文字列が設定されているか
  - 値: `postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require`

- [ ] **`SESSION_SECRET`の設定確認**
  - セッション暗号化用シークレットが設定されているか

### 3. アプリケーション

- [ ] **ビルドエラーの確認**
  - ✅ 型チェック: 成功（確認済み）
  - [ ] ビルドテスト: 実行推奨

### 4. 運用

- [ ] **デプロイ時間の決定**
  - 推奨: 業務時間外（夜間または休日）
  - 実行時間: 約10-15分（バックアップ含む）

## 🚀 デプロイ実行手順

### 実行前

1. バックアップ取得
2. 環境変数の確認
3. デプロイ時間の決定

### 実行中

1. Replitでデプロイを実行
2. `npm run db:push`の実行状況を監視
3. `npm run build`の実行状況を監視
4. エラーの有無を確認

### 実行後

1. アプリケーションが正常に起動しているか確認
2. データベース接続が正常か確認
3. 主要機能が正常に動作するか確認
4. スキーマ変更によるデータ不整合がないか確認

## 🔄 ロールバック計画

### ロールバック条件

以下の場合にロールバックを検討:
- スキーマ変更によるデータ不整合が発生した場合
- アプリケーションが起動しない場合
- 重大なバグが発見された場合

### ロールバック手順

1. **データベースのロールバック**
   - バックアップからデータベースを復元

2. **アプリケーションのロールバック**
   - 前のバージョンにデプロイを戻す
   - または、Replitで前のデプロイを再デプロイ

## 📊 サービスコードマスタ入れ替えとの関係

### 推奨実行順序

1. **まずReplitからの再デプロイを実行**
   - アプリケーションコードの更新
   - スキーマの更新（必要な場合）

2. **その後、サービスコードマスタの入れ替えを実行**
   - サービスコードマスタの更新
   - 訪問記録の参照更新

### 理由

- デプロイとサービスコードマスタの入れ替えは別々の作業
- デプロイを先に実行することで、最新のコードでサービスコードマスタの入れ替えを実行できる
- 問題が発生した場合の切り分けが容易

## 📄 関連ドキュメント

- [影響分析レポート](./replit-redeploy-impact-analysis.md)
- [デプロイチェックリスト](./replit-redeploy-checklist.md)
- [スキーマ差分分析結果](./schema-diff-analysis-final.md)
- [サービスコードマスタ移行計画](./migration-plan-service-codes-final.md)

