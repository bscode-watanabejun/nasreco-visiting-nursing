# 加算マスタとサービスコード対応関係ドキュメント

**作成日**: 2025-01-XX  
**目的**: 加算マスタ（bonusMaster）とサービスコード（nursingServiceCodes）の対応関係を整理し、レセプトCSV出力時の自動選択の可能性と課題を明確化する。

---

## 1. 概要

### 1.1 現在の実装状況

- **加算マスタ**: 54件（医療保険28件、介護保険26件）
- **サービスコード**: 208件（加算関連154件）
- **問題点**: 加算マスタにサービスコードフィールドがなく、自動選択が困難

### 1.2 課題

1. 加算マスタ（`bonusMaster`）にはサービスコード（9桁）が保存されていない
2. サービスコードは細かく分かれており、条件によって異なるコードが必要
3. 加算コード（`bonusCode`）だけではサービスコードを特定できない

---

## 2. 加算マスタ一覧

### 2.1 医療保険（28件）

| 加算コード | 加算名 | 点数タイプ | 固定点数 | 条件パターン | ステータス |
|-----------|--------|-----------|---------|------------|-----------|
| `24h_response_system_basic` | 24時間対応体制加算 | fixed | 6520 | - | ✅ 有効 |
| `24h_response_system_enhanced` | 24時間対応体制加算（看護業務負担軽減） | fixed | 6800 | - | ✅ 有効 |
| `medical_emergency_visit` | 緊急訪問看護加算 | conditional | - | monthly_14day_threshold | ✅ 有効 |
| `medical_long_visit` | 長時間訪問看護加算 | conditional | - | duration_based | ✅ 有効 |
| `medical_multiple_visit_2times_1-2` | 難病等複数回訪問加算（2回/日・同一建物1-2人） | conditional | - | building_occupancy | ✅ 有効 |
| `medical_multiple_visit_3times` | 難病等複数回訪問加算（3回以上/日） | conditional | - | building_occupancy | ✅ 有効 |
| `medical_infant_basic` | 乳幼児加算（基本） | conditional | - | age_based | ✅ 有効 |
| `medical_infant_special` | 乳幼児加算（基準告示第2の4該当） | conditional | - | age_based | ✅ 有効 |
| `medical_night_early_morning` | 夜間・早朝訪問看護加算 | conditional | - | time_based | ✅ 有効 |
| `terminal_care_1` | 訪問看護ターミナルケア療養費1 | fixed | 25000 | - | ✅ 有効 |
| `terminal_care_2` | 訪問看護ターミナルケア療養費2 | fixed | 10000 | - | ✅ 有効 |
| `special_management_1` | 特別管理加算（I） | fixed | 5000 | - | ✅ 有効 |
| `special_management_2` | 特別管理加算（II） | fixed | 2500 | - | ✅ 有効 |
| `specialist_management` | 専門管理加算 | fixed | 2500 | - | ✅ 有効 |
| `discharge_support_guidance_basic` | 退院時支援指導加算 | fixed | 6000 | - | ✅ 有効 |
| `discharge_support_guidance_long` | 退院時支援指導加算（長時間） | conditional | - | duration_based | ✅ 有効 |
| `discharge_special_management_guidance` | 特別管理指導加算 | fixed | 2000 | - | ✅ 有効 |
| `medical_discharge_joint_guidance` | 退院時共同指導加算（医療保険） | fixed | 8000 | - | ✅ 有効 |
| `home_coordination_guidance` | 在宅連携指導加算 | fixed | 3000 | - | ❌ 無効 |
| `home_patient_emergency_conference` | 在宅患者緊急時等カンファレンス | fixed | 2000 | - | ❌ 無効 |
| `nursing_care_staff_collaboration` | 看護・介護職員連携強化加算 | fixed | 2500 | - | ❌ 無効 |
| `psychiatric_severe_patient_support_5800` | 精神科重症患者支援管理連携加算（月2回以上） | fixed | 5800 | - | ❌ 無効 |
| `psychiatric_severe_patient_support_8400` | 精神科重症患者支援管理連携加算（週2回以上） | fixed | 8400 | - | ❌ 無効 |
| `special_area_visit` | 特別地域訪問看護加算 | fixed | 2500 | - | ❌ 無効 |
| `medical_dx_information_utilization` | 訪問看護医療DX情報活用加算 | fixed | 50 | - | ❌ 無効 |
| `base_up_evaluation_1` | 訪問看護ベースアップ評価料（I） | fixed | 780 | - | ❌ 無効 |
| `base_up_evaluation_2` | 訪問看護ベースアップ評価料（II） | conditional | - | custom | ❌ 無効 |

### 2.2 介護保険（26件）

| 加算コード | 加算名 | 点数タイプ | 固定点数 | 条件パターン | ステータス |
|-----------|--------|-----------|---------|------------|-----------|
| `care_emergency_system` | 緊急時訪問看護加算（I） | fixed | 574 | - | ✅ 有効 |
| `care_emergency_system_2` | 緊急時訪問看護加算（II） | fixed | 574 | - | ✅ 有効 |
| `care_emergency_visit` | 緊急訪問加算 | fixed | 50 | - | ✅ 有効 |
| `care_night_early_morning` | 夜間・早朝加算 | fixed | 50 | - | ✅ 有効 |
| `care_late_night` | 深夜加算 | fixed | 50 | - | ✅ 有効 |
| （その他21件） | ... | ... | ... | ... | ... |

---

## 3. サービスコード対応表

### 3.1 緊急訪問看護加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `medical_emergency_visit` | `510002470` | 緊急訪問看護加算（月14日目まで） | 2650 | 月14日目まで |
| `medical_emergency_visit` | `510004570` | 緊急訪問看護加算（月15日目以降） | 2000 | 月15日目以降 |

**加算マスタの点数設定**: 
- `pointsConfig`: `{"up_to_14":265,"after_14":200}`
- **注意**: 加算マスタの点数は「10円単位」で保存されている（265 = 2650円、200 = 2000円）
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ✅ **可能**
- 条件: 訪問日が月の何日目かを判定
- 判定方法: 訪問日の日付から判定（1-14日目 → `510002470`, 15日目以降 → `510004570`）

#### 精神科

| サービスコード | サービス名 | 点数 | 選択条件 |
|--------------|-----------|------|---------|
| `530002770` | 精神科緊急訪問看護加算（月14日目まで） | 2650 | 精神科訪問 + 月14日目まで |
| `530005070` | 精神科緊急訪問看護加算（月15日目以降） | 2000 | 精神科訪問 + 月15日目以降 |

**自動選択の可能性**: ✅ **可能**
- 条件: 訪問の種類（通常/精神科）と訪問日の日付を判定

### 3.2 長時間訪問看護加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `medical_long_visit` | `510002570` | 長時間訪問看護加算（訪問看護基本療養費） | 5200 | 通常 |
| `medical_long_visit` | `510004470` | 長時間訪問看護加算（別に厚生労働大臣が定める者） | 5200 | 別に厚生労働大臣が定める者 |

**加算マスタの点数設定**: 
- `pointsConfig`: `{"duration_90":520}`
- **注意**: 加算マスタの点数は「10円単位」で保存されている（520 = 5200円）
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ⚠️ **部分的に可能**
- 条件1: 訪問時間が90分超 → ✅ 判定可能（`actualStartTime`と`actualEndTime`から計算）
- 条件2: 「別に厚生労働大臣が定める者」の判定 → ❌ 判定不可（患者情報または訪問記録にフラグが必要）
- **課題**: 両方のサービスコードが同じ点数（5200点）のため、点数だけでは判定できない

#### 精神科

| サービスコード | サービス名 | 点数 | 選択条件 |
|--------------|-----------|------|---------|
| `530002870` | 長時間精神科訪問看護加算（精神科訪問看護基本療養費） | 5200 | 精神科訪問 |
| `530004970` | 長時間精神科訪問看護加算（別に厚生労働大臣が定める者） | 5200 | 精神科訪問 + 別に厚生労働大臣が定める者 |

### 3.3 複数回訪問加算

#### 医療保険（難病等複数回訪問加算）

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `medical_multiple_visit_2times_1-2` | `510001970` | 難病等複数回訪問加算（1日に2回の場合）（同一建物内1人又は2人） | 4500 | 2回/日 + 1-2人 |
| `medical_multiple_visit_2times_1-2` | `510002070` | 難病等複数回訪問加算（1日に2回の場合）（同一建物内3人以上） | 4000 | 2回/日 + 3人以上 |
| `medical_multiple_visit_3times` | `510002170` | 難病等複数回訪問加算（1日に3回以上の場合）（同一建物内1人又は2人） | 8000 | 3回以上/日 + 1-2人 |
| `medical_multiple_visit_3times` | `510002270` | 難病等複数回訪問加算（1日に3回以上の場合）（同一建物内3人以上） | 7200 | 3回以上/日 + 3人以上 |

**加算マスタの点数設定**: 
- `medical_multiple_visit_2times_1-2`: `{"occupancy_1_2":450,"occupancy_3_plus":400}`
- `medical_multiple_visit_3times`: `{"occupancy_1_2":800,"occupancy_3_plus":720}`
- **注意**: 加算マスタの点数は「10円単位」で保存されている
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ⚠️ **部分的に可能**
- 条件1: 同日訪問回数（2回/日 or 3回以上/日）→ ✅ 訪問記録から判定可能（`isSecondVisit`フラグまたは同日訪問記録の集計）
- 条件2: 同一建物内人数（1-2人 or 3人以上）→ ❌ **患者情報または訪問記録に必要**（現状では不明）
- **課題**: 同一建物内人数の情報が訪問記録に保存されていない

### 3.4 時間帯別加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `medical_night_early_morning` | `510003970` | 夜間・早朝訪問看護加算（訪問看護基本療養費） | 2100 | 夜間（18:00-22:00）または早朝（6:00-8:00） |
| `medical_late_night` | `510004070` | 深夜訪問看護加算（訪問看護基本療養費） | 4200 | 深夜（22:00-6:00） |

**加算マスタの点数設定**: 
- `medical_night_early_morning`: `{"night":210,"early_morning":210,"late_night":0,"daytime":0}`
- `medical_late_night`: `{"late_night":420,"night":0,"early_morning":0,"daytime":0}`
- **注意**: 加算マスタの点数は「10円単位」で保存されている（210 = 2100円、420 = 4200円）
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ✅ **可能**
- 条件: 訪問開始時刻から判定可能
- 判定方法: `actualStartTime`から時刻を抽出して判定
  - 夜間（18:00-22:00）または早朝（6:00-8:00） → `510003970`
  - 深夜（22:00-6:00） → `510004070`

#### 精神科

| サービスコード | サービス名 | 点数 | 選択条件 |
|--------------|-----------|------|---------|
| `530004370` | 夜間・早朝訪問看護加算（精神科訪問看護基本療養費） | 2100 | 精神科訪問 + 夜間/早朝 |
| `530004470` | 深夜訪問看護加算（精神科訪問看護基本療養費） | 4200 | 精神科訪問 + 深夜 |

### 3.5 乳幼児加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `medical_infant_basic` | `510002670` | 乳幼児加算（訪問看護基本療養費） | 1300 | 0-6歳 |
| `medical_infant_special` | `510004670` | 乳幼児加算（別に厚生労働大臣が定める者） | 1800 | 0-6歳 + 基準告示第2の4該当 |

**加算マスタの点数設定**: 
- `medical_infant_basic`: `{"age_0_6":130,"age_6_999":0}`
- `medical_infant_special`: `{"age_0_6":180,"age_6_999":0}`
- **注意**: 加算マスタの点数は「10円単位」で保存されている（130 = 1300円、180 = 1800円）
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ⚠️ **部分的に可能**
- 条件1: 患者年齢（0-6歳）→ ✅ 患者情報から判定可能（`dateOfBirth`から計算）
- 条件2: 「別に厚生労働大臣が定める者」（基準告示第2の4該当）の判定 → ❌ **患者情報にフラグが必要**（現状では不明）
- **課題**: 基準告示第2の4該当の判定基準が不明確

### 3.6 退院支援加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `discharge_support_guidance_basic` | `550001170` | 退院支援指導加算（訪問看護管理療養費） | 6000 | 退院日 + 通常 |
| `discharge_support_guidance_long` | `550001270` | 退院支援指導加算（別に厚生労働大臣が定める長時間の訪問を要する者） | 8400 | 退院日 + 90分超 |

**加算マスタの点数設定**: 
- `discharge_support_guidance_basic`: 固定点数 6000
- `discharge_support_guidance_long`: `{"conditions":[{"points":8400,"operator":"greater_than","description":"90分超の訪問","durationMinutes":90}],"defaultPoints":0}`
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ✅ **可能**
- 条件1: 退院日判定 → ✅ `isDischargeDate`フラグから判定可能
- 条件2: 長時間判定 → ✅ 訪問時間（90分超）から判定可能（`actualStartTime`と`actualEndTime`から計算）
- **注意**: `discharge_support_guidance_long`は「別に厚生労働大臣が定める長時間の訪問を要する者」という条件があるが、点数設定では90分超で判定している

### 3.7 ターミナルケア加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `terminal_care_1` | `580000110` | 訪問看護ターミナルケア療養費１ | 25000 | ターミナルケア1 |
| `terminal_care_2` | `580000210` | 訪問看護ターミナルケア療養費２ | 10000 | ターミナルケア2 |

**加算マスタの点数設定**: 
- `terminal_care_1`: 固定点数 25000
- `terminal_care_2`: 固定点数 10000
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ⚠️ **部分的に可能**
- 条件: ターミナルケア1と2の判定基準が必要
- **課題**: ターミナルケア1と2の判定基準が不明確
- **現状**: `isTerminalCare`フラグはあるが、1と2の区別ができない

### 3.8 24時間対応体制加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `24h_response_system_basic` | `550000670` | 24時間対応体制加算（イ以外の場合）（訪問看護管理療養費） | 6520 | 24時間対応体制（基本） |
| `24h_response_system_enhanced` | `550002170` | 24時間対応体制加算（看護業務の負担軽減の取組を行っている場合） | 6800 | 24時間対応体制（負担軽減） |

**加算マスタの点数設定**: 
- `24h_response_system_basic`: 固定点数 6520
- `24h_response_system_enhanced`: 固定点数 6800
- サービスコードの点数と一致: ✅

**自動選択の可能性**: ✅ **可能**
- 条件: 施設の体制フラグから判定可能
- 判定方法: `has24hSupportSystem` / `has24hSupportSystemEnhanced`
- **注意**: 両方が有効な場合は、高点数の`24h_response_system_enhanced`を優先（併算定不可）

### 3.9 特別管理加算・専門管理加算

#### 医療保険

| 加算コード | サービスコード | サービス名 | 点数 | 選択条件 |
|-----------|--------------|-----------|------|---------|
| `special_management_1` | `550000870` | 特別管理加算（特別な管理を必要とする利用者のうち重症度等の高いものとして別に厚生労働大臣が定める状態等にある利用者） | 5000 | 特別管理（I） |
| `special_management_2` | `550000770` | 特別管理加算（訪問看護管理療養費） | 2500 | 特別管理（II） |
| `specialist_management` | `550001870` | 専門管理加算（緩和ケア、褥瘡ケア又は人工肛門ケア及び人工膀胱ケアに係る専門の研修を受けた看護師が計画的な管理を行った場合） | 2500 | 専門管理（緩和ケア等） |
| `specialist_management` | `550001970` | 専門管理加算（特定行為研修を修了した看護師が計画的な管理を行った場合） | 2500 | 専門管理（特定行為研修） |

**自動選択の可能性**: ⚠️ **部分的に可能**
- 条件: 患者の特別管理状態、看護師の資格、管理内容の判定が必要

---

## 4. 自動選択の可能性と課題

### 4.1 自動選択が可能な加算

| 加算カテゴリ | 加算コード | 自動選択可能性 | 必要な情報 |
|------------|-----------|--------------|-----------|
| 緊急訪問看護加算 | `medical_emergency_visit` | ✅ 可能 | 訪問日の日付（月の何日目か） |
| 時間帯別加算 | `medical_night_early_morning` | ✅ 可能 | 訪問開始時刻 |
| 退院支援加算 | `discharge_support_guidance_*` | ✅ 可能 | 退院日フラグ、訪問時間 |
| 24時間対応体制加算 | `24h_response_system_*` | ✅ 可能 | 施設の体制フラグ |

### 4.2 部分的に自動選択可能な加算

| 加算カテゴリ | 加算コード | 自動選択可能性 | 必要な情報 | 課題 |
|------------|-----------|--------------|-----------|------|
| 長時間訪問看護加算 | `medical_long_visit` | ⚠️ 部分的 | 「別に厚生労働大臣が定める者」の判定 | 患者情報にフラグが必要 |
| 複数回訪問加算 | `medical_multiple_visit_*` | ⚠️ 部分的 | 同日訪問回数、同一建物内人数 | 同一建物内人数の情報が必要 |
| 乳幼児加算 | `medical_infant_*` | ⚠️ 部分的 | 患者年齢、「別に厚生労働大臣が定める者」の判定 | 基準告示第2の4該当の判定が必要 |
| ターミナルケア加算 | `terminal_care_*` | ⚠️ 部分的 | ターミナルケア1と2の判定基準 | 判定基準の明確化が必要 |
| 特別管理加算 | `special_management_*` | ⚠️ 部分的 | 患者の特別管理状態、看護師の資格 | 複雑な判定ロジックが必要 |

### 4.3 自動選択が困難な加算

| 加算カテゴリ | 加算コード | 理由 |
|------------|-----------|------|
| 複数名訪問看護加算 | - | 訪問記録に複数名の情報が必要 |
| 精神科関連加算 | - | 訪問の種類（通常/精神科）の判定が必要 |
| 医療観察関連加算 | - | 医療観察の判定が必要 |

---

## 5. 推奨される実装方針

### 5.1 段階的実装アプローチ

#### Phase 1: 完全自動選択可能な加算（優先度: 高）

以下の加算は、既存の情報から自動選択可能：

1. **緊急訪問看護加算**
   - 訪問日の日付から月14日目まで/以降を判定
   - サービスコード: `510002470` or `510004570`

2. **時間帯別加算**
   - 訪問開始時刻から判定
   - サービスコード: `510003970` (夜間・早朝) or `510004070` (深夜)

3. **24時間対応体制加算**
   - 施設の体制フラグから判定
   - サービスコード: `550000670` (基本) or `550002170` (負担軽減)

4. **退院支援加算**
   - 退院日フラグと訪問時間から判定
   - サービスコード: `550001170` (基本) or `550001270` (長時間)

#### Phase 2: 部分的自動選択可能な加算（優先度: 中）

以下の加算は、追加情報があれば自動選択可能：

1. **長時間訪問看護加算**
   - 課題: 「別に厚生労働大臣が定める者」の判定
   - 対応: 患者情報にフラグを追加

2. **複数回訪問加算**
   - 課題: 同一建物内人数の情報
   - 対応: 訪問記録に建物内人数フィールドを追加

3. **乳幼児加算**
   - 課題: 基準告示第2の4該当の判定
   - 対応: 患者情報にフラグを追加

#### Phase 3: 手動選択が必要な加算（優先度: 低）

以下の加算は、現状では手動選択が必要：

1. **ターミナルケア加算**
   - 判定基準の明確化が必要

2. **特別管理加算・専門管理加算**
   - 複雑な判定ロジックが必要

3. **複数名訪問看護加算**
   - 訪問記録に複数名の情報が必要

### 5.2 実装方法

#### 方法1: 加算マスタにサービスコードマッピングを追加

```typescript
// bonusMasterテーブルに追加
serviceCodeMapping: json("service_code_mapping"), // JSON形式でマッピングを保存
/*
例: medical_emergency_visit の場合
{
  "pattern": "monthly_14day_threshold",
  "mappings": [
    {
      "condition": { "dayRange": [1, 14] },
      "serviceCode": "510002470"
    },
    {
      "condition": { "dayRange": [15, 31] },
      "serviceCode": "510004570"
    }
  ]
}
*/
```

#### 方法2: 自動選択ロジックの実装

加算計算時に、条件に応じて適切なサービスコードを自動選択する関数を実装：

```typescript
async function selectServiceCodeForBonus(
  bonusCode: string,
  bonusMaster: BonusMaster,
  context: BonusCalculationContext
): Promise<string | null> {
  // 加算コードに応じたサービスコード選択ロジック
  // 選択できない場合は null を返す
}
```

#### 方法3: 手動選択の併用

- 自動選択できない場合は、ユーザーに手動選択を促す
- 自動選択されたサービスコードは、ユーザーが確認・修正可能

---

## 6. 加算マスタの点数設定の役割

### 6.1 設計方針

**方針**: 加算マスタの点数は「参考値」として保持し、最終的にはサービスコードの点数を使用する

### 6.2 点数設定の使用箇所

| 使用箇所 | 使用する点数 | 理由 |
|---------|------------|------|
| 加算計算エンジン | 加算マスタの点数 | 加算の適用可否を判定するため |
| 画面表示（加算内訳） | 加算マスタの点数 | 参考値として表示 |
| レセプトCSV出力 | サービスコードの点数 | レセプト精算の正式な点数 |
| 整合性チェック | 両方の点数を比較 | データの整合性を確認 |

### 6.3 実装上の注意点

1. **加算計算時**: 加算マスタの点数を使用して加算の適用可否を判定
2. **サービスコード選択時**: 加算マスタの点数とサービスコードの点数が一致していることを確認（整合性チェック）
3. **CSV出力時**: サービスコードの点数を優先的に使用
4. **整合性チェック**: 加算マスタの点数とサービスコードの点数が一致しない場合は警告を表示

---

## 7. サービスコード選択できない場合の対応

### 7.1 問題の整理

加算マスタから対応するサービスコードを自動選択できない場合があります：

1. **完全自動選択可能な加算**: 緊急訪問、時間帯別、退院支援、24時間対応体制
2. **部分的に自動選択可能な加算**: 長時間訪問、複数回訪問、乳幼児（追加情報が必要）
3. **自動選択が困難な加算**: ターミナルケア、特別管理加算、複数名訪問

### 7.2 対応方針

#### 7.2.1 自動選択できない場合の処理

1. **加算計算時**:
   - 加算は計算される（点数は加算マスタの点数を使用）
   - `bonusCalculationHistory.serviceCodeId`は`null`のまま
   - 警告ログを出力（自動選択できなかった加算を記録）

2. **レセプトCSV出力時**:
   - `serviceCodeId`が`null`の加算はCSV出力に含めない
   - 警告メッセージを表示（「以下の加算はサービスコードが未選択のため出力されませんでした」）

3. **管理画面での対応**:
   - **配置場所**: 月次レセプト詳細画面（`MonthlyReceiptDetail.tsx`）の「加算内訳」セクションの下
   - **UI構成**:
     - 警告バナー（黄色背景）で「サービスコード未選択の加算」セクションを表示
     - 未選択の加算をカード形式で一覧表示
     - 各カードに訪問日、加算名、点数を表示
     - サービスコード選択ドロップダウン（Comboboxコンポーネントを使用）
     - 選択後に「保存」ボタンで`bonusCalculationHistory.serviceCodeId`を更新
   - **表示条件**: `serviceCodeId`が`null`の加算のみ表示

#### 7.2.2 実装上の注意点

- **加算計算**: サービスコードが選択できなくても加算は計算される（点数は加算マスタの点数を使用）
- **CSV出力**: `serviceCodeId`が`null`の加算は出力しない（警告を表示）
- **手動選択**: 管理画面で未選択の加算を一覧表示し、手動選択を促す
- **整合性チェック**: 加算マスタの点数とサービスコードの点数が一致しない場合は警告を表示

### 7.3 段階的実装アプローチ

#### Phase 1: 完全自動選択可能な加算のみ実装
- 緊急訪問、時間帯別、退院支援、24時間対応体制
- これらは自動選択可能なため、`serviceCodeId`が`null`になることはない

#### Phase 2: 部分的自動選択可能な加算の実装
- 長時間訪問、複数回訪問、乳幼児
- 追加情報があれば自動選択可能
- 追加情報がない場合は`serviceCodeId`が`null`になり、手動選択を促す

#### Phase 3: 手動選択が必要な加算の対応
- ターミナルケア、特別管理加算、複数名訪問
- 管理画面で手動選択UIを提供

---

## 8. 次のステップ

1. ✅ 加算マスタとサービスコードの対応関係を整理（本ドキュメント）
2. ✅ 加算マスタの点数設定の役割を明確化（参考値として保持、最終的にはサービスコードの点数を使用）
3. ✅ サービスコード選択できない場合の対応方針を明確化
4. ⏳ `bonusCalculationHistory`に`serviceCodeId`フィールドを追加
5. ⏳ 加算マスタにサービスコードマッピングを追加するか検討
6. ⏳ 自動選択ロジックの実装（Phase 1: 完全自動選択可能な加算）
7. ⏳ 必要な追加情報（建物内人数、特別管理フラグ等）の検討
8. ⏳ CSV出力時に加算を別のKAレコードとして出力する実装（`serviceCodeId`が`null`の場合はスキップ）
9. ⏳ 未選択の加算サービスコードを手動選択するUIの実装（月次レセプト詳細画面に追加）
   - `MonthlyReceiptDetail.tsx`に「サービスコード未選択の加算」セクションを追加
   - 未選択の加算をカード形式で一覧表示
   - サービスコード選択ドロップダウン（Comboboxコンポーネント）
   - 保存APIエンドポイントの実装（`/api/bonus-calculation-history/:id/service-code`）
10. ⏳ 加算マスタの点数とサービスコードの点数の整合性チェック機能の実装

---

## 9. 参考資料

- [加算実装ガイド](./加算実装ガイド.md)
- [訪問看護療養費マスター仕様書](../recept/visiting%20nursing_care_expenses_master/STRUCTURE_ANALYSIS.md)
- [レセプトCSV仕様書](../recept/nursing_csv_spec.md)

