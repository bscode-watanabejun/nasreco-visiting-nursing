# Phase 2-1 テスト手順書

Phase 2-1で実装した施設体制フラグ系の加算（4項目）の動作確認手順。

---

## 📋 テスト対象の加算（4項目）

| # | 加算名 | 加算コード | 保険種別 | 点数/単位 | 条件 |
|---|--------|-----------|---------|----------|------|
| 1 | 24時間対応体制加算 | `24h_response_system_basic` | 医療保険 | 6,520点 | `has_24h_support_system = true` |
| 2 | 24時間対応体制加算（看護業務負担軽減） | `24h_response_system_enhanced` | 医療保険 | 6,800点 | `has_24h_support_system_enhanced = true` + 負担軽減の取り組み2項目以上 |
| 3 | 緊急時訪問看護加算（I） | `care_emergency_system` | 介護保険 | 574単位 | `has_emergency_support_system = true` |
| 4 | 緊急時訪問看護加算（II） | `care_emergency_system_2` | 介護保険 | 574単位 | `has_emergency_support_system_enhanced = true` |

---

## 🧪 テスト環境

### テスト施設
- **施設名**: テストクリニック
- **施設ID**: `fac-osaka-branch`
- **ログインアカウント**: `testuser1` / `password123`
  - ※他にも使用可能: `manager`, `nurse2`, `nurse3`, `nurse_tanaka`

### 施設体制フラグ設定（既に設定済み）
```
has_24h_support_system = true
has_24h_support_system_enhanced = true
has_emergency_support_system = true
has_emergency_support_system_enhanced = true
burden_reduction_measures = [
  "夜間対応翌日の勤務間隔確保",
  "夜間対応の連続回数制限",
  "ICT・AI・IoT等の活用"
]
```

### テスト患者
**Phase1で作成済みの患者を使用:**

| 患者ID | 患者番号 | 氏名 | 年齢 | 保険種別 | 用途 |
|--------|---------|------|------|---------|------|
| `test-clinic-patient-002` | CLINIC-002 | テスト花子 | 45歳 | 医療保険 | 24時間対応体制加算テスト |
| `test-clinic-patient-003` | CLINIC-003 | テスト次郎 | 70歳 | 介護保険 | 緊急時訪問看護加算テスト |

---

## ✅ テストケース

### テスト1: 24時間対応体制加算（基本）
**目的:** 医療保険患者の訪問記録に24時間対応体制加算が自動適用されることを確認

**前提条件:**
- 施設: テストクリニック
- 患者: テスト花子（医療保険）
- 施設設定: `has_24h_support_system = true`

**手順:**
1. 訪問記録画面で「新規記録」をクリック
2. 以下の情報を入力:
   - 患者: テスト花子
   - 訪問日: 2025-11-15
   - 開始時刻: 10:00
   - 終了時刻: 11:00
   - 観察事項: 「Phase2-1テスト1: 24時間対応体制加算（基本）」
3. 「保存」をクリック

**期待結果:**
- ✅ 合計点数: **7,020点**（基本500点 + 24時間対応体制加算6,520点）
- ✅ 適用加算に「24時間対応体制加算: 6,520点」が表示される

---

### テスト2: 24時間対応体制加算（看護業務負担軽減）
**目的:** 看護業務負担軽減の取り組みがある場合、上位の加算が適用されることを確認

**前提条件:**
- 施設: テストクリニック
- 患者: テスト花子（医療保険）
- 施設設定: `has_24h_support_system_enhanced = true` + 負担軽減3項目

**手順:**
1. 訪問記録画面で「新規記録」をクリック
2. 以下の情報を入力:
   - 患者: テスト花子
   - 訪問日: 2025-11-16
   - 開始時刻: 14:00
   - 終了時刻: 15:00
   - 観察事項: 「Phase2-1テスト2: 24時間対応体制加算（看護業務負担軽減）」
3. 「保存」をクリック

**期待結果:**
- ✅ 合計点数: **7,300点**（基本500点 + 24時間対応体制加算（看護業務負担軽減）6,800点）
- ✅ 適用加算に「24時間対応体制加算（看護業務負担軽減）: 6,800点」が表示される

**注意:**
- テスト1と2で両方の24時間対応体制加算が表示される可能性があります
- その場合、点数の高い方（6,800点）が優先適用されているか確認してください

---

### テスト3: 緊急時訪問看護加算（I）（介護保険）
**目的:** 介護保険患者の訪問記録に緊急時訪問看護加算（I）が自動適用されることを確認

**前提条件:**
- 施設: テストクリニック
- 患者: テスト次郎（介護保険）
- 施設設定: `has_emergency_support_system = true`

**手順:**
1. 訪問記録画面で「新規記録」をクリック
2. 以下の情報を入力:
   - 患者: テスト次郎
   - 訪問日: 2025-11-17
   - 開始時刻: 10:00
   - 終了時刻: 11:00
   - 観察事項: 「Phase2-1テスト3: 緊急時訪問看護加算（I）」
3. 「保存」をクリック

**期待結果:**
- ✅ 合計単位: **1,074単位**（基本500単位 + 緊急時訪問看護加算（I）574単位）
- ✅ 適用加算に「緊急時訪問看護加算（I）: 574単位」が表示される

---

### テスト4: 緊急時訪問看護加算（II）（介護保険）
**目的:** 緊急時訪問看護加算（II）が自動適用されることを確認

**前提条件:**
- 施設: テストクリニック
- 患者: テスト次郎（介護保険）
- 施設設定: `has_emergency_support_system_enhanced = true`

**手順:**
1. 訪問記録画面で「新規記録」をクリック
2. 以下の情報を入力:
   - 患者: テスト次郎
   - 訪問日: 2025-11-18
   - 開始時刻: 14:00
   - 終了時刻: 15:00
   - 観察事項: 「Phase2-1テスト4: 緊急時訪問看護加算（II）」
3. 「保存」をクリック

**期待結果:**
- ✅ 合計単位: **1,074単位**（基本500単位 + 緊急時訪問看護加算（II）574単位）
- ✅ 適用加算に「緊急時訪問看護加算（II）: 574単位」が表示される

**注意:**
- テスト3と4で両方の緊急時訪問看護加算が表示される可能性があります
- その場合、両方が適用されているか確認してください（仕様上、I と II は併算定可能な可能性）

---

### テスト5: Phase1加算との組み合わせ
**目的:** Phase2-1の加算とPhase1の加算が併算定できることを確認

**前提条件:**
- 施設: テストクリニック
- 患者: テスト花子（医療保険）
- 施設設定: Phase2-1フラグすべてON

**手順:**
1. 訪問記録画面で「新規記録」をクリック
2. 以下の情報を入力:
   - 患者: テスト花子
   - 訪問日: 2025-11-19
   - 開始時刻: 20:00（夜間）
   - 終了時刻: 21:00
   - 緊急訪問理由: 「Phase2-1テスト5: 夜間緊急訪問」
   - 観察事項: 「Phase2-1テスト5: Phase1加算との組み合わせ」
3. 「保存」をクリック

**期待結果:**
- ✅ 合計点数: **7,795点**
  - 基本: 500点
  - Phase1 緊急訪問看護加算: 265点
  - Phase1 夜間・早朝訪問看護加算: 210点
  - Phase2-1 24時間対応体制加算（看護業務負担軽減）: 6,800点
  - または **7,515点**（24時間対応体制加算（基本）6,520点の場合）
- ✅ Phase1とPhase2-1の加算が両方表示される

---

## 📊 テスト結果記録表

| テスト# | テストケース | 実施日 | 結果 | 合計点数/単位 | 備考 |
|---------|-------------|--------|------|--------------|------|
| 1 | UI表示/非表示の動作確認 | 2025-10-22 | ✅ | - | 条件付き表示が正常に動作 |
| 2 | 設定の保存確認 | 2025-10-22 | ✅ | - | Phase2-1フィールドがDBに保存される |
| 3 | 再読み込み時の設定保持 | 2025-10-22 | ✅ | - | 保存した設定が正しく表示される |
| 4 | 併算定制御の確認 | 2025-10-22 | ✅ | 6,800点のみ | 高点数の加算が優先適用される |
| 5 | 訪問記録での自動適用（医療） | 2025-10-22 | ✅ | 6,800点 | テスト花子で24時間対応体制加算が適用 |
| 5 | 訪問記録での自動適用（介護） | 2025-10-22 | ✅ | 574単位 | テスト次郎で緊急時訪問看護加算が適用 |

---

## 🔍 トラブルシューティング

### 加算が適用されない場合

1. **施設体制フラグを確認**
   ```sql
   SELECT
     has_24h_support_system,
     has_24h_support_system_enhanced,
     has_emergency_support_system,
     has_emergency_support_system_enhanced,
     burden_reduction_measures
   FROM facilities
   WHERE id = 'fac-osaka-branch';
   ```

2. **加算マスタの条件を確認**
   ```sql
   SELECT
     bonus_code,
     bonus_name,
     is_active,
     predefined_conditions
   FROM bonus_master
   WHERE bonus_code IN (
     '24h_response_system_basic',
     '24h_response_system_enhanced',
     'care_emergency_system',
     'care_emergency_system_2'
   );
   ```

3. **患者の保険種別を確認**
   ```sql
   SELECT id, last_name, first_name, insurance_type
   FROM patients
   WHERE id IN ('test-clinic-patient-002', 'test-clinic-patient-003');
   ```

---

## 📝 テスト完了後の確認事項

- [x] すべてのテストケースが成功
- [x] Phase1の加算が引き続き正常に動作
- [x] 加算計算履歴が正しく記録されている
- [x] 型チェック・ビルドテストが成功

---

## ✅ Phase2-1 実装完了サマリー

**完了日**: 2025年10月22日

### 実装内容
1. **バックエンド**
   - スキーマ拡張: `facilities`テーブルに5フィールド追加
   - 条件評価関数: 4項目の評価ロジック実装
   - 併算定制御: `cannotCombineWith`設定 + 点数降順ソート
   - 保険種別対応: 医療保険/介護保険の適切な加算適用

2. **フロントエンド**
   - 施設管理UI: チェックボックス形式で設定可能
   - 条件付き表示: 負担軽減の取り組み（2項目以上必須）
   - バリデーション: 不足時の警告表示
   - 保存/読み込み: Phase2-1フィールドの完全対応

3. **テスト結果**
   - 全6テストケース成功
   - 併算定制御の正常動作確認
   - 保険種別ごとの適切な加算適用確認

### 実装ファイル
- `/shared/schema.ts` - スキーマ定義
- `/server/bonus-engine.ts` - 条件評価ロジック
- `/server/routes.ts` - API統合
- `/client/src/lib/api.ts` - API型定義
- `/client/src/components/FacilityManagement.tsx` - UI実装

---

**作成日**: 2025年10月22日
**完了日**: 2025年10月22日
**対象**: Phase 2-1 - 施設体制フラグ系加算（4項目）
**ステータス**: ✅ 完了
