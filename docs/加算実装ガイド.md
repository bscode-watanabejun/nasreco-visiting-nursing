# åŠ ç®—å®Ÿè£…ã‚¬ã‚¤ãƒ‰

**æœ€çµ‚æ›´æ–°**: 2025-11-02
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0

---

## ğŸ“‹ ç›®æ¬¡

1. [å®Ÿè£…æ¸ˆã¿åŠ ç®—ã®æ¦‚è¦](#å®Ÿè£…æ¸ˆã¿åŠ ç®—ã®æ¦‚è¦)
2. [å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†](#åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†)
4. [å°‚é–€ç®¡ç†åŠ ç®—ã®å®Ÿè£…](#å°‚é–€ç®¡ç†åŠ ç®—ã®å®Ÿè£…)
5. [ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã®å®Ÿè£…](#ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã®å®Ÿè£…)
6. [æ–°è¦åŠ ç®—ã®è¿½åŠ æ–¹æ³•](#æ–°è¦åŠ ç®—ã®è¿½åŠ æ–¹æ³•)
7. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## å®Ÿè£…æ¸ˆã¿åŠ ç®—ã®æ¦‚è¦

### å®Ÿè£…çŠ¶æ³ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒªãƒ¼ | å®Ÿè£…æ¸ˆã¿ | ãƒ†ã‚¹ãƒˆæ¸ˆã¿ | å‚™è€ƒ |
|---------|---------|-----------|------|
| **å°‚é–€ç®¡ç†åŠ ç®—** | âœ… | âœ… | åŒ»ç™‚ãƒ»ä»‹è­·ä¸¡å¯¾å¿œ |
| **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—** | âœ… | âš ï¸ ä¸€éƒ¨ | terminal_care_2ã¯éƒ¨åˆ†å®Ÿè£… |
| **é€€é™¢æ”¯æ´ç³»åŠ ç®—** | âœ… | âœ… | åŸºæœ¬ãƒ»é•·æ™‚é–“å¯¾å¿œ |
| **24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—** | âœ… | âœ… | åŸºæœ¬ãƒ»å¼·åŒ–å¯¾å¿œ |
| **ç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—** | âœ… | âœ… | Iãƒ»IIå¯¾å¿œ |
| **æ™‚é–“å¸¯åˆ¥åŠ ç®—** | âœ… | âœ… | æ—©æœãƒ»å¤œé–“ãƒ»æ·±å¤œ |
| **åˆå›åŠ ç®—** | âœ… | âœ… | Iãƒ»IIå¯¾å¿œ |

### å®Ÿè£…æ¸ˆã¿åŠ ç®—ä¸€è¦§

#### åŒ»ç™‚ä¿é™ºï¼ˆ6é …ç›®å®Ÿè£…æ¸ˆã¿ï¼‰

| åŠ ç®—å | ã‚³ãƒ¼ãƒ‰ | ç‚¹æ•° | å®Ÿè£…æ–¹æ³• | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|--------|------|---------|-----------|
| ç·Šæ€¥è¨ªå•çœ‹è­·åŠ ç®— | emergency_visit_nursing | 2,650å††/2,000å†† | monthly_14day_threshold | âœ… |
| é•·æ™‚é–“è¨ªå•çœ‹è­·åŠ ç®— | long_visit_nursing | 5,200å†† | duration_based | âœ… |
| ä¹³å¹¼å…åŠ ç®— | infant_nursing | 1,500å†† | age_based | âœ… |
| è¤‡æ•°åè¨ªå•çœ‹è­·åŠ ç®— | multiple_visit_nursing | 4,500å†† | field_not_empty | âœ… |
| å¤œé–“ãƒ»æ—©æœ/æ·±å¤œè¨ªå•çœ‹è­·åŠ ç®— | night_early_morning_nursing | 4,200å††/2,100å†† | time_based | âœ… |
| 24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®— | 24h_support_system_basic | 6,400å†† | facility_flag | âœ… |
| è¨ªå•çœ‹è­·ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ç™‚é¤Šè²»1 | terminal_care_1 | 25,000å†† | terminal_care_requirement | âœ… |
| è¨ªå•çœ‹è­·ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ç™‚é¤Šè²»2 | terminal_care_2 | 10,000å†† | terminal_care_requirement | âš ï¸ éƒ¨åˆ†å®Ÿè£… |
| å°‚é–€ç®¡ç†åŠ ç®— | specialist_management | 2,500ç‚¹ | specialist_care_requirement | âœ… |
| é€€é™¢æ™‚å…±åŒæŒ‡å°åŠ ç®— | medical_discharge_joint_guidance | 8,000å†† | predefined_conditions | âœ… |
| ç‰¹åˆ¥ç®¡ç†æŒ‡å°åŠ ç®— | discharge_special_management_guidance | 2,000å†† | dependent_bonus | âœ… |
| é€€é™¢æ™‚æ”¯æ´æŒ‡å°åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ | discharge_support_guidance_basic | 6,000å†† | is_discharge_date | âœ… |
| é€€é™¢æ™‚æ”¯æ´æŒ‡å°åŠ ç®—ï¼ˆé•·æ™‚é–“ï¼‰ | discharge_support_guidance_long | 8,400å†† | duration_based | âœ… |

#### ä»‹è­·ä¿é™ºï¼ˆ8é …ç›®å®Ÿè£…æ¸ˆã¿ï¼‰

| åŠ ç®—å | ã‚³ãƒ¼ãƒ‰ | å˜ä½æ•° | å®Ÿè£…æ–¹æ³• | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|--------|--------|---------|-----------|
| å¤œé–“ãƒ»æ—©æœåŠ ç®— | care_night_early_morning | 25% | time_based | âœ… |
| æ·±å¤œåŠ ç®— | care_late_night | 50% | time_based | âœ… |
| é•·æ™‚é–“è¨ªå•çœ‹è­·åŠ ç®— | care_long_visit | 300å˜ä½ | duration_based | âœ… |
| åˆå›åŠ ç®—I | care_initial_visit_1 | 300å˜ä½ | is_first_visit_of_plan | âœ… |
| åˆå›åŠ ç®—II | care_initial_visit_2 | 400å˜ä½ | is_first_visit_of_plan + duration | âœ… |
| é€€é™¢æ™‚å…±åŒæŒ‡å°åŠ ç®— | care_discharge_joint_guidance | 600å˜ä½ | is_discharge_date | âœ… |
| ç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—I | care_emergency_system | 540å˜ä½/æœˆ | facility_flag | âœ… |
| ç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—II | care_emergency_system_2 | 800å˜ä½/æœˆ | facility_flag | âœ… |
| ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®— | care_terminal_care | 2,500å˜ä½ | terminal_care_requirement | âœ… |
| å°‚é–€ç®¡ç†åŠ ç®— | care_specialist_management | 250å˜ä½/æœˆ | specialist_care_requirement | âœ… |

---

## å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
1. è¨ªå•è¨˜éŒ²ä½œæˆ/æ›´æ–°
   â†“
2. routes.ts: calculateBonusesAndPoints()
   - æ‚£è€…æƒ…å ±ã‚’å–å¾—
   - è¨ªå•ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
   â†“
3. bonus-engine.ts: calculateBonuses()
   - å…¨åŠ ç®—ãƒã‚¹ã‚¿ã‚’å–å¾—
   - predefined_conditionsã‚’è©•ä¾¡
   â†“
4. æ¡ä»¶è©•ä¾¡é–¢æ•°ç¾¤
   - evaluateSpecialistCareRequirement()
   - evaluateTerminalCareRequirement()
   - evaluatePredefinedCondition()
   â†“
5. bonus_calculation_history ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²
   â†“
6. nursing_records.calculated_points ã‚’æ›´æ–°
```

### ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- [server/bonus-engine.ts](../server/bonus-engine.ts) - åŠ ç®—è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ1001è¡Œï¼‰
- [server/routes.ts](../server/routes.ts) - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- [shared/schema.ts](../shared/schema.ts) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- `client/src/components/BonusMasterManagement.tsx` - åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢
- `client/src/components/NursingRecords.tsx` - è¨ªå•è¨˜éŒ²ä½œæˆãƒ»ç·¨é›†
- `client/src/components/PatientForm.tsx` - æ‚£è€…æƒ…å ±ç·¨é›†

### æ¡ä»¶è©•ä¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³

bonus-engineã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹è©•ä¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | èª¬æ˜ | ä½¿ç”¨ä¾‹ |
|-----------|------|--------|
| `specialist_care_requirement` | å°‚é–€ç®¡ç†åŠ ç®—ã®æ¡ä»¶è©•ä¾¡ | çœ‹è­·å¸«ã®å°‚é–€è³‡æ ¼ã¨ã‚±ã‚¢ç¨®é¡ã‚’ç…§åˆ |
| `terminal_care_requirement` | ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã®æ¡ä»¶è©•ä¾¡ | æ­»äº¡æ—¥ãƒ»æ­»äº¡å ´æ‰€ãƒ»è¨ªå•å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯ |
| `is_discharge_date` | é€€é™¢æ—¥å½“æ—¥ã®è¨ªå• | é€€é™¢æ”¯æ´ç³»åŠ ç®— |
| `is_first_visit_of_plan` | æ–°è¦è¨ˆç”»æ›¸ä½œæˆå¾Œã®åˆå›è¨ªå• | åˆå›åŠ ç®— |
| `has_collaboration_record` | å¤šè·ç¨®é€£æºè¨˜éŒ²ã‚ã‚Š | é€€é™¢æ™‚å…±åŒæŒ‡å°åŠ ç®— |
| `is_terminal_care` | ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ãƒ•ãƒ©ã‚° | ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®— |
| `care_visit_duration_90plus` | è¨ªå•æ™‚é–“90åˆ†ä»¥ä¸Š | é•·æ™‚é–“è¨ªå•çœ‹è­·åŠ ç®— |
| `care_early_morning_time` | æ—©æœï¼ˆ6:00-8:00ï¼‰ | æ™‚é–“å¸¯åˆ¥åŠ ç®— |
| `care_night_time` | å¤œé–“ï¼ˆ18:00-22:00ï¼‰ | æ™‚é–“å¸¯åˆ¥åŠ ç®— |
| `care_late_night_time` | æ·±å¤œï¼ˆ22:00-6:00ï¼‰ | æ™‚é–“å¸¯åˆ¥åŠ ç®— |
| `has_24h_support_system` | 24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ | æ–½è¨­ä½“åˆ¶ãƒ•ãƒ©ã‚° |
| `has_emergency_support_system` | ç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—I | æ–½è¨­ä½“åˆ¶ãƒ•ãƒ©ã‚° |
| `field_not_empty` | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ã‚ã‚Š | è¤‡æ•°åè¨ªå•çœ‹è­·åŠ ç®— |
| `duration_based` | è¨ªå•æ™‚é–“ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å² | é•·æ™‚é–“è¨ªå•ã€é€€é™¢æ”¯æ´ï¼ˆé•·æ™‚é–“ï¼‰ |
| `time_based` | æ™‚é–“å¸¯ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å² | å¤œé–“ãƒ»æ—©æœãƒ»æ·±å¤œåŠ ç®— |
| `age_based` | å¹´é½¢ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å² | ä¹³å¹¼å…åŠ ç®— |

---

## åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†

### bonus_master ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-------|------|
| id | UUID | ä¸»ã‚­ãƒ¼ |
| bonus_code | VARCHAR(100) | åŠ ç®—ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ |
| bonus_name | VARCHAR(255) | åŠ ç®—åï¼ˆæ—¥æœ¬èªï¼‰ |
| insurance_type | ENUM | ä¿é™ºç¨®åˆ¥ï¼ˆmedical/careï¼‰ |
| points_type | ENUM | ç‚¹æ•°ã‚¿ã‚¤ãƒ—ï¼ˆfixed/conditional/percentageï¼‰ |
| fixed_points | DECIMAL | å›ºå®šç‚¹æ•° |
| conditional_points | JSONB | æ¡ä»¶åˆ†å²ç‚¹æ•°å®šç¾© |
| predefined_conditions | JSONB | é©ç”¨æ¡ä»¶å®šç¾© |
| can_combine_with | TEXT[] | ä½µç®—å®šå¯èƒ½ãªåŠ ç®—ãƒªã‚¹ãƒˆ |
| cannot_combine_with | TEXT[] | ä½µç®—å®šä¸å¯ãªåŠ ç®—ãƒªã‚¹ãƒˆ |
| version | VARCHAR(20) | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ'2024'ç­‰ï¼‰ |
| valid_from | DATE | æœ‰åŠ¹æœŸé–“é–‹å§‹æ—¥ |
| valid_to | DATE | æœ‰åŠ¹æœŸé–“çµ‚äº†æ—¥ |
| is_active | BOOLEAN | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| display_order | INTEGER | è¡¨ç¤ºé † |
| notes | TEXT | å‚™è€ƒ |

### é©ç”¨æ¡ä»¶ã®å®šç¾©æ–¹æ³•

#### å½¢å¼1: pattern + operator + value

```json
{
  "pattern": "is_discharge_date",
  "operator": "equals",
  "value": true,
  "description": "é€€é™¢æ—¥å½“æ—¥ã®è¨ªå•"
}
```

#### å½¢å¼2: type ã®ã¿ï¼ˆæ–½è¨­ä½“åˆ¶ãƒ•ãƒ©ã‚°ï¼‰

```json
{
  "type": "has_emergency_support_system"
}
```

#### å½¢å¼3: ANDæ¡ä»¶

```json
[
  {
    "pattern": "is_discharge_date",
    "operator": "equals",
    "value": true
  },
  {
    "pattern": "has_collaboration_record",
    "operator": "equals",
    "value": true
  }
]
```

### åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢

åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ã§ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ï¼š

1. **é©ç”¨æ¡ä»¶ã®äººé–“å¯èª­åŒ–è¡¨ç¤º**
   - `predefined_conditions`ã‚’è‡ªå‹•è§£æ
   - æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
   - å®Ÿè£…: `PredefinedConditionsDisplay`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

2. **åŠ ç®—ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿**
   - ä¿é™ºç¨®åˆ¥ã§ãƒ•ã‚£ãƒ«ã‚¿
   - æœ‰åŠ¹/ç„¡åŠ¹ã§ãƒ•ã‚£ãƒ«ã‚¿
   - åŠ ç®—åãƒ»ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢

3. **CRUDæ“ä½œ**
   - æ–°è¦ç™»éŒ²
   - ç·¨é›†
   - å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰

4. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**
   - è¨ºç™‚å ±é…¬æ”¹å®šã«å¯¾å¿œ
   - æœ‰åŠ¹æœŸé–“ã®ç®¡ç†
   - æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯

---

## å°‚é–€ç®¡ç†åŠ ç®—ã®å®Ÿè£…

### æ¦‚è¦

å°‚é–€ç®¡ç†åŠ ç®—ã¯ã€å°‚é–€ç ”ä¿®ã‚’å—ã‘ãŸçœ‹è­·å¸«ãŒå°‚é–€çš„ãªã‚±ã‚¢ã‚’æä¾›ã—ãŸéš›ã«ç®—å®šã§ãã‚‹åŠ ç®—ã§ã™ã€‚

#### åŠ ç®—ç¨®åˆ¥

| åŠ ç®—å | ã‚³ãƒ¼ãƒ‰ | ä¿é™ºç¨®åˆ¥ | ç‚¹æ•° |
|--------|--------|---------|------|
| å°‚é–€ç®¡ç†åŠ ç®— | specialist_management | åŒ»ç™‚ä¿é™º | 2,500ç‚¹ |
| å°‚é–€ç®¡ç†åŠ ç®— | care_specialist_management | ä»‹è­·ä¿é™º | 250å˜ä½/æœˆ |

### ç®—å®šæ¡ä»¶

1. **çœ‹è­·å¸«ãŒå°‚é–€è³‡æ ¼ã‚’æŒã£ã¦ã„ã‚‹**
   - users.specialist_certifications ã«å°‚é–€è³‡æ ¼åãŒå«ã¾ã‚Œã‚‹
2. **è¨ªå•è¨˜éŒ²ã§å°‚é–€çš„ã‚±ã‚¢ãŒå®Ÿæ–½ã•ã‚ŒãŸ**
   - nursing_records.specialist_care_type ã«å°‚é–€ã‚±ã‚¢ç¨®åˆ¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
3. **å°‚é–€è³‡æ ¼ã¨ã‚±ã‚¢ç¨®åˆ¥ãŒä¸€è‡´**
   - ç·©å’Œã‚±ã‚¢ã®è³‡æ ¼ â†’ ç·©å’Œã‚±ã‚¢ã®å®Ÿæ–½
   - è¤¥ç˜¡ã‚±ã‚¢ã®è³‡æ ¼ â†’ è¤¥ç˜¡ã‚±ã‚¢ã®å®Ÿæ–½

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

#### users ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```sql
ALTER TABLE users
ADD COLUMN specialist_certifications TEXT[] DEFAULT '{}';
```

**å°‚é–€è³‡æ ¼åã®çµ±ä¸€:**
- âœ… `ç·©å’Œã‚±ã‚¢`
- âœ… `è¤¥ç˜¡ã‚±ã‚¢`
- âœ… `ç‰¹å®šè¡Œç‚º`

#### nursing_records ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```sql
ALTER TABLE nursing_records
ADD COLUMN specialist_care_type VARCHAR(50);
```

**å°‚é–€ã‚±ã‚¢ç¨®åˆ¥:**
- `palliative_care` - ç·©å’Œã‚±ã‚¢
- `pressure_ulcer` - è¤¥ç˜¡ã‚±ã‚¢
- `specific_medical_acts` - ç‰¹å®šè¡Œç‚º

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

#### bonus-engine.ts - è©•ä¾¡é–¢æ•°

```typescript
async function evaluateSpecialistCareRequirement(
  context: BonusCalculationContext,
  bonusCode: string
): Promise<ConditionEvaluationResult> {
  // 1. è¨ªå•è¨˜éŒ²ã«å°‚é–€çš„ã‚±ã‚¢ã®è¨˜éŒ²ãŒã‚ã‚‹ã‹ç¢ºèª
  if (!context.specialistCareType) {
    return {
      passed: false,
      reason: "è¨ªå•è¨˜éŒ²ã«å°‚é–€çš„ã‚±ã‚¢ã®ç¨®é¡ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„",
    };
  }

  // 2. æ‹…å½“çœ‹è­·å¸«ã®å°‚é–€è³‡æ ¼ã‚’å–å¾—
  const nurse = await db.query.users.findFirst({
    where: eq(users.id, context.nurseId),
  });

  if (!nurse?.specialistCertifications || nurse.specialistCertifications.length === 0) {
    return {
      passed: false,
      reason: "æ‹…å½“çœ‹è­·å¸«ã«å°‚é–€è³‡æ ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„",
    };
  }

  // 3. å°‚é–€ã‚±ã‚¢ç¨®åˆ¥ã¨å°‚é–€è³‡æ ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  const careTypeToSpecialty: Record<string, string> = {
    palliative_care: "ç·©å’Œã‚±ã‚¢",
    pressure_ulcer: "è¤¥ç˜¡ã‚±ã‚¢",
    specific_medical_acts: "ç‰¹å®šè¡Œç‚º",
  };

  const requiredSpecialty = careTypeToSpecialty[context.specialistCareType];
  if (!requiredSpecialty) {
    return {
      passed: false,
      reason: `ä¸æ˜ãªå°‚é–€ã‚±ã‚¢ç¨®åˆ¥: ${context.specialistCareType}`,
    };
  }

  // 4. çœ‹è­·å¸«ãŒå¿…è¦ãªå°‚é–€è³‡æ ¼ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
  const hasRequiredSpecialty = nurse.specialistCertifications.includes(requiredSpecialty);

  if (!hasRequiredSpecialty) {
    return {
      passed: false,
      reason: `æ‹…å½“çœ‹è­·å¸«ãŒã€Œ${requiredSpecialty}ã€ã®å°‚é–€è³‡æ ¼ã‚’æŒã£ã¦ã„ãªã„`,
    };
  }

  return {
    passed: true,
    reason: `å°‚é–€è³‡æ ¼ã€Œ${requiredSpecialty}ã€ã‚’æŒã¤çœ‹è­·å¸«ãŒå°‚é–€çš„ã‚±ã‚¢ã‚’å®Ÿæ–½`,
  };
}
```

### ãƒ†ã‚¹ãƒˆæ–¹æ³•

#### 1. çœ‹è­·å¸«ã«å°‚é–€è³‡æ ¼ã‚’è¨­å®š

```sql
UPDATE users
SET specialist_certifications = ARRAY['ç·©å’Œã‚±ã‚¢', 'è¤¥ç˜¡ã‚±ã‚¢']
WHERE id = 'nurse-id-here';
```

#### 2. è¨ªå•è¨˜éŒ²ã‚’ä½œæˆ

UIä¸Šã§ï¼š
1. è¨ªå•è¨˜éŒ²ä½œæˆç”»é¢ã‚’é–‹ã
2. å°‚é–€çš„ã‚±ã‚¢ã®ç¨®é¡ã§ã€Œç·©å’Œã‚±ã‚¢ã€ã‚’é¸æŠ
3. ä¿å­˜

#### 3. åŠ ç®—ã®ç¢ºèª

è¨ªå•è¨˜éŒ²è©³ç´°ç”»é¢ã®ã€Œé©ç”¨åŠ ç®—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- âœ… å°‚é–€ç®¡ç†åŠ ç®—ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ç‚¹æ•°ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ï¼ˆåŒ»ç™‚: 2,500ç‚¹ã€ä»‹è­·: 250å˜ä½ï¼‰

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### åŠ ç®—ãŒé©ç”¨ã•ã‚Œãªã„å ´åˆ

1. **çœ‹è­·å¸«ã®å°‚é–€è³‡æ ¼ã‚’ç¢ºèª**
   ```sql
   SELECT id, full_name, specialist_certifications
   FROM users
   WHERE id = 'nurse-id';
   ```

2. **è¨ªå•è¨˜éŒ²ã®å°‚é–€ã‚±ã‚¢ç¨®åˆ¥ã‚’ç¢ºèª**
   ```sql
   SELECT id, specialist_care_type, nurse_id
   FROM nursing_records
   WHERE id = 'record-id';
   ```

3. **åŠ ç®—ãƒã‚¹ã‚¿ã®æ¡ä»¶ã‚’ç¢ºèª**
   ```sql
   SELECT bonus_code, bonus_name, predefined_conditions, is_active
   FROM bonus_master
   WHERE bonus_code IN ('specialist_management', 'care_specialist_management');
   ```

4. **åŠ ç®—è¨ˆç®—å±¥æ­´ã‚’ç¢ºèª**
   ```sql
   SELECT
     bch.id,
     bm.bonus_code,
     bm.bonus_name,
     bch.calculated_points,
     bch.calculation_details
   FROM bonus_calculation_history bch
   JOIN bonus_master bm ON bch.bonus_master_id = bm.id
   WHERE bch.nursing_record_id = 'record-id';
   ```

---

## ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã®å®Ÿè£…

### æ¦‚è¦

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã¯ã€è¨ªå•çœ‹è­·ã«ãŠã„ã¦çµ‚æœ«æœŸã®ã‚±ã‚¢ã‚’æä¾›ã—ãŸéš›ã«ç®—å®šã§ãã‚‹åŠ ç®—ã§ã™ã€‚

### åŠ ç®—ç¨®åˆ¥

| åŠ ç®—å | ã‚³ãƒ¼ãƒ‰ | ä¿é™ºç¨®åˆ¥ | ç‚¹æ•° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|--------|---------|------|-----------|
| è¨ªå•çœ‹è­·ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ç™‚é¤Šè²»1 | terminal_care_1 | åŒ»ç™‚ä¿é™º | 25,000å†† | âœ… å®Ÿè£…å®Œäº† |
| è¨ªå•çœ‹è­·ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ç™‚é¤Šè²»2 | terminal_care_2 | åŒ»ç™‚ä¿é™º | 10,000å†† | âš ï¸ éƒ¨åˆ†å®Ÿè£… |
| ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®— | care_terminal_care | ä»‹è­·ä¿é™º | 2,500å˜ä½ | âœ… å®Ÿè£…å®Œäº† |

### ç®—å®šæ¡ä»¶

#### terminal_care_1ï¼ˆåŒ»ç™‚ä¿é™ºãƒ»åœ¨å®…ã¾ãŸã¯æ–½è¨­æ­»äº¡ï¼‰

1. æ­»äº¡æ—¥ã®è¨ªå•ã§ã‚ã‚‹ã“ã¨
2. **åœ¨å®…ã¾ãŸã¯æ–½è¨­ï¼ˆç‰¹é¤Šç­‰ï¼‰ã§æ­»äº¡**ã—ã¦ã„ã‚‹ã“ã¨
3. æ­»äº¡æ—¥å‰14æ—¥ä»¥å†…ã«2å›ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒã‚ã‚‹ã“ã¨

#### care_terminal_careï¼ˆä»‹è­·ä¿é™ºãƒ»åœ¨å®…æ­»äº¡ã®ã¿ï¼‰

1. æ­»äº¡æ—¥ã®è¨ªå•ã§ã‚ã‚‹ã“ã¨
2. **åœ¨å®…ã§æ­»äº¡**ã—ã¦ã„ã‚‹ã“ã¨
3. æ­»äº¡æ—¥å‰14æ—¥ä»¥å†…ã«2æ—¥ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒã‚ã‚‹ã“ã¨

#### terminal_care_2ï¼ˆåŒ»ç™‚ä¿é™ºãƒ»æ–½è¨­æ­»äº¡ + çœ‹å–ã‚Šä»‹è­·åŠ ç®—ï¼‰âš ï¸

1. æ­»äº¡æ—¥ã®è¨ªå•ã§ã‚ã‚‹ã“ã¨
2. **æ–½è¨­ï¼ˆç‰¹é¤Šç­‰ï¼‰ã§æ­»äº¡**ã—ã¦ã„ã‚‹ã“ã¨
3. æ­»äº¡æ—¥å‰14æ—¥ä»¥å†…ã«2å›ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒã‚ã‚‹ã“ã¨
4. **çœ‹å–ã‚Šä»‹è­·åŠ ç®—ã‚’ç®—å®šã—ã¦ã„ã‚‹å ´åˆ**ï¼ˆâš ï¸ æœªå®Ÿè£…ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

#### patients ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```sql
ALTER TABLE patients
ADD COLUMN death_date DATE,
ADD COLUMN death_location VARCHAR(20); -- 'home' | 'facility'
```

#### nursing_records ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```sql
ALTER TABLE nursing_records
ADD COLUMN is_terminal_care BOOLEAN DEFAULT false;
```

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

#### bonus-engine.ts - è©•ä¾¡é–¢æ•°

```typescript
async function evaluateTerminalCareRequirement(
  context: BonusCalculationContext,
  bonusCode: string
): Promise<ConditionEvaluationResult> {
  // 1. æ‚£è€…ã®æ­»äº¡æ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  if (!context.deathDate) {
    return { passed: false, reason: "æ‚£è€…ã®æ­»äº¡æ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„" };
  }

  // 2. ç¾åœ¨ã®è¨ªå•ãŒæ­»äº¡æ—¥ã‹ã©ã†ã‹ç¢ºèª
  const visitDate = new Date(context.visitDate);
  const deathDate = new Date(context.deathDate);
  const visitDateStr = visitDate.toISOString().split('T')[0];
  const deathDateStr = deathDate.toISOString().split('T')[0];

  if (visitDateStr !== deathDateStr) {
    return { passed: false, reason: "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã¯æ­»äº¡æ—¥ã®è¨ªå•ã«ã®ã¿ç®—å®šå¯èƒ½" };
  }

  // 3. æ­»äº¡å ´æ‰€ã®ãƒã‚§ãƒƒã‚¯ï¼ˆåŠ ç®—ç¨®åˆ¥ã«ã‚ˆã‚‹ï¼‰
  const deathLocation = context.deathLocation;

  if (bonusCode === 'terminal_care_1') {
    // åœ¨å®…ã¾ãŸã¯æ–½è¨­
    if (!deathLocation || !['home', 'facility'].includes(deathLocation)) {
      return { passed: false, reason: "death_locationãŒæœªè¨­å®šã¾ãŸã¯ä¸æ­£ãªå€¤" };
    }
  } else if (bonusCode === 'terminal_care_2') {
    // æ–½è¨­ã®ã¿
    if (deathLocation !== 'facility') {
      return { passed: false, reason: "ç‰¹é¤Šç­‰ã§ã®æ­»äº¡ãŒå¿…è¦ï¼ˆdeath_location='facility'ï¼‰" };
    }
    // çœ‹å–ã‚Šä»‹è­·åŠ ç®—ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå®Ÿè£…ï¼‰
    // TODO: has_end_of_life_care_bonus ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ãŒå¿…è¦
  } else if (bonusCode === 'care_terminal_care') {
    // åœ¨å®…ã®ã¿
    if (deathLocation !== 'home') {
      return { passed: false, reason: "åœ¨å®…ã§ã®æ­»äº¡ãŒå¿…è¦ï¼ˆdeath_location='home'ï¼‰" };
    }
  }

  // 4. 14æ—¥ä»¥å†…ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const startDate = new Date(deathDate);
  startDate.setDate(startDate.getDate() - 14);

  const terminalCareVisits = await db
    .select()
    .from(nursingRecords)
    .where(
      and(
        eq(nursingRecords.patientId, context.patientId),
        eq(nursingRecords.isTerminalCare, true),
        gte(nursingRecords.visitDate, startDate.toISOString().split('T')[0]),
        lte(nursingRecords.visitDate, deathDate.toISOString().split('T')[0])
      )
    );

  const visitCount = terminalCareVisits.length;
  const requiredVisits = 2;

  if (visitCount < requiredVisits) {
    return {
      passed: false,
      reason: `æ­»äº¡æ—¥å‰14æ—¥ä»¥å†…ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒä¸è¶³ï¼ˆ${visitCount}å›/${requiredVisits}å›å¿…è¦ï¼‰`,
    };
  }

  return { passed: true, reason: "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™" };
}
```

### UIå®Ÿè£…

#### PatientForm.tsx - æ­»äº¡æ—¥ãƒ»æ­»äº¡å ´æ‰€ã®å…¥åŠ›

```tsx
// æ­»äº¡æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
<FormField
  control={form.control}
  name="deathDate"
  render={({ field }) => (
    <FormItem className="flex flex-col">
      <FormLabel>æ­»äº¡æ—¥</FormLabel>
      <Popover>
        <PopoverTrigger asChild>
          <FormControl>
            <Button
              variant="outline"
              className="w-full pl-3 text-left font-normal bg-background hover:bg-background"
            >
              {field.value ? format(new Date(field.value), "PPP", { locale: ja }) : <span>æ­»äº¡æ—¥ã‚’é¸æŠ</span>}
              <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
            </Button>
          </FormControl>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-0" align="start">
          <Calendar
            mode="single"
            selected={field.value ? new Date(field.value) : undefined}
            onSelect={(date) => field.onChange(date?.toISOString().split('T')[0])}
            locale={ja}
          />
        </PopoverContent>
      </Popover>
      <FormMessage />
    </FormItem>
  )}
/>

// æ­»äº¡å ´æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
<FormField
  control={form.control}
  name="deathLocation"
  render={({ field }) => (
    <FormItem>
      <FormLabel>æ­»äº¡å ´æ‰€</FormLabel>
      <Select
        onValueChange={field.onChange}
        value={field.value || ""}
      >
        <FormControl>
          <SelectTrigger>
            <SelectValue placeholder="æ­»äº¡å ´æ‰€ã‚’é¸æŠ" />
          </SelectTrigger>
        </FormControl>
        <SelectContent>
          <SelectItem value="home">åœ¨å®…</SelectItem>
          <SelectItem value="facility">ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ç­‰</SelectItem>
        </SelectContent>
      </Select>
      <FormMessage />
    </FormItem>
  )}
/>
```

#### NursingRecords.tsx - ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ãƒ•ãƒ©ã‚°

```tsx
<FormField
  control={form.control}
  name="isTerminalCare"
  render={({ field }) => (
    <FormItem className="flex items-center space-x-2">
      <FormControl>
        <Checkbox
          checked={field.value}
          onCheckedChange={field.onChange}
        />
      </FormControl>
      <FormLabel className="!mt-0">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢</FormLabel>
    </FormItem>
  )}
/>
```

### ãƒ†ã‚¹ãƒˆæ–¹æ³•

#### UIã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **æ‚£è€…ç™»éŒ²**
   - æ‚£è€…ç•ªå·: TEST-TERMINAL-001
   - æ­»äº¡æ—¥: 2025-03-15
   - æ­»äº¡å ´æ‰€: åœ¨å®… ã¾ãŸã¯ æ–½è¨­
   - ä¿é™ºè¨¼: ç™»éŒ²å¿…é ˆ

2. **è¨ªå•è¨˜éŒ²ç™»éŒ²ï¼ˆ3ä»¶ï¼‰**
   - è¨ªå•1: 2025-03-05, ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢: âœ…
   - è¨ªå•2: 2025-03-10, ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢: âœ…
   - è¨ªå•3: 2025-03-15ï¼ˆæ­»äº¡æ—¥ï¼‰, ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢: âœ…

3. **ç¢ºèª**
   - è¨ªå•è¨˜éŒ²3ã®è©³ç´°ç”»é¢ã§ã€Œé©ç”¨åŠ ç®—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢åŠ ç®—ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ç‚¹æ•°ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹

#### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æä¾›ï¼š

```bash
# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
node test-all-terminal-care.mjs

# åŠ ç®—å†è¨ˆç®—ï¼ˆSQLç›´æ¥æŒ¿å…¥ã—ãŸãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
node recalculate-all-terminal.mjs
```

### terminal_care_2ã®å®Œå…¨å®Ÿè£…ï¼ˆæœªå®Ÿè£…éƒ¨åˆ†ï¼‰

çœ‹å–ã‚Šä»‹è­·åŠ ç®—ã®ãƒã‚§ãƒƒã‚¯ã«ã¯ä»¥ä¸‹ã®è¿½åŠ å®Ÿè£…ãŒå¿…è¦ï¼š

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®æ‹¡å¼µ

```sql
ALTER TABLE patients
ADD COLUMN has_end_of_life_care_bonus BOOLEAN DEFAULT false;
```

#### 2. bonus-engine.tsã®ä¿®æ­£

```typescript
if (bonusCode === 'terminal_care_2') {
  if (deathLocation !== 'facility') {
    return { passed: false, reason: "ç‰¹é¤Šç­‰ã§ã®æ­»äº¡ãŒå¿…è¦" };
  }

  // ã€è¿½åŠ å¿…è¦ã€‘çœ‹å–ã‚Šä»‹è­·åŠ ç®—ãƒã‚§ãƒƒã‚¯
  const patient = await db.query.patients.findFirst({
    where: eq(patients.id, context.patientId)
  });

  if (!patient?.hasEndOfLifeCareBonus) {
    return { passed: false, reason: "çœ‹å–ã‚Šä»‹è­·åŠ ç®—ã‚’ç®—å®šã—ã¦ã„ãªã„" };
  }
}
```

#### 3. UIã®è¿½åŠ 

PatientForm.tsx ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¿½åŠ ï¼š

```tsx
<FormField
  control={form.control}
  name="hasEndOfLifeCareBonus"
  render={({ field }) => (
    <FormItem className="flex items-center space-x-2">
      <FormControl>
        <Checkbox
          checked={field.value}
          onCheckedChange={field.onChange}
        />
      </FormControl>
      <FormLabel>çœ‹å–ã‚Šä»‹è­·åŠ ç®—ã‚’ç®—å®š</FormLabel>
    </FormItem>
  )}
/>
```

#### 4. contextã®æ‹¡å¼µ

routes.ts - calculateBonusesAndPoints():

```typescript
const context = {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  hasEndOfLifeCareBonus: patient.hasEndOfLifeCareBonus || false,
};
```

**å®Ÿè£…å·¥æ•°**: 2-3æ™‚é–“
**å„ªå…ˆåº¦**: ä¸­

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### åŠ ç®—ãŒè¨ˆç®—ã•ã‚Œãªã„å ´åˆ

1. **æ­»äº¡æ—¥ã®ç¢ºèª**
   ```sql
   SELECT patient_number, death_date, death_location
   FROM patients
   WHERE patient_number = 'TEST-TERMINAL-001';
   ```

2. **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ã®ç¢ºèª**
   ```sql
   SELECT visit_date, is_terminal_care
   FROM nursing_records
   WHERE patient_id = (SELECT id FROM patients WHERE patient_number = 'TEST-TERMINAL-001')
     AND is_terminal_care = true
   ORDER BY visit_date;
   ```

3. **14æ—¥ä»¥å†…ã®è¨ªå•æ•°ãƒã‚§ãƒƒã‚¯**
   - æ­»äº¡æ—¥ã®14æ—¥å‰ã‹ã‚‰æ­»äº¡æ—¥ã¾ã§ã«2å›ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒã‚ã‚‹ã‹ç¢ºèª

4. **åŠ ç®—å±¥æ­´ã®ç¢ºèª**
   ```sql
   SELECT
     bm.bonus_code,
     bm.bonus_name,
     bch.calculated_points
   FROM bonus_calculation_history bch
   JOIN bonus_master bm ON bch.bonus_master_id = bm.id
   JOIN nursing_records nr ON bch.nursing_record_id = nr.id
   WHERE nr.patient_id = (SELECT id FROM patients WHERE patient_number = 'TEST-TERMINAL-001')
     AND nr.visit_date = (SELECT death_date FROM patients WHERE patient_number = 'TEST-TERMINAL-001');
   ```

#### ã‚ˆãã‚ã‚‹åŸå› 

1. **è¨ªå•è¨˜éŒ²ã®is_terminal_careãŒfalse**
   - è¨ªå•è¨˜éŒ²ä½œæˆæ™‚ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹

2. **æ­»äº¡æ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„**
   - æ‚£è€…æƒ…å ±ã§æ­»äº¡æ—¥ã¨æ­»äº¡å ´æ‰€ã‚’è¨­å®š

3. **è¨ªå•å›æ•°ãŒä¸è¶³**
   - æ­»äº¡æ—¥å‰14æ—¥ä»¥å†…ã«2å›ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢è¨ªå•ãŒå¿…è¦

4. **ä¿é™ºç¨®åˆ¥ã¨æ­»äº¡å ´æ‰€ã®ä¸ä¸€è‡´**
   - ä»‹è­·ä¿é™º: åœ¨å®…ã®ã¿
   - åŒ»ç™‚ä¿é™ºï¼ˆç™‚é¤Šè²»1ï¼‰: åœ¨å®…ã¾ãŸã¯æ–½è¨­
   - åŒ»ç™‚ä¿é™ºï¼ˆç™‚é¤Šè²»2ï¼‰: æ–½è¨­ã®ã¿ + çœ‹å–ã‚Šä»‹è­·åŠ ç®—

---

## æ–°è¦åŠ ç®—ã®è¿½åŠ æ–¹æ³•

### ã‚¹ãƒ†ãƒƒãƒ—1: åŠ ç®—ãƒã‚¹ã‚¿ã¸ã®ãƒ‡ãƒ¼ã‚¿ç™»éŒ²

åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ã¾ãŸã¯ç›´æ¥SQLã§ç™»éŒ²ï¼š

```sql
INSERT INTO bonus_master (
  bonus_code,
  bonus_name,
  insurance_type,
  points_type,
  fixed_points,
  predefined_conditions,
  version,
  valid_from,
  is_active,
  display_order,
  notes
) VALUES (
  'new_bonus_code',
  'æ–°è¦åŠ ç®—å',
  'medical', -- ã¾ãŸã¯ 'care'
  'fixed', -- ã¾ãŸã¯ 'conditional', 'percentage'
  5000,
  '[
    {
      "pattern": "new_pattern",
      "operator": "equals",
      "value": true,
      "description": "æ–°ã—ã„æ¡ä»¶"
    }
  ]'::jsonb,
  '2024',
  '2024-04-01',
  true,
  100,
  'æ–°è¦åŠ ç®—ã®å‚™è€ƒ'
);
```

### ã‚¹ãƒ†ãƒƒãƒ—2: æ¡ä»¶è©•ä¾¡é–¢æ•°ã®å®Ÿè£…ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

æ–°ã—ã„è©•ä¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¿…è¦ãªå ´åˆã€bonus-engine.ts ã«è¿½åŠ ï¼š

```typescript
function evaluateNewPattern(context: BonusCalculationContext): ConditionEvaluationResult {
  // æ¡ä»¶è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
  if (/* æ¡ä»¶ãƒã‚§ãƒƒã‚¯ */) {
    return {
      passed: true,
      reason: "æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™",
    };
  }
  return {
    passed: false,
    reason: "æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“",
  };
}
```

evaluatePredefinedCondition ã® switch ã«è¿½åŠ ï¼š

```typescript
case "new_pattern":
  result = evaluateNewPattern(context);
  break;
```

### ã‚¹ãƒ†ãƒƒãƒ—3: éåŒæœŸè©•ä¾¡ãŒå¿…è¦ãªå ´åˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãŒå¿…è¦ãªå ´åˆï¼š

```typescript
async function evaluateNewPatternAsync(
  context: BonusCalculationContext
): Promise<ConditionEvaluationResult> {
  // éåŒæœŸå‡¦ç†
  const data = await db.query...

  if (/* æ¡ä»¶ãƒã‚§ãƒƒã‚¯ */) {
    return { passed: true, reason: "..." };
  }
  return { passed: false, reason: "..." };
}
```

calculateBonuses é–¢æ•°å†…ã§éåŒæœŸè©•ä¾¡ï¼š

```typescript
if (condition.pattern === "new_pattern") {
  result = await evaluateNewPatternAsync(context);
} else {
  result = evaluatePredefinedCondition(condition, context);
}
```

### ã‚¹ãƒ†ãƒƒãƒ—4: UIå¯¾å¿œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 

```sql
ALTER TABLE nursing_records
ADD COLUMN new_field VARCHAR(100);
```

#### ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 

NursingRecords.tsx ã¾ãŸã¯ PatientForm.tsx:

```tsx
<FormField
  control={form.control}
  name="newField"
  render={({ field }) => (
    <FormItem>
      <FormLabel>æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</FormLabel>
      <FormControl>
        <Input {...field} />
      </FormControl>
      <FormMessage />
    </FormItem>
  )}
/>
```

### ã‚¹ãƒ†ãƒƒãƒ—5: é©ç”¨æ¡ä»¶è¡¨ç¤ºã®è¿½åŠ 

BonusMasterManagement.tsx ã® patternDescriptions ã«è¿½åŠ ï¼š

```typescript
const patternDescriptions: Record<string, { withCheck: string; withoutCheck: string }> = {
  // ...æ—¢å­˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³...
  new_pattern: {
    withCheck: 'è¨ªå•è¨˜éŒ²ã®ã€Œæ–°ã—ã„æ¡ä»¶ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š',
    withoutCheck: 'è¨ªå•è¨˜éŒ²ã®ã€Œæ–°ã—ã„æ¡ä»¶ã€ã«ãƒã‚§ãƒƒã‚¯ãªã—',
  },
};
```

### ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ†ã‚¹ãƒˆ

1. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
2. è¨ªå•è¨˜éŒ²ä½œæˆ
3. åŠ ç®—ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. åŠ ç®—è¨ˆç®—å±¥æ­´ã‚’ç¢ºèª

```sql
SELECT
  bm.bonus_code,
  bm.bonus_name,
  bch.calculated_points,
  bch.calculation_details
FROM bonus_calculation_history bch
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
WHERE bch.nursing_record_id = 'test-record-id';
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### åŠ ç®—ãŒé©ç”¨ã•ã‚Œãªã„

#### 1. åŠ ç®—ãƒã‚¹ã‚¿ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª

```sql
SELECT bonus_code, bonus_name, is_active, valid_from, valid_to
FROM bonus_master
WHERE bonus_code = 'your_bonus_code';
```

- `is_active = true` ã§ã‚ã‚‹ã“ã¨
- è¨ªå•æ—¥ãŒ `valid_from` ã¨ `valid_to` ã®ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨

#### 2. é©ç”¨æ¡ä»¶ã‚’ç¢ºèª

```sql
SELECT predefined_conditions
FROM bonus_master
WHERE bonus_code = 'your_bonus_code';
```

æ¡ä»¶ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### 3. è¨ªå•è¨˜éŒ²ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

```sql
SELECT *
FROM nursing_records
WHERE id = 'record-id';
```

æ¡ä»¶ã«å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### 4. è¨ˆç®—å±¥æ­´ã‚’ç¢ºèª

```sql
SELECT
  bm.bonus_code,
  bm.bonus_name,
  bch.calculated_points,
  bch.calculation_details
FROM bonus_calculation_history bch
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
WHERE bch.nursing_record_id = 'record-id';
```

åŠ ç®—ãŒè¨ˆç®—ã•ã‚ŒãŸã‹ã€ã•ã‚Œãªã‹ã£ãŸå ´åˆã®ç†ç”±ã‚’ç¢ºèª

#### 5. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

é–‹ç™ºç’°å¢ƒã§ã¯ã€bonus-engine.ts ã®è©•ä¾¡çµæœãŒãƒ­ã‚°å‡ºåŠ›ã•ã‚Œã‚‹ï¼š

```
[Bonus Calculation] Evaluating bonus: specialist_management
[Condition Evaluation] pattern=specialist_care_requirement, result=passed
```

### ç‚¹æ•°ãŒæ­£ã—ããªã„

#### 1. åŠ ç®—ãƒã‚¹ã‚¿ã®ç‚¹æ•°ã‚’ç¢ºèª

```sql
SELECT bonus_code, bonus_name, points_type, fixed_points, conditional_points
FROM bonus_master
WHERE bonus_code = 'your_bonus_code';
```

#### 2. æ¡ä»¶åˆ†å²ã‚¿ã‚¤ãƒ—ã®å ´åˆ

conditional_points ã®å®šç¾©ã‚’ç¢ºèªï¼š

```json
{
  "conditions": [
    {
      "durationMinutes": 90,
      "operator": "greater_than",
      "points": 8400
    }
  ],
  "defaultPoints": 6000
}
```

è¨ªå•æ™‚é–“ãªã©ã®æ¡ä»¶ãŒæ­£ã—ãè©•ä¾¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### 3. ä½µç®—å®šåˆ¶å¾¡ã‚’ç¢ºèª

```sql
SELECT can_combine_with, cannot_combine_with
FROM bonus_master
WHERE bonus_code = 'your_bonus_code';
```

ä»–ã®åŠ ç®—ã¨ã®ä½µç®—å®šãŒåˆ¶é™ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª

### ãƒ¬ã‚»ãƒ—ãƒˆç”Ÿæˆã§åŠ ç®—ãŒè¡¨ç¤ºã•ã‚Œãªã„

#### 1. ä¿é™ºè¨¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```sql
SELECT * FROM insurance_cards
WHERE patient_id = 'patient-id';
```

ãƒ¬ã‚»ãƒ—ãƒˆç”Ÿæˆã«ã¯ä¿é™ºè¨¼ã®ç™»éŒ²ãŒå¿…é ˆ

#### 2. è¨ªå•è¨˜éŒ²ã®ä¿é™ºç¨®åˆ¥ã‚’ç¢ºèª

```sql
SELECT p.insurance_type, nr.visit_date
FROM nursing_records nr
JOIN patients p ON nr.patient_id = p.id
WHERE nr.id = 'record-id';
```

æ‚£è€…ã®ä¿é™ºç¨®åˆ¥ã¨åŠ ç®—ã®ä¿é™ºç¨®åˆ¥ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª

#### 3. æœˆæ¬¡ãƒ¬ã‚»ãƒ—ãƒˆã‚’å†ç”Ÿæˆ

æœˆæ¬¡ãƒ¬ã‚»ãƒ—ãƒˆç®¡ç†ç”»é¢ã§è©²å½“æœˆã®ãƒ¬ã‚»ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã€å†ç”Ÿæˆã™ã‚‹

### å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

#### 1. TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯

```bash
npm run check
```

å‹ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ã™ã‚‹

#### 2. ã‚¹ã‚­ãƒ¼ãƒã®å‹å®šç¾©ã‚’ç¢ºèª

shared/schema.ts ã§å‹ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### 3. Zodã‚¹ã‚­ãƒ¼ãƒã®æ›´æ–°

æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸå ´åˆã€Zodã‚¹ã‚­ãƒ¼ãƒã‚‚æ›´æ–°ã™ã‚‹

---

## å‚è€ƒè³‡æ–™

### ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆè³‡æ–™
- [å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](./implementation-roadmap.md) - å…¨ä½“ã®å®Ÿè£…è¨ˆç”»
- [ç‚¹æ•°è¨ˆç®—ã®ä»•çµ„ã¿](./ç‚¹æ•°è¨ˆç®—ã®ä»•çµ„ã¿.md) - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
- [shared/schema.ts](../shared/schema.ts) - Drizzleã‚¹ã‚­ãƒ¼ãƒå®šç¾©

### è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³
- [server/bonus-engine.ts](../server/bonus-engine.ts) - åŠ ç®—è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ1001è¡Œï¼‰

### APIå®Ÿè£…
- [server/routes.ts](../server/routes.ts) - REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- `client/src/components/BonusMasterManagement.tsx` - åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢
- `client/src/components/NursingRecords.tsx` - è¨ªå•è¨˜éŒ²ç®¡ç†
- `client/src/components/PatientForm.tsx` - æ‚£è€…æƒ…å ±ç·¨é›†

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-02
**ä½œæˆè€…**: Claude Code
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
