# 重複データ解消の影響分析結果

## 📋 分析結果のサマリー

### 重複データの状況

- **重複組み合わせ数**: 16件
- **重複レコード総数**: 57件
- **削除されるレコード数**: 41件（最新のレコードを残して古いレコードを削除）

### 重要な発見

1. **calculated_pointsは全て同じ**
   - 重複データの中で`calculated_points`が異なる組み合わせは存在しません
   - どのレコードを残しても点数に影響はありません

2. **service_code_idは全てNULL**
   - 全てのレコードで`service_code_id`がNULL
   - 削除時に`service_code_id`を考慮する必要はありません

3. **関連する訪問記録**
   - 重複データに関連する訪問記録: 14件
   - 訪問記録のステータス: draft または completed

4. **関連する月次レセプト**
   - 重複データに関連する月次レセプト: 18件
   - 全て2025年10月のレセプト

## ✅ 本番運用への影響

### 1. データの整合性

**影響**: なし

- 各訪問記録と加算マスタの組み合わせについて、最新のレコードが1件残ります
- データの整合性は保たれます
- `calculated_points`が全て同じため、どのレコードを残しても点数に影響はありません

### 2. アプリケーションの動作

**影響**: なし

- 重複データが存在する場合、アプリケーションは最新のレコードを使用する想定です
- 古いレコードを削除しても、最新のレコードが残るため動作に影響はありません
- むしろ、重複データを解消することで、アプリケーションの動作がより明確になります

### 3. 月次レセプトへの影響

**影響**: なし

- 関連する月次レセプトが18件存在しますが、全て2025年10月のレセプトです
- 最新のレコードが残るため、レセプト計算には影響ありません
- `calculated_points`が全て同じため、どのレコードを残してもレセプトの点数は変わりません

### 4. ユニークインデックスの追加

**影響**: プラス

- 重複データを解消することで、ユニークインデックスを追加できます
- 今後、同じ組み合わせの重複データが作成されることを防げます
- データの整合性が向上します

## 📊 重複データの発生原因の推測

重複データの`created_at`を見ると、短時間の間に複数回作成されていることがわかります。これは以下のような原因が考えられます：

1. **加算の再計算**
   - 訪問記録の編集や加算マスタの更新時に、加算が再計算され、新しいレコードが作成された
   - 古いレコードが削除されずに残った

2. **アプリケーションのバグ**
   - 重複チェックが機能していなかった
   - ユニークインデックスが存在しないため、重複データが作成された

## ✅ 結論

### 重複データの解消は本番運用に問題ありません

**理由**:

1. **データの整合性**: 最新のレコードが残るため、データの整合性は保たれます
2. **点数への影響**: `calculated_points`が全て同じため、どのレコードを残しても点数に影響はありません
3. **アプリケーションの動作**: 最新のレコードが残るため、動作に影響はありません
4. **月次レセプト**: 最新のレコードが残るため、レセプト計算には影響ありません
5. **今後の改善**: ユニークインデックスを追加することで、今後重複データが作成されることを防げます

### 推奨事項

1. **バックアップの取得**: 削除を実行する前に、必ずバックアップを取得してください
2. **最新のレコードを残す**: 各重複組み合わせについて、`created_at`が最新のレコードを残す方針で問題ありません
3. **削除後の確認**: 削除後、重複データが0件であることを確認してください
4. **ユニークインデックスの追加**: 重複データを解消した後、Replitからの再デプロイを実行してユニークインデックスを追加してください

## 📋 実行チェックリスト

- [ ] バックアップを取得
- [ ] 重複データの解消を実行
- [ ] 解消後の確認を実行（重複データが0件であることを確認）
- [ ] データの整合性を確認
- [ ] Replitからの再デプロイを実行（ユニークインデックスが追加される）

## 📄 関連ドキュメント

- [重複データ解消手順書](./duplicate-bonus-history-cleanup.md)
- [サービスコードマスタ移行計画](./migration-plan-service-codes-final.md)

