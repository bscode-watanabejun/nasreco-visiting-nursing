# システム管理者ガイド

このドキュメントでは、システム管理者（開発ベンダー）用の企業管理機能の使用方法を説明します。

## 目次

1. [概要](#概要)
2. [ログイン方法](#ログイン方法)
3. [企業管理機能](#企業管理機能)
4. [よくある質問](#よくある質問)
5. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### システム管理者とは

**システム管理者** (`system_admin`) は、開発ベンダー専用の最上位権限を持つロールです。

**権限:**
- 全企業の閲覧・管理
- 新規企業の作成（本社施設・初期管理者も同時作成）
- 既存企業の編集・削除
- 企業統計情報の閲覧

**顧客との違い:**
- 顧客の企業管理者 (`corporate_admin`) は自社の施設管理のみ可能
- システム管理者は全企業を横断的に管理可能
- システム管理者専用の管理画面にアクセス可能

---

## ログイン方法

### 初期システム管理者アカウント

実装時に自動作成されたアカウント情報：

```
ユーザー名: system_admin
メールアドレス: nasreco-visit-system@bscode.co.jp
パスワード: smallbig9876
```

### ログイン手順

1. **ログイン画面にアクセス**
   ```
   https://your-domain.com/login
   ```
   または任意のURLにアクセス（自動的にログイン画面にリダイレクト）

2. **クレデンシャルを入力**
   - ユーザー名: `system_admin`
   - パスワード: 初期パスワードまたは変更後のパスワード

3. **ログイン成功後**
   - 自動的に `/system-admin/companies` にリダイレクトされます
   - 企業管理画面が表示されます

### 初回ログイン時の注意

- `must_change_password` フラグが `true` に設定されているため、初回ログイン時にパスワード変更が要求されます
- セキュリティのため、必ず強力なパスワードに変更してください

---

## 企業管理機能

### 企業一覧画面 (`/system-admin/companies`)

#### 表示内容

各企業カードには以下の情報が表示されます：

- 企業名
- URLスラッグ（例: `/shakenfuku`）
- 住所、電話番号、メールアドレス
- 本社ログインURL（コピー可能）

#### 利用可能な操作

1. **詳細表示**（目アイコン）
   - 企業の詳細情報を表示
   - 施設一覧
   - 統計情報（施設数、ユーザー数、利用者数）

2. **編集**（鉛筆アイコン）
   - 企業の基本情報を編集
   - URLスラッグ変更時は警告を表示

3. **削除**（ゴミ箱アイコン）
   - 企業を削除（施設が存在する場合は削除不可）
   - 確認ダイアログで再確認

---

### 新規企業作成

#### 手順

1. **「新規企業作成」ボタンをクリック**

2. **企業情報を入力**
   - 企業名 *（必須）
   - URLスラッグ *（必須・自動生成、手動修正可）
   - 住所
   - 電話番号
   - メールアドレス

3. **本社施設情報を入力**
   - 施設名 *（必須・自動生成: `{企業名}本社`）
   - 施設スラッグ（デフォルト: `headquarters`）
   - 住所（企業と同じ場合は省略可）
   - 電話番号、メール（企業と同じ場合は省略可）

4. **初期管理者情報を入力**
   - ユーザー名 *（必須・自動生成: `{企業スラッグ}_admin`）
   - メールアドレス *（必須）
   - フルネーム *（必須）
   - パスワード *（必須・自動生成可能）
   - 電話番号

5. **「作成」ボタンをクリック**

#### 作成後の確認

作成成功後、以下の情報がトースト通知で表示されます：

- 企業名
- ログインURL（例: `/shakenfuku/headquarters/login`）
- 管理者ユーザー名

この情報を顧客に提供してください。

#### 自動生成機能

- **企業スラッグ**: 企業名から自動生成（英数字・ハイフン）
- **施設名**: `{企業名}本社` として自動生成
- **管理者ユーザー名**: `{企業スラッグ}_admin` として自動生成
- **パスワード**: 「自動生成」ボタンで12文字のランダムパスワード生成

---

### 企業編集

#### 手順

1. **企業カードの「編集」ボタンをクリック**

2. **編集フォームで情報を修正**
   - 企業名
   - URLスラッグ（⚠️ 変更時は警告）
   - 住所
   - 電話番号
   - メールアドレス

3. **「更新」ボタンをクリック**

#### URLスラッグ変更時の警告

URLスラッグを変更すると、以下の警告ダイアログが表示されます：

```
⚠️ 稼働中の企業のURLを変更すると、全施設に影響があります

影響:
- 全施設のURLが変更されます
- 既存のブックマークURLが無効になります
- 全ユーザーが影響を受けます
```

**推奨対応:**
- 事前に顧客に周知
- 業務時間外に変更
- 変更後、全ユーザーに再ログイン依頼

---

### 企業削除

#### 手順

1. **企業カードの「削除」ボタンをクリック**

2. **警告ダイアログを確認**
   - 削除されるデータの詳細を確認
   - 復元できないことを理解

3. **「完全に削除する」ボタンをクリック**

#### 削除の制限

以下の場合は削除できません：

- **アクティブな本社以外の施設が存在する企業**
  - エラーメッセージ: 「本社以外のアクティブな施設が存在する企業は削除できません」
  - 対応: 先に施設管理から施設を削除（論理削除）してから企業を削除
  - **注意**: 論理削除済みの施設は自動的に物理削除されます

- **SYSTEM企業**
  - 内部的な企業のため削除不可
  - UI上では表示されない

#### 削除されるデータ

企業削除時、以下のデータが**完全に削除**されます（復元不可）：

- 本社を含むすべての施設（論理削除済みも含む）
- すべてのユーザーアカウント
- すべての利用者データと看護記録
- スケジュール、契約、レセプトなどすべての業務データ

---

### 企業詳細表示

#### 表示内容

1. **基本情報**
   - URLスラッグ
   - 登録日

2. **統計情報**
   - 施設数
   - ユーザー数（全施設の合計）
   - 利用者数（全施設の合計）

3. **施設一覧**
   - 施設名
   - 施設スラッグ
   - 本社フラグ

---

## よくある質問

### Q1. システム管理者を追加したい

**A.** データベース直接操作が必要です。以下の手順で追加してください：

```sql
-- パスワードハッシュを生成（Node.js）
node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('YOUR_PASSWORD', 10));"

-- ユーザーを追加
INSERT INTO users (
  facility_id, username, password, email, full_name,
  role, access_level, is_active, must_change_password
)
VALUES (
  '00000000-0000-0000-0000-000000000002',  -- SYSTEM施設のID
  'new_admin',
  '$2b$10$...',  -- 上記で生成したハッシュ
  'new-admin@bscode.co.jp',
  '新システム管理者',
  'system_admin',
  'corporate',
  true,
  true
);
```

### Q2. 企業スラッグの命名規則は？

**A.** 以下のルールに従ってください：

- ✅ 英数字とハイフン (`-`) のみ使用可能
- ✅ 小文字推奨
- ✅ 短く分かりやすい名前
- ❌ スペース、アンダースコア、特殊文字は不可
- ❌ 既存企業と重複不可

**良い例:**
- `tokai`, `shakenfuku`, `medical-care-group`

**悪い例:**
- `tokai group` (スペース含む)
- `東海` (日本語)
- `tokai_group` (アンダースコア)

### Q3. 顧客に提供すべき情報は？

**A.** 企業作成後、以下の情報を顧客に提供してください：

1. **ログインURL**
   ```
   https://your-domain.com/{companySlug}/headquarters/login
   ```

2. **管理者クレデンシャル**
   ```
   ユーザー名: {companySlug}_admin
   パスワード: {作成時に設定したパスワード}
   ```

3. **初回ログイン手順**
   - 上記URLにアクセス
   - クレデンシャルでログイン
   - パスワード変更（初回ログイン時）
   - 本社ダッシュボードが表示される

### Q4. SYSTEM企業・施設とは？

**A.** システム管理者が所属するための特別な企業・施設です。

- **目的**: システム管理者ユーザーは `facilityId` が必須のため、技術的に必要
- **特徴**:
  - 顧客向けUIには表示されない
  - 削除・編集不可
  - URLは存在するがアクセスしない（`/system/system`）
- **運用**: システム管理者は `/system-admin/companies` にアクセス

---

## トラブルシューティング

### 問題: ログインできない

**原因と対処:**

1. **パスワードが間違っている**
   - 初期パスワード: `smallbig9876`（変更済みの場合は新しいパスワード）
   - パスワード変更した場合は、新しいパスワードを使用

2. **ユーザーが無効化されている**
   ```sql
   -- ユーザーの状態を確認
   SELECT username, is_active FROM users WHERE username = 'system_admin';

   -- 無効化されている場合、有効化
   UPDATE users SET is_active = true WHERE username = 'system_admin';
   ```

3. **セッションエラー**
   - ブラウザのキャッシュをクリア
   - シークレットモードで再試行

### 問題: ログイン後にエラー画面が表示される

**原因と対処:**

1. **SYSTEM施設が存在しない**
   - SYSTEM企業・施設が正しくセットアップされていない可能性
   - 開発チームに連絡してください

2. **権限不足エラー**
   - ロールが `system_admin` でない場合は開発チームに連絡
   - データベース直接操作が必要な場合があります

### 問題: 企業作成時にエラーが発生する

**原因と対処:**

1. **スラッグの重複**
   - エラー: 「この企業スラッグは既に使用されています」
   - 対処: 別のスラッグを使用

2. **ユーザー名の重複**
   - エラー: 「このユーザー名は既に使用されています」
   - 対処: 別のユーザー名を使用（自動生成されたものを手動修正）

3. **必須項目の入力漏れ**
   - エラー: 「必須項目が入力されていません」
   - 対処: * マークの付いた項目をすべて入力

### 問題: 企業削除ができない

**原因と対処:**

1. **アクティブな施設が存在する**
   - エラー: 「本社以外のアクティブな施設が存在する企業は削除できません」
   - 対処:
     1. 顧客の本社管理画面（施設管理）から本社以外の施設を削除（論理削除）
     2. 論理削除後、企業削除を再度実行
     3. 論理削除済みの施設も自動的に物理削除されます

2. **SYSTEM企業を削除しようとしている**
   - UI上では表示されないため、通常は発生しない

### 問題: 統計情報が表示されない

**原因と対処:**

1. **データベース接続エラー**
   - ブラウザコンソールでエラーを確認
   - `DATABASE_URL` 環境変数を確認

2. **権限エラー**
   - システム管理者以外のユーザーでログインしている
   - 正しいsystem_adminアカウントでログイン

---

## セキュリティに関する注意事項

1. **強力なパスワードを使用**
   - 初期パスワード `smallbig9876` は必ず変更
   - 12文字以上、大文字・小文字・数字・記号を含む

2. **クレデンシャルの管理**
   - システム管理者のパスワードは厳重に管理
   - パスワード管理ツール（1Password、LastPass等）の使用を推奨

3. **顧客へのパスワード提供**
   - 安全な方法で提供（Slack DM、暗号化メール等）
   - 平文でGit、Slackチャンネルに記載しない

4. **定期的なパスワード変更**
   - 3ヶ月ごとにパスワードを変更
   - 退職者がいた場合は即座に変更

---

## 関連ドキュメント

- [パスベースマルチテナント設計書](./PATH_BASED_MULTITENANCY.md)
- [実装ロードマップ](./implementation-roadmap.md)

---

## サポート

問題が解決しない場合は、開発チームに連絡してください。

**連絡先:**
- GitHub Issues: https://github.com/your-repo/issues
- Email: dev-support@bscode.co.jp
