# Replitからの再デプロイ 影響分析レポート

## 📋 実行サマリー

- **デプロイ方法**: Replit Autoscale Deployment
- **デプロイ対象**: mainブランチの現在の状態
- **デプロイプロセス**: `npm run db:push && npm run build` → `npm run start`
- **影響範囲**: 本番環境のデータベースとアプリケーション

## 1. デプロイプロセスの確認

### 1.1 Replitのデプロイ設定

`.replit`ファイルの設定:
```toml
[deployment]
deploymentTarget = "autoscale"
build = ["sh", "-c", "npm run db:push && npm run build"]
run = ["npm", "run", "start"]
```

### 1.2 デプロイ時の実行順序

1. **`npm run db:push`** (drizzle-kit push)
   - データベーススキーマの変更を反映
   - 本番環境のデータベースに直接接続
   - スキーマの差分があれば自動的に変更

2. **`npm run build`**
   - クライアント（Vite）のビルド: `dist/public/`
   - サーバー（esbuild）のビルド: `dist/index.js`
   - テンプレートファイルのコピー

3. **`npm run start`**
   - `NODE_ENV=production node dist/index.js`
   - 本番サーバーの起動

## 2. 本番環境の現状

### 2.1 データベースの状態

| テーブル | データ件数 | 状態 |
|---------|----------|------|
| nursing_service_codes | 21件 | 31から始まる誤ったコード |
| nursing_records | 181件 | 9件がサービスコード設定済み |
| bonus_calculation_history | 164件 | 0件がサービスコード設定済み |
| patients | 25件 | 正常 |
| users | 17件 | 正常 |
| facilities | 10件 | 正常 |
| monthly_receipts | 18件 | 正常 |

### 2.2 スキーマの状態

- **主要テーブル**: すべて存在（32テーブル）
- **外部キー制約**: 62件（サービスコード関連も含む）
- **インデックス**: 主要テーブルに存在

## 3. デプロイ時の影響分析

### 3.1 データベーススキーマ変更のリスク

#### リスクレベル: 中〜高

**潜在的な影響**:
- `db:push`が実行されると、スキーマファイル（`shared/schema.ts`）と本番環境のスキーマの差分があれば自動的に変更される
- テーブルの追加・削除・カラムの変更が発生する可能性
- データの整合性に影響する可能性

**確認事項**:
- [ ] 現在のmainブランチのスキーマと本番環境のスキーマに差分があるか
- [ ] 差分がある場合、どのような変更が発生するか
- [ ] 変更が既存データに影響を与えるか

**推奨対策**:
1. デプロイ前にスキーマの差分を確認
2. バックアップの取得
3. スキーマ変更の影響範囲の確認

### 3.2 ダウンタイムのリスク

#### リスクレベル: 中

**潜在的な影響**:
- ビルド中（約2-5分）はサービスが停止する可能性
- スキーマ変更中はデータベースロックが発生する可能性
- ユーザーがアクセスできない時間が発生

**推奨対策**:
- 業務時間外（夜間または休日）に実行
- ユーザーへの事前通知
- メンテナンス時間の設定

### 3.3 環境変数の確認

#### リスクレベル: 高（設定ミスの場合）

**必須環境変数**:
- `DATABASE_URL`: 本番環境のデータベース接続文字列
- `SESSION_SECRET`: セッション暗号化用シークレット
- `NODE_ENV`: production（自動設定）
- `PORT`: 5000（.replitファイルで設定）

**確認事項**:
- [ ] Replitの環境変数設定で`DATABASE_URL`が正しく設定されているか
- [ ] `SESSION_SECRET`が正しく設定されているか
- [ ] 本番環境のデータベース接続文字列が正しいか

**推奨対策**:
- デプロイ前に環境変数の設定を確認
- 環境変数のバックアップ

### 3.4 アプリケーションコードの変更

#### リスクレベル: 低〜中

**潜在的な影響**:
- mainブランチの最新コードがデプロイされる
- バグ修正や新機能が反映される
- 既存機能への影響の可能性

**確認事項**:
- [ ] mainブランチに重大な変更があるか
- [ ] 既存機能への影響があるか
- [ ] テストが完了しているか

**推奨対策**:
- デプロイ前に変更内容を確認
- テスト環境での動作確認

### 3.5 サービスコードマスタへの影響

#### リスクレベル: 低（別途対応予定）

**現状**:
- 現在、サービスコードマスタの入れ替えを計画中
- デプロイとは別の作業として計画

**推奨対策**:
- デプロイとサービスコードマスタの入れ替えは別々に実行
- デプロイ後にサービスコードマスタの入れ替えを実行

## 4. デプロイ前の確認チェックリスト

### 4.1 データベース関連

- [ ] 本番環境のデータベースバックアップを取得
- [ ] スキーマの差分を確認（`drizzle-kit push --dry-run`相当の確認）
- [ ] データベース接続文字列の確認
- [ ] 外部キー制約の確認

### 4.2 環境変数

- [ ] `DATABASE_URL`の設定確認
- [ ] `SESSION_SECRET`の設定確認
- [ ] `PORT`の設定確認（.replitファイルで5000に設定済み）

### 4.3 アプリケーション

- [ ] mainブランチの最新コードを確認
- [ ] ビルドエラーがないか確認（`npm run check`）
- [ ] テストが完了しているか確認

### 4.4 運用

- [ ] デプロイ時間の決定（業務時間外推奨）
- [ ] ユーザーへの通知（必要に応じて）
- [ ] ロールバック手順の確認

## 5. デプロイ時の実行手順

### 5.1 事前準備

1. **バックアップ取得**
   ```sql
   -- 本番環境のバックアップ（手動実行）
   -- 主要テーブルのバックアップを取得
   ```

2. **スキーマ差分の確認**
   ```bash
   # スキーマファイルと本番環境の差分を確認
   # （drizzle-kitにはdry-runがないため、別の方法で確認）
   ```

3. **環境変数の確認**
   - Replitの環境変数設定を確認
   - `DATABASE_URL`と`SESSION_SECRET`が正しく設定されているか確認

### 5.2 デプロイ実行

1. **Replitでデプロイを実行**
   - Replitのデプロイボタンをクリック
   - デプロイプロセスを監視

2. **デプロイプロセスの監視**
   - `db:push`の実行状況を確認
   - `build`の実行状況を確認
   - エラーの有無を確認

3. **デプロイ後の確認**
   - アプリケーションが正常に起動しているか
   - データベース接続が正常か
   - 主要機能が正常に動作するか

### 5.3 デプロイ後の検証

1. **機能確認**
   - [ ] ログインが正常に動作するか
   - [ ] 訪問記録の表示が正常か
   - [ ] サービスコードの選択が正常か
   - [ ] 月次レセプトの作成が正常か

2. **データ確認**
   - [ ] データベースのデータが正常に表示されるか
   - [ ] スキーマ変更によるデータ不整合がないか

3. **パフォーマンス確認**
   - [ ] レスポンス時間が正常か
   - [ ] エラーログに異常がないか

## 6. リスクと対策

### 6.1 高リスク項目

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| スキーマ変更によるデータ不整合 | 高 | 中 | バックアップ取得、差分確認 |
| 環境変数の設定ミス | 高 | 低 | 事前確認、バックアップ |
| ダウンタイム | 中 | 高 | 業務時間外実行、事前通知 |

### 6.2 中リスク項目

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| ビルドエラー | 中 | 低 | 事前ビルド確認 |
| アプリケーションのバグ | 中 | 低 | テスト環境での確認 |

### 6.3 低リスク項目

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| パフォーマンス低下 | 低 | 低 | モニタリング |

## 7. ロールバック計画

### 7.1 ロールバック条件

以下の場合にロールバックを検討:
- スキーマ変更によるデータ不整合が発生した場合
- アプリケーションが起動しない場合
- 重大なバグが発見された場合
- ユーザーからの重大な報告があった場合

### 7.2 ロールバック手順

1. **データベースのロールバック**
   - バックアップからデータベースを復元

2. **アプリケーションのロールバック**
   - 前のバージョンにデプロイを戻す
   - または、Replitで前のデプロイを再デプロイ

## 8. 推奨実行タイミング

### 8.1 推奨実行時間

- **実行日時**: 業務時間外（夜間または休日）
- **実行時間**: 約10-15分（バックアップ含む）

### 8.2 実行前の確認事項

- [ ] バックアップが正常に取得できているか
- [ ] スキーマの差分が確認できているか
- [ ] 環境変数の設定が確認できているか
- [ ] デプロイ時間が決定しているか

## 9. サービスコードマスタ入れ替えとの関係

### 9.1 実行順序の推奨

1. **まずReplitからの再デプロイを実行**
   - アプリケーションコードの更新
   - スキーマの更新（必要な場合）

2. **その後、サービスコードマスタの入れ替えを実行**
   - サービスコードマスタの更新
   - 訪問記録の参照更新

### 9.2 理由

- デプロイとサービスコードマスタの入れ替えは別々の作業
- デプロイを先に実行することで、最新のコードでサービスコードマスタの入れ替えを実行できる
- 問題が発生した場合の切り分けが容易

## 10. 次のステップ

1. **スキーマ差分の詳細確認**
   - drizzle-kitを使用してスキーマの差分を確認
   - 変更内容の詳細を把握

2. **環境変数の確認**
   - Replitの環境変数設定を確認
   - 必要に応じて設定を更新

3. **デプロイ実行**
   - 承認取得後、計画に従って実行
   - デプロイ後の検証を実施

