# Phase 4 加算計算エンジン テストガイド（テストクリニック版）

## 📋 テスト準備

### 前提条件
- ✅ 加算マスタ: 6件登録済み（全施設共通）
- ✅ テスト患者: 医療保険患者 5名 + 乳幼児 1名
- ✅ ルールエンジン実装完了

### テストユーザー（テストクリニック）
| ユーザー名 | パスワード | 役割 | 施設 |
|----------|----------|------|------|
| `testuser1` | （現在のパスワード） | 看護師 | テストクリニック |

---

## 🧪 テストケース一覧

### 推奨テスト患者
- **山本 太郎** (80歳, 医療保険) - メインテスト用
- **小林 花音** (5歳, 医療保険) - 乳幼児加算テスト用

---

### Test Case 1: 夜間緊急訪問 ⭐⭐⭐

**目的**: 複数加算の同時適用をテスト（緊急訪問 + 夜間加算）

**手順**:
1. サイドメニューから「訪問記録」→「新規作成」をクリック
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-15
   - **記録種別**: 一般ケア
   - **開始時刻**: 19:00
   - **終了時刻**: 20:00
   - **緊急訪問理由**: 「呼吸困難のため緊急訪問」
   - **タイトル**: 夜間緊急訪問
   - **内容**: 呼吸困難の症状あり。酸素吸入を実施。
3. 「保存」ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **5,250点**
  - 基本点数: 500点
  - 緊急訪問看護加算: 2,650点（月14日目まで）
  - 夜間訪問看護加算: 2,100点（18:00-22:00）
- ✅ 画面に「保存しました」等のメッセージが表示される
- ✅ 記録一覧に戻ると、作成した記録が表示される

**確認ポイント**:
- [ ] 算定点数が5,250点と表示されている
- [ ] エラーが発生していない
- [ ] 記録が正常に保存された

---

### Test Case 2: 長時間訪問（95分） ⭐⭐

**目的**: 訪問時間長パターンのテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-16
   - **記録種別**: 創傷ケア
   - **開始時刻**: 10:00
   - **終了時刻**: 11:35（95分）
   - **長時間訪問理由**: 「褥瘡処置のため長時間訪問」
   - **タイトル**: 長時間訪問（褥瘡処置）
   - **内容**: 仙骨部褥瘡の処置を実施。洗浄、軟膏塗布、ドレッシング交換。
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **5,700点**
  - 基本点数: 500点
  - 長時間訪問看護加算: 5,200点（90分以上）

**確認ポイント**:
- [ ] 算定点数が5,700点になっている
- [ ] 訪問時間が95分と計算されている

---

### Test Case 3: 乳幼児訪問（5歳） ⭐⭐

**目的**: 年齢区分パターンのテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 小林 花音（5歳）
   - **訪問日**: 2025-10-15
   - **記録種別**: バイタルサイン測定
   - **開始時刻**: 14:00
   - **終了時刻**: 15:00
   - **タイトル**: 乳幼児定期訪問
   - **内容**: バイタルサイン測定、発達状況確認。特に問題なし。
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **2,000点**
  - 基本点数: 500点
  - 乳幼児加算: 1,500点（6歳未満）

**確認ポイント**:
- [ ] 算定点数が2,000点になっている
- [ ] 患者年齢が5歳と認識されている

---

### Test Case 4: 深夜訪問（23:00） ⭐⭐

**目的**: 時間帯別加算（深夜）のテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-17
   - **記録種別**: 一般ケア
   - **開始時刻**: 23:00
   - **終了時刻**: 23:45
   - **タイトル**: 深夜訪問
   - **内容**: 家族からの連絡により深夜訪問。状態確認を実施。
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **4,700点**
  - 基本点数: 500点
  - 深夜訪問看護加算: 4,200点（22:00-6:00）

**確認ポイント**:
- [ ] 算定点数が4,700点になっている
- [ ] 夜間(2,100点)ではなく深夜(4,200点)が適用されている

---

### Test Case 5: 早朝訪問（7:00） ⭐

**目的**: 時間帯別加算（早朝）のテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-18
   - **記録種別**: バイタルサイン測定
   - **開始時刻**: 07:00
   - **終了時刻**: 08:00
   - **タイトル**: 早朝訪問
   - **内容**: 朝のバイタルチェック。
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **2,600点**
  - 基本点数: 500点
  - 早朝訪問看護加算: 2,100点（6:00-8:00）

**確認ポイント**:
- [ ] 算定点数が2,600点になっている

---

### Test Case 6: 複数名訪問 ⭐

**目的**: 固定点数加算のテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-19
   - **記録種別**: 一般ケア
   - **開始時刻**: 10:00
   - **終了時刻**: 11:00
   - **複数回訪問理由**: 「体位変換のため看護師2名で訪問」
   - **タイトル**: 複数名訪問
   - **内容**: 体位変換、褥瘡予防のため2名で訪問。
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **5,000点**
  - 基本点数: 500点
  - 複数名訪問看護加算: 4,500点

**確認ポイント**:
- [ ] 算定点数が5,000点になっている

---

### Test Case 7: 日中通常訪問（加算なし） ⭐

**目的**: 加算が適用されない通常ケースのテスト

**手順**:
1. 訪問記録作成画面を開く
2. 以下を入力:
   - **患者**: 山本 太郎
   - **訪問日**: 2025-10-20
   - **記録種別**: バイタルサイン測定
   - **開始時刻**: 14:00
   - **終了時刻**: 15:00
   - **タイトル**: 定期訪問
   - **内容**: 通常の定期訪問。バイタル測定。
   - ⚠️ **緊急訪問理由、複数回訪問理由、長時間訪問理由は入力しない**
3. 保存ボタンをクリック

**期待される結果**:
- ✅ 算定点数: **500点**（基本点数のみ）

**確認ポイント**:
- [ ] 算定点数が500点になっている
- [ ] 追加の加算が適用されていない

---

## 🔍 データベース確認方法

### 計算履歴の確認

テスト後、以下のコマンドで計算履歴を確認できます：

```bash
psql "$DATABASE_URL" -c "
SELECT
  nr.visit_date,
  nr.title,
  p.last_name || ' ' || p.first_name as patient_name,
  bm.bonus_name,
  bch.calculated_points,
  bch.applied_version
FROM bonus_calculation_history bch
JOIN nursing_records nr ON bch.nursing_record_id = nr.id
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
JOIN patients p ON nr.patient_id = p.id
WHERE nr.facility_id = 'fac-osaka-branch'
  AND nr.visit_date >= '2025-10-15'
ORDER BY nr.visit_date, nr.created_at;
"
```

### 訪問記録の確認

```bash
psql "$DATABASE_URL" -c "
SELECT
  nr.visit_date,
  nr.title,
  p.last_name || ' ' || p.first_name as patient_name,
  nr.calculated_points,
  EXTRACT(HOUR FROM nr.actual_start_time) || ':' ||
  LPAD(EXTRACT(MINUTE FROM nr.actual_start_time)::text, 2, '0') as start_time
FROM nursing_records nr
JOIN patients p ON nr.patient_id = p.id
WHERE nr.facility_id = 'fac-osaka-branch'
  AND nr.visit_date >= '2025-10-15'
  AND nr.deleted_at IS NULL
ORDER BY nr.visit_date, nr.created_at;
"
```

---

## ✅ テスト完了チェックリスト

### 機能テスト
- [ ] Test Case 1: 夜間緊急訪問（複数加算）- 5,250点
- [ ] Test Case 2: 長時間訪問（90分以上）- 5,700点
- [ ] Test Case 3: 乳幼児訪問（年齢区分）- 2,000点
- [ ] Test Case 4: 深夜訪問（時間帯）- 4,700点
- [ ] Test Case 5: 早朝訪問（時間帯）- 2,600点
- [ ] Test Case 6: 複数名訪問（固定点数）- 5,000点
- [ ] Test Case 7: 通常訪問（加算なし）- 500点

### データ整合性
- [ ] 全ての記録が正常に保存された
- [ ] 算定点数が期待値と一致している
- [ ] エラーが発生していない

---

## 🐛 トラブルシューティング

### 問題: 加算が適用されない

**考えられる原因**:
1. 患者の保険種別が「医療保険」になっていない
2. 必要なフィールド（緊急訪問理由等）が入力されていない
3. 時刻が正しく入力されていない

**確認方法**:
ブラウザの開発者ツール（F12キー）を開き、コンソールタブを確認してください。

### 問題: 点数が想定と違う

開発サーバーのターミナルでログを確認してください。計算の詳細が出力されています。

### 問題: エラーが発生する

以下の情報を控えてください：
- エラーメッセージ
- どのテストケースで発生したか
- 入力した内容

---

## 📊 期待される結果一覧

| テストケース | 基本 | 加算1 | 加算2 | 合計 |
|------------|------|-------|-------|------|
| 1. 夜間緊急訪問 | 500 | 緊急 2650 | 夜間 2100 | **5250** |
| 2. 長時間訪問 | 500 | 長時間 5200 | - | **5700** |
| 3. 乳幼児訪問 | 500 | 乳幼児 1500 | - | **2000** |
| 4. 深夜訪問 | 500 | 深夜 4200 | - | **4700** |
| 5. 早朝訪問 | 500 | 早朝 2100 | - | **2600** |
| 6. 複数名訪問 | 500 | 複数名 4500 | - | **5000** |
| 7. 通常訪問 | 500 | - | - | **500** |

**合計（7訪問）**: 25,750点 = **257,500円**

---

**作成日**: 2025-10-15
**対象施設**: テストクリニック（fac-osaka-branch）
**テストユーザー**: testuser1
**Phase**: 4-2 ルールエンジン実装テスト
