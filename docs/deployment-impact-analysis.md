# 本番環境への再デプロイ影響分析レポート

**実施日**: 2025-11-18
**分析者**: Claude Code
**目的**: Replitから現在のmainブランチを本番環境に再デプロイする前に、開発環境と本番環境のDB差異を確認し、影響を評価する

---

## 🔍 実施した分析

1. **スキーマ構造の比較** - 開発環境と本番環境のテーブル・カラム構造の差異確認
2. **既存データの確認** - 本番環境の「訪問看護ステーションソレア春日部」のデータ保全確認
3. **マスタデータの確認** - スキーマファイルから新機能の詳細を確認

---

## ⚠️ 主要な差異まとめ

### 1. テーブルレベルの差異

| 項目 | 開発環境 | 本番環境 | 差異 |
|------|----------|----------|------|
| テーブル数 | 33個 | 32個 | **開発環境のみに1個** |

**開発環境のみに存在するテーブル:**
- `visit_location_changes` (訪問場所変更履歴テーブル)

### 2. カラムレベルの差異

#### 2.1 `insurance_cards` テーブル
**開発環境のみに存在するカラム:**
- `partial_burden_category` (varchar) - 一部負担金区分（別表7）

#### 2.2 `nursing_records` テーブル
**開発環境のみに存在するカラム:**
- `visit_location_custom` (text) - 訪問場所詳細（場所コード99の場合）
- `is_service_end` (boolean) - 今回で訪問終了フラグ
- `service_end_reason_code` (varchar) - 訪問終了状況コード（別表15）
- `service_end_reason_text` (text) - 訪問終了状況文字データ（コード99の場合）

#### 2.3 `patients` テーブル
**開発環境のみに存在するカラム:**
- `death_time` (varchar) - 死亡時刻（HHMM形式）
- `death_place_code` (varchar) - 死亡場所コード（別表16）
- `death_place_text` (text) - 死亡場所文字データ（コード99の場合）

**本番環境のみに存在するカラム（削除予定）:**
- `death_location` (varchar) - 旧フィールド、`death_place_code`に置き換え

---

## 📊 本番環境の既存データ状況

### テナント情報
- **総施設数**: 10施設
- **運用中の重要施設**: 訪問看護ステーションソレア春日部 (ID: `2d4562ce-1aae-4d79-80ec-0b128654e466`)

### データ件数（本番環境）
| テーブル | 件数 | 備考 |
|----------|------|------|
| users | 17名 | ソレア春日部: 5名のユーザー |
| patients | 26名 | ソレア春日部: 4名の患者 |
| nursing_records | 196件 | 最新記録: 2025-11-18 (4件) |
| care_plans | 13件 | 直近計画: 2025-11-07作成 |
| schedules | 106件 | アクティブなスケジュールあり |
| monthly_receipts | 18件 | 2025年10月分のレセプト |
| insurance_cards | 20件 | 医療保険11件、介護保険9件 |
| bonus_calculation_history | 130件 | 加算計算履歴 |
| nursing_service_codes | 1,296件 | サービスコードマスタ |

### ソレア春日部の主要ユーザー
1. 宮川　昂輝 (nurse)
2. 永井　秀憲 (admin)
3. ソレア春日部管理者 (admin)
4. BSCode管理者(ソレア春日部) (admin)

### ソレア春日部の患者
1. 祓川 チカ
2. 小川 照子
3. 新井 清
4. 難波 衛彦

---

## 🚨 再デプロイ時の影響評価

### 高リスク（要対応）

#### 1. **スキーマ変更によるデータ互換性の問題**
**問題点:**
- 本番環境に新しいテーブル(`visit_location_changes`)とカラムが存在しない
- アプリケーションコードが新しいカラムを参照する場合、エラーが発生

**影響:**
- `nursing_records`の訪問終了情報の保存エラー
- `patients`の死亡情報の詳細記録エラー
- `insurance_cards`の一部負担金区分の保存エラー
- 訪問場所変更履歴の記録エラー

**対策:**
```bash
# 本番環境でスキーマを更新（必須）
DATABASE_URL="postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require" npm run db:push
```

#### 2. **`patients.death_location` カラムの廃止**
**問題点:**
- 本番環境に`death_location`カラムが存在するが、開発環境では削除済み
- 既存データに`death_location`を使用している患者がいる可能性

**対策:**
- `npm run db:push`実行前に、`death_location`のデータを確認
- データが存在する場合は、`death_place_code`へマイグレーション

### 中リスク（要注意）

#### 3. **新機能の利用状況**
**追加された主要機能:**
- RJレコード対応（訪問終了、訪問場所変更履歴、死亡詳細）
- 医療保険レセプトCSV出力機能の強化
- 一部負担金区分の管理

**影響:**
- これらの新機能を使用しない限り、既存機能は影響なし
- ただし、フロントエンドUIが新フィールドを参照している場合はエラーの可能性

### 低リスク（影響軽微）

#### 4. **マスタデータの差異**
**確認結果:**
- `nursing_service_codes`: 本番1,296件 vs 開発1,275件 (差分+21件)
- `bonus_master`: 本番55件 vs 開発54件 (差分+1件)

**評価:**
- マスタデータは施設ごとに管理されているため、既存データへの影響は軽微
- 開発環境のマスタが更新されている場合、本番にも反映される

---

## ✅ 再デプロイ前の必須チェックリスト

### 1. スキーママイグレーション（必須）
```bash
# 本番環境でスキーマ更新を実行
DATABASE_URL="postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require" npm run db:push
```

**実行タイミング**: デプロイ前（または同時）
**重要度**: 🔴 最高（実行しないとアプリケーションエラー発生）

### 2. `death_location`カラムのデータ確認とマイグレーション
```sql
-- 本番環境で確認
SELECT id, last_name, first_name, death_date, death_location
FROM patients
WHERE death_location IS NOT NULL;
```

**実行タイミング**: スキーマ更新前
**重要度**: 🟡 中（データ損失防止）

### 3. バックアップ取得
```bash
# 本番環境のバックアップ（Replitで実施）
# または Neon の Point-in-Time Restore が有効か確認
```

**実行タイミング**: 作業開始前
**重要度**: 🔴 最高（万が一の復旧用）

### 4. デプロイ後の動作確認
**確認項目:**
- [ ] ログイン機能（ソレア春日部のユーザーでログイン）
- [ ] 患者一覧の表示
- [ ] 看護記録の作成・表示
- [ ] スケジュール表示
- [ ] レセプトデータの表示

**実行タイミング**: デプロイ直後
**重要度**: 🔴 最高（本番運用への影響確認）

---

## 📝 推奨デプロイ手順

### ステップ1: 事前準備
1. 本番環境のバックアップ確認
2. `death_location`データの確認とマイグレーションスクリプト準備
3. メンテナンス時間の設定（可能であれば）

### ステップ2: スキーマ更新
```bash
# 本番環境でスキーマを更新
DATABASE_URL="postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require" npm run db:push
```

### ステップ3: アプリケーションデプロイ
1. Replitからmainブランチをデプロイ
2. 環境変数の確認（`DATABASE_URL`、`SESSION_SECRET`等）
3. ビルドとサーバー起動

### ステップ4: 動作確認
1. ソレア春日部のユーザーでログイン確認
2. 患者データの表示確認
3. 看護記録の作成・表示確認
4. エラーログの確認

### ステップ5: 監視
- 初日: 頻繁にエラーログを確認
- 1週間: 定期的な動作確認

---

## 🎯 結論

### 再デプロイの可否
**✅ 再デプロイ可能** - ただし、以下の条件を満たす必要があります:

1. **必須**: 本番環境で`npm run db:push`を実行してスキーマを更新
2. **推奨**: `death_location`データの確認とマイグレーション
3. **必須**: デプロイ後の動作確認

### リスクレベル
- **スキーマ更新なし**: 🔴 高リスク（アプリケーションエラー発生）
- **スキーマ更新あり**: 🟢 低リスク（新機能は問題なく動作）

### データ保護
本番環境の「訪問看護ステーションソレア春日部」のデータは以下の通り保護されます:
- ✅ ユーザーデータ: 影響なし（カラム追加のみ）
- ✅ 患者データ: 影響なし（カラム追加のみ、`death_location`は要マイグレーション）
- ✅ 看護記録: 影響なし（カラム追加のみ）
- ✅ スケジュール: 影響なし
- ✅ レセプト: 影響なし（カラム追加のみ）

---

## 📞 サポート

問題が発生した場合:
1. エラーログを確認（`server/index.ts`のログ出力）
2. Neonのコンソールでクエリログを確認
3. 必要に応じてPoint-in-Time Restoreでロールバック

---

**このレポートは自動生成されました**
分析スクリプト: [scripts/compare-db-schemas.ts](../scripts/compare-db-schemas.ts), [scripts/check-production-data.ts](../scripts/check-production-data.ts)
