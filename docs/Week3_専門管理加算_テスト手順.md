# Week 3: 専門管理加算テスト手順書

## 📋 テスト概要

専門管理加算の実装をテストします。以下の3つのシナリオを検証します：

1. **テストケース1**: 医療保険 + 緩和ケア（専門資格あり）→ 2,500点加算
2. **テストケース2**: 介護保険 + 褥瘡ケア（専門資格あり）→ 250点加算
3. **テストケース3**: 専門資格なし → 加算適用されない

---

## 🔧 事前準備（完了済み）

### テストデータの作成

以下のテストデータをデータベースに作成済みです：

#### 看護師データ
- **佐藤 次郎**（専門資格あり）
  - ID: `4f9a1e1b-7415-4798-9383-1b471a25cfb8`
  - 専門資格: `["緩和ケア", "褥瘡ケア"]`
  - 施設: `fac-osaka-branch`

- **田中 次郎**（専門資格なし）
  - ID: `be5a4eb5-23be-4da3-8155-8dee9f48c8f6`
  - 専門資格: なし
  - 施設: `fac-osaka-branch`

#### 訪問記録データ
| Record ID | 訪問日 | 看護師 | ケア種類 | 保険種別 |
|-----------|--------|--------|----------|----------|
| test-specialist-medical-001 | 2025-10-15 | 佐藤次郎（専門資格あり） | palliative_care（緩和ケア） | medical |
| test-specialist-care-001 | 2025-10-20 | 佐藤次郎（専門資格あり） | pressure_ulcer（褥瘡ケア） | care |
| test-no-specialist-001 | 2025-10-25 | 田中次郎（専門資格なし） | palliative_care（緩和ケア） | medical |

---

## 🧪 テスト手順

### 1. 訪問看護記録画面を開く

1. ブラウザでアプリにログイン
2. サイドバーから「訪問看護記録」を選択

### 2. テストケース1の実行（医療保険 + 緩和ケア）

#### 手順：
1. 訪問記録一覧で「専門管理加算テスト（医療・緩和ケア）」を検索または探す
   - 訪問日: 2025-10-15
   - タイトル: 「専門管理加算テスト（医療・緩和ケア）」

2. 該当記録を開く（編集ボタンをクリック）

3. フォーム内容を確認：
   - 看護師: **佐藤 次郎**
   - 専門的ケアの種類: **緩和ケア** にチェックが入っている
   - 訪問時間: 10:00 - 11:00（60分）

4. 「保存」ボタンをクリック

5. 保存後、記録の詳細画面で **適用加算** を確認

#### 期待される結果：
```
✅ 適用加算に「専門管理加算」が表示される
✅ 加算点数: 2,500点
✅ 算定条件:
   - 専門研修を受けた看護師が訪問
   - 専門分野のケアを実施（緩和ケア）
   - 月1回まで算定可能
```

---

### 3. テストケース2の実行（介護保険 + 褥瘡ケア）

#### 手順：
1. 訪問記録一覧で「専門管理加算テスト（介護・褥瘡ケア）」を検索または探す
   - 訪問日: 2025-10-20
   - タイトル: 「専門管理加算テスト（介護・褥瘡ケア）」

2. 該当記録を開く

3. フォーム内容を確認：
   - 看護師: **佐藤 次郎**
   - 専門的ケアの種類: **褥瘡ケア** にチェックが入っている
   - 訪問時間: 14:00 - 15:00（60分）

4. **重要**: 患者の保険種別が **介護保険** になっていることを確認
   - もし医療保険の場合は、患者情報を編集して介護保険に変更してください

5. 「保存」ボタンをクリック

6. 保存後、記録の詳細画面で **適用加算** を確認

#### 期待される結果：
```
✅ 適用加算に「専門管理加算（介護保険）」が表示される
✅ 加算点数: 250点（介護保険は単位が異なる）
✅ 算定条件:
   - 専門研修を受けた看護師が訪問
   - 専門分野のケアを実施（褥瘡ケア）
   - 月1回まで算定可能
```

---

### 4. テストケース3の実行（専門資格なし）

#### 手順：
1. 訪問記録一覧で「専門管理加算テスト（資格なし）」を検索または探す
   - 訪問日: 2025-10-25
   - タイトル: 「専門管理加算テスト（資格なし）」

2. 該当記録を開く

3. フォーム内容を確認：
   - 看護師: **田中 次郎**（専門資格なし）
   - 専門的ケアの種類: **緩和ケア** にチェックが入っている
   - 訪問時間: 10:00 - 11:00（60分）

4. 「保存」ボタンをクリック

5. 保存後、記録の詳細画面で **適用加算** を確認

#### 期待される結果：
```
✅ 適用加算に「専門管理加算」は表示されない
✅ 専門資格を持っていない看護師のため、加算は適用されない
✅ 基本訪問看護療養費のみが計上される
```

---

## 🔍 データベースでの検証（オプション）

テスト後、以下のSQLで加算計算履歴を確認できます：

```sql
-- テストケース1の加算計算履歴を確認
SELECT
  bch.id,
  bm.bonus_code,
  bm.bonus_name,
  bch.calculated_points,
  bch.calculation_details
FROM bonus_calculation_history bch
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
WHERE bch.nursing_record_id = 'test-specialist-medical-001'
ORDER BY bch.created_at;

-- テストケース2の加算計算履歴を確認
SELECT
  bch.id,
  bm.bonus_code,
  bm.bonus_name,
  bch.calculated_points,
  bch.calculation_details
FROM bonus_calculation_history bch
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
WHERE bch.nursing_record_id = 'test-specialist-care-001'
ORDER BY bch.created_at;

-- テストケース3の加算計算履歴を確認（何も表示されないはず）
SELECT
  bch.id,
  bm.bonus_code,
  bm.bonus_name,
  bch.calculated_points,
  bch.calculation_details
FROM bonus_calculation_history bch
JOIN bonus_master bm ON bch.bonus_master_id = bm.id
WHERE bch.nursing_record_id = 'test-no-specialist-001'
ORDER BY bch.created_at;
```

---

## 📊 テストチェックリスト

### テストケース1: 医療保険 + 緩和ケア
- [ ] 訪問記録を開けた
- [ ] 佐藤次郎看護師が選択されている
- [ ] 緩和ケアにチェックが入っている
- [ ] 保存が成功した
- [ ] 専門管理加算（2,500点）が適用された
- [ ] 計算詳細に条件が表示されている

### テストケース2: 介護保険 + 褥瘡ケア
- [ ] 訪問記録を開けた
- [ ] 佐藤次郎看護師が選択されている
- [ ] 褥瘡ケアにチェックが入っている
- [ ] 患者が介護保険になっている
- [ ] 保存が成功した
- [ ] 専門管理加算（介護保険）（250点）が適用された
- [ ] 計算詳細に条件が表示されている

### テストケース3: 専門資格なし
- [ ] 訪問記録を開けた
- [ ] 田中次郎看護師が選択されている
- [ ] 緩和ケアにチェックが入っている
- [ ] 保存が成功した
- [ ] 専門管理加算が適用されなかった（期待通り）
- [ ] 基本訪問看護療養費のみが計上された

---

## 🐛 トラブルシューティング

### 問題1: 訪問記録が見つからない
**対処法**:
```sql
-- データベースで直接確認
SELECT id, visit_date, title, status
FROM nursing_records
WHERE id IN ('test-specialist-medical-001', 'test-specialist-care-001', 'test-no-specialist-001');
```

### 問題2: 専門的ケアの選択肢が表示されない
**原因**: フロントエンドの実装が反映されていない可能性
**対処法**:
1. ブラウザのキャッシュをクリア
2. ページをリロード（Ctrl+F5 または Cmd+Shift+R）
3. 開発サーバーを再起動

### 問題3: 加算が適用されない
**確認ポイント**:
1. 看護師の専門資格が正しく設定されているか
   ```sql
   SELECT id, full_name, specialist_certifications
   FROM users
   WHERE id = '4f9a1e1b-7415-4798-9383-1b471a25cfb8';
   ```
2. 訪問記録の`specialist_care_type`が正しく保存されているか
   ```sql
   SELECT id, specialist_care_type, nurse_id
   FROM nursing_records
   WHERE id = 'test-specialist-medical-001';
   ```
3. 加算マスタの`predefined_conditions`が正しく設定されているか
   ```sql
   SELECT bonus_code, bonus_name, predefined_conditions, is_active
   FROM bonus_master
   WHERE bonus_code IN ('specialist_management', 'care_specialist_management');
   ```

---

## 📝 テスト結果の記録

テスト実施後、以下の形式で結果を記録してください：

```
テスト実施日時: _______________
テスト実施者: _______________

【テストケース1】
結果: ✅成功 / ❌失敗
適用加算: _______________
点数: _______________
備考: _______________

【テストケース2】
結果: ✅成功 / ❌失敗
適用加算: _______________
点数: _______________
備考: _______________

【テストケース3】
結果: ✅成功 / ❌失敗
適用加算: _______________
点数: _______________
備考: _______________
```

---

## 🎯 次のステップ

テストが成功したら：
1. ✅ Week 3実装完了として記録
2. ✅ 進捗レポート（`/docs/加算実装進捗_2025-10-28.md`）を更新
3. ✅ コミット作成の準備
4. 🚀 Week 4（訪問看護情報提供療養費1）の実装計画

---

**作成日**: 2025-10-31
**対象バージョン**: Week 3実装版
**関連ドキュメント**: `/docs/加算実装進捗_2025-10-28.md`
