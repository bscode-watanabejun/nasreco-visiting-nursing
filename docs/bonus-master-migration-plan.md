# 加算マスタ管理の移行計画書

## 📋 概要

開発環境の加算マスタを本番環境に反映し、開発環境と本番環境の加算マスタ管理を統一します。

## 🔍 現状確認

### 本番環境の状況
- **有効な加算マスタ数**: 55件
  - 医療保険: 29件
  - 介護保険: 26件
- **加算マスタの特性**: 全施設共通（`facility_id = null`）

### 開発環境の状況
- **有効な加算マスタ数**: 31件
  - 医療保険: 19件
  - 介護保険: 12件
- **無効な加算マスタ数**: 23件

### 差分の詳細

#### 1. 本番環境のみ有効な加算マスタ（24件）
開発環境では無効（`is_active = false`）だが、本番環境では有効（`is_active = true`）になっている加算マスタが24件存在します。

**ソレア春日部での使用状況**: 使用されていません ✅

#### 2. 内容が異なる加算マスタ（15件）
同じ`bonus_code`を持つ加算マスタで、内容が異なるものが15件あります。

**主な差分パターン**:
- **点数が10倍違う（10件）**: 開発環境の点数が本番環境の1/10になっている
  - 例: `24h_response_system_basic` - 開発: 652点、本番: 6520点
- **点数タイプが異なる（1件）**: 開発環境は条件分岐、本番環境は固定点数
- **その他（4件）**: `pointsConfig`、`conditionalPattern`などが異なる

**ソレア春日部での使用状況**: 使用されていません ✅

**本番環境全体での使用状況**: 3件が使用中
- `24h_response_system_enhanced` - 24回使用（開発: 680点、本番: 6800点）
- `24h_response_system_basic` - 6回使用（開発: 652点、本番: 6520点）
- `medical_discharge_joint_guidance` - 1回使用（開発: 800点、本番: 8000点）

## ✅ 影響範囲の確認結果

### ソレア春日部への影響
- ✅ **影響なし**: 使用中の加算マスタは開発環境でも有効
- ✅ **影響なし**: 開発環境で無効な加算マスタは使用されていない
- ✅ **影響なし**: 内容が異なる加算マスタも使用されていない

### 他のテナントへの影響
- **テストクリニック**: 111件の使用実績あり
  - 開発環境で無効だが本番環境で有効な加算マスタや、内容が異なる加算マスタが使用されている可能性
- **その他のテナント**: テスト環境として利用されているため、影響は問題なし

## 🔄 移行内容

### フェーズ1: 無効化（24件）
開発環境で無効な加算マスタを本番環境でも無効化します。

**対象**: 24件の加算マスタ
- 医療保険: 10件
- 介護保険: 14件

**操作**: `is_active = false`に更新

### フェーズ2: 内容の更新（15件）
内容が異なる加算マスタを開発環境の値に更新します。

**対象**: 15件の加算マスタ

**更新内容**:
- `fixedPoints`: 点数を開発環境の値に更新（10件）
- `pointsType`: 点数タイプを開発環境の値に更新（1件）
- `conditionalPattern`: 条件分岐パターンを開発環境の値に更新（1件）
- `pointsConfig`: 点数設定を開発環境の値に更新（4件）

**注意**: 既存の計算履歴（`bonus_calculation_history`）は過去のデータとして保持されます。今後は正しい値で計算されます。

## 📝 実行手順

### 1. 事前準備
```bash
# 環境変数を設定
export PRODUCTION_DB_URL="postgresql://neondb_owner:npg_yASiEqWs0rz5@ep-still-water-aeb6ynp2.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require"
export DATABASE_URL="postgresql://neondb_owner:npg_beoRr4gaQ5Dl@ep-polished-scene-a5twqv82.us-east-2.aws.neon.tech/neondb?sslmode=require"
```

### 2. 移行スクリプトの実行
```bash
npx tsx scripts/migrate-bonus-master-to-production.ts
```

### 3. 確認プロンプト
スクリプト実行時に確認プロンプトが表示されます：
- 無効化対象の加算マスタ一覧
- 更新対象の加算マスタ一覧
- 実行内容のサマリー

`yes`と入力すると実行が開始されます。

### 4. 検証
移行後、以下の検証が自動実行されます：
- 有効な加算マスタ数が開発環境と一致するか確認
- 更新内容の確認

## ⚠️ 注意事項

1. **既存の計算履歴への影響**
   - 既存の`bonus_calculation_history`のデータは変更されません
   - 過去の計算結果はそのまま保持されます
   - 今後は正しい値で計算されます

2. **他のテナントへの影響**
   - テスト環境として利用されているテナントへの影響は問題なし
   - 加算マスタは全施設共通のため、すべてのテナントに反映されます

3. **ロールバック**
   - 必要に応じて、開発環境の無効な加算マスタを再度有効化できます
   - 更新内容は`updatedAt`フィールドで追跡可能です

## 📊 期待される結果

移行後:
- **有効な加算マスタ数**: 31件（開発環境と一致）
  - 医療保険: 19件
  - 介護保険: 12件
- **無効な加算マスタ数**: 24件（開発環境で無効なもの）
- **内容の統一**: 開発環境と本番環境の加算マスタ内容が一致

## ✅ 承認

- [ ] 影響範囲の確認完了
- [ ] 移行計画の承認
- [ ] 実行時間の決定
- [ ] バックアップの取得（必要に応じて）

