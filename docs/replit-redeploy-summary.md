# Replitからの再デプロイ 影響調査サマリー

## 📊 調査結果の要約

### デプロイプロセス

Replitのデプロイ設定（`.replit`ファイル）:
```toml
[deployment]
build = ["sh", "-c", "npm run db:push && npm run build"]
run = ["npm", "run", "start"]
```

**実行順序**:
1. `npm run db:push` - データベーススキーマの変更を反映
2. `npm run build` - アプリケーションのビルド
3. `npm run start` - 本番サーバーの起動

### 本番環境の現状

| 項目 | 状態 |
|------|------|
| テーブル数 | 32テーブル（すべて存在） |
| データ件数 | 訪問記録181件、患者25件、ユーザー17件等 |
| サービスコードマスタ | 21件（31から始まる誤ったコード） |
| 外部キー制約 | 62件（正常） |
| スキーマ構造 | 正常 |

### 主要なリスク

#### 🔴 高リスク

1. **データベーススキーマ変更のリスク**
   - `db:push`が実行されると、スキーマの差分があれば自動的に変更される
   - テーブルの追加・削除・カラムの変更が発生する可能性
   - **対策**: デプロイ前にスキーマの差分を確認、バックアップ取得

2. **環境変数の設定ミス**
   - `DATABASE_URL`が正しく設定されていない場合、デプロイが失敗
   - `SESSION_SECRET`が設定されていない場合、アプリケーションが起動しない
   - **対策**: デプロイ前に環境変数の設定を確認

#### 🟡 中リスク

3. **ダウンタイム**
   - ビルド中（約2-5分）はサービスが停止する可能性
   - スキーマ変更中はデータベースロックが発生する可能性
   - **対策**: 業務時間外に実行、ユーザーへの事前通知

#### 🟢 低リスク

4. **アプリケーションコードの変更**
   - mainブランチの最新コードがデプロイされる
   - 既存機能への影響の可能性
   - **対策**: テスト環境での動作確認

### デプロイ前の必須確認事項

1. ✅ **バックアップ取得**
   - 本番環境のデータベースバックアップを取得
   - 特に重要なデータ（patients, users, facilities, nursing_records等）

2. ✅ **スキーマ差分の確認**
   - 現在のmainブランチのスキーマと本番環境のスキーマに差分があるか
   - 差分がある場合、どのような変更が発生するか

3. ✅ **環境変数の確認**
   - `DATABASE_URL`: 本番環境のデータベース接続文字列
   - `SESSION_SECRET`: セッション暗号化用シークレット
   - Replitの環境変数設定を確認

4. ✅ **ビルド確認**
   - `npm run check`で型エラーがないか（✅ 確認済み）
   - `npm run build`でビルドエラーがないか

### 推奨実行タイミング

- **実行日時**: 業務時間外（夜間または休日）
- **実行時間**: 約10-15分（バックアップ含む）
- **実行順序**: デプロイ → サービスコードマスタ入れ替え（別作業）

### サービスコードマスタ入れ替えとの関係

**推奨実行順序**:
1. **まずReplitからの再デプロイを実行**
   - アプリケーションコードの更新
   - スキーマの更新（必要な場合）

2. **その後、サービスコードマスタの入れ替えを実行**
   - サービスコードマスタの更新
   - 訪問記録の参照更新

**理由**:
- デプロイとサービスコードマスタの入れ替えは別々の作業
- デプロイを先に実行することで、最新のコードでサービスコードマスタの入れ替えを実行できる
- 問題が発生した場合の切り分けが容易

## 📋 次のステップ

1. **スキーマ差分の詳細確認**
   - drizzle-kitを使用してスキーマの差分を確認
   - 変更内容の詳細を把握

2. **環境変数の確認**
   - Replitの環境変数設定を確認
   - 必要に応じて設定を更新

3. **デプロイ実行**
   - 承認取得後、計画に従って実行
   - デプロイ後の検証を実施

4. **サービスコードマスタの入れ替え**
   - デプロイ完了後、別途実行
   - 移行スクリプトを使用して実行

## 📄 関連ドキュメント

- [影響分析レポート](./replit-redeploy-impact-analysis.md)
- [デプロイチェックリスト](./replit-redeploy-checklist.md)
- [サービスコードマスタ移行計画](./migration-plan-service-codes-final.md)

