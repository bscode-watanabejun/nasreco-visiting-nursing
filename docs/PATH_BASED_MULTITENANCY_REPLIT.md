# Replitç’°å¢ƒã§ã®ãƒ‘ã‚¹æ–¹å¼ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆä½¿ç”¨ã‚¬ã‚¤ãƒ‰

## ğŸ¯ Replitç’°å¢ƒã§ã®å‹•ä½œ

Replité–‹ç™ºç’°å¢ƒã§ã¯ã€ä»¥ä¸‹ã®ä¸¡æ–¹ã®æ–¹å¼ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™:

### 1. ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ï¼ˆå¾“æ¥é€šã‚Šï¼‰

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®ãƒ«ãƒ¼ãƒˆURLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
https://bc07f228-ff78-4ef1-817b-011bd992cfac-00-1bkf0ouvw4ec.riker.replit.dev/
```

**å‹•ä½œ:**
- âœ… ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… æ—¢å­˜ã®æ©Ÿèƒ½ãŒã™ã¹ã¦å‹•ä½œã™ã‚‹
- âœ… `/patients`, `/users` ãªã©ã®æ—¢çŸ¥ã®ãƒ‘ã‚¹ã¯è‡ªå‹•çš„ã«ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 2. ãƒ‘ã‚¹æ–¹å¼ï¼ˆæ–°è¦ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼‰

ä¼æ¥­ãƒ»æ–½è¨­ã®ã‚¹ãƒ©ãƒƒã‚°ã‚’URLã«å«ã‚ã¦ã‚¢ã‚¯ã‚»ã‚¹:

```
# æ±æµ·ã‚°ãƒ«ãƒ¼ãƒ—æœ¬ç¤¾
https://bc07f228-ff78-4ef1-817b-011bd992cfac-00-1bkf0ouvw4ec.riker.replit.dev/tokai

# ãƒŸãƒ³ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯è¶Šè°·
https://bc07f228-ff78-4ef1-817b-011bd992cfac-00-1bkf0ouvw4ec.riker.replit.dev/tokai/mint-koshigaya

# ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ¬ã‚¸ãƒ‡ãƒ³ã‚¹å¤§å®®
https://bc07f228-ff78-4ef1-817b-011bd992cfac-00-1bkf0ouvw4ec.riker.replit.dev/shakenfuku/royal-omiya
```

## ğŸ” ä»•çµ„ã¿

### ãƒ‘ã‚¹ãƒ†ãƒŠãƒ³ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‹•ä½œ

[server/middleware/path-tenant.ts](../server/middleware/path-tenant.ts) ã¯ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã§å‹•ä½œã—ã¾ã™:

1. **ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶** - ä»¥ä¸‹ã®ãƒ‘ã‚¹ã¯ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºã‚’ã‚¹ã‚­ãƒƒãƒ—:
   - ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹: `/`
   - APIèªè¨¼: `/api/auth/*`
   - é™çš„ãƒ•ã‚¡ã‚¤ãƒ«: `/assets/*`, `/uploads/*`, `/@vite/*`
   - æ—¢çŸ¥ãƒšãƒ¼ã‚¸: `/patients`, `/users`, `/schedules` ãªã©

2. **ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¤œå‡º** - æ—¢çŸ¥ã®ãƒšãƒ¼ã‚¸åãƒªã‚¹ãƒˆ:
   ```typescript
   const knownPages = [
     'patients', 'users', 'records', 'schedules', 'dashboard',
     'settings', 'reports', 'login', 'facilities', 'headquarters',
     // ... ãã®ä»–
   ];
   ```

3. **ãƒ†ãƒŠãƒ³ãƒˆè§£æ±º** - æ—¢çŸ¥ãƒšãƒ¼ã‚¸ã§ãªã„å ´åˆ:
   - ç¬¬1ãƒ‘ãƒ¼ãƒˆ â†’ ä¼æ¥­ã‚¹ãƒ©ãƒƒã‚°ï¼ˆ`tokai`, `shakenfuku`ï¼‰
   - ç¬¬2ãƒ‘ãƒ¼ãƒˆ â†’ æ–½è¨­ã‚¹ãƒ©ãƒƒã‚°ï¼ˆ`mint-koshigaya`, `royal-omiya`ï¼‰

### ãƒ­ã‚°å‡ºåŠ›

é–‹ç™ºç’°å¢ƒã§ã¯è©³ç´°ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™:

```
[PathTenant] Skipping tenant resolution for: /
[PathTenant] Legacy page detected, skipping tenant resolution: /patients
[PathTenant] Looking up company: tokai
[PathTenant] Company resolved: æ±æµ·ã‚°ãƒ«ãƒ¼ãƒ— (tokai)
[PathTenant] Looking up facility: mint-koshigaya in company: æ±æµ·ã‚°ãƒ«ãƒ¼ãƒ—
[PathTenant] Facility resolved: ãƒŸãƒ³ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯è¶Šè°· (mint-koshigaya)
```

## ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã¾ã¨ã‚

### ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ã§ã‚¢ã‚¯ã‚»ã‚¹

```bash
# 1. ãƒ«ãƒ¼ãƒˆURLã‚’é–‹ã
https://<your-replit-url>/

# 2. ãƒ­ã‚°ã‚¤ãƒ³
ãƒ¦ãƒ¼ã‚¶ãƒ¼å: adminï¼ˆã¾ãŸã¯æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password

# 3. é€šå¸¸é€šã‚Šä½¿ç”¨
/patients
/schedules
/users
```

### ãƒ‘ã‚¹æ–¹å¼ã§ã‚¢ã‚¯ã‚»ã‚¹

#### æ–½è¨­ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹

```bash
# 1. æ–½è¨­URLã‚’é–‹ã
https://<your-replit-url>/tokai/mint-koshigaya

# 2. ãƒ­ã‚°ã‚¤ãƒ³
ãƒ¦ãƒ¼ã‚¶ãƒ¼å: nurse.mint.koshigaya
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password123

# 3. æ–½è¨­ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹
/tokai/mint-koshigaya/patients
/tokai/mint-koshigaya/schedules
```

#### æœ¬ç¤¾ç®¡ç†è€…ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹

```bash
# 1. æœ¬ç¤¾URLã‚’é–‹ã
https://<your-replit-url>/tokai

# 2. ãƒ­ã‚°ã‚¤ãƒ³
ãƒ¦ãƒ¼ã‚¶ãƒ¼å: admin.tokai
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password123

# 3. å…¨æ–½è¨­ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
/tokai/mint-koshigaya/patients
/tokai/genki-kamifukuoka/patients
/tokai/mint-minami/patients
```

## ğŸ§ª å‹•ä½œç¢ºèªæ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ã®ç¢ºèª

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§Replitã®URLã‚’é–‹ã
2. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
4. `/patients` ãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ‘ã‚¹æ–¹å¼ã®ç¢ºèª

1. æ–°ã—ã„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
2. `/tokai/mint-koshigaya` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. `nurse.mint.koshigaya` / `password123` ã§ãƒ­ã‚°ã‚¤ãƒ³
5. åˆ©ç”¨è€…ä¸€è¦§ãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ— 3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç¢ºèª

1. æ–½è¨­ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ`nurse.mint.koshigaya`ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³
2. åˆ¥ã®æ–½è¨­ã®URL `/tokai/genki-kamifukuoka/patients` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. `403 Forbidden` ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆæ­£å¸¸å‹•ä½œï¼‰
4. æœ¬ç¤¾ç®¡ç†è€…ï¼ˆ`admin.tokai`ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³
5. ã™ã¹ã¦ã®æ–½è¨­ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**: ãƒ«ãƒ¼ãƒˆURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **: ãƒ‘ã‚¹ãƒ†ãƒŠãƒ³ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
2. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ `[PathTenant]` ã‚’æ¤œç´¢
3. ä»¥ä¸‹ã‚’ç¢ºèª:
   ```bash
   # ãƒ‘ã‚¹ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‹
   [PathTenant] Skipping tenant resolution for: /
   ```

### 404 Company not found

**ç—‡çŠ¶**: `/tokai` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Œä¼æ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼

**åŸå› **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```sql
-- ä¼æ¥­ã‚’ç¢ºèª
SELECT id, name, slug FROM companies;

-- slugãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
-- å¿…è¦ã«å¿œã˜ã¦æ›´æ–°
UPDATE companies SET slug = 'tokai' WHERE name LIKE '%æ±æµ·%';
```

### 404 Facility not found

**ç—‡çŠ¶**: `/tokai/mint-koshigaya` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Œæ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼

**åŸå› **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–½è¨­ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```sql
-- æ–½è¨­ã‚’ç¢ºèª
SELECT f.id, f.name, f.slug, c.slug as company_slug
FROM facilities f
JOIN companies c ON f.company_id = c.id
WHERE c.slug = 'tokai';
```

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒåˆã‚ãªã„

**ç—‡çŠ¶**: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„

**åŸå› **: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```bash
# Node.jsã§æ­£ã—ã„ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆ
node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('password123', 10));"

# å‡ºåŠ›ã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°
# psql $DATABASE_URL
UPDATE users 
SET password = '$2a$10$...' 
WHERE username = 'nurse.mint.koshigaya';
```

## ğŸ“Š ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª

```sql
-- ã™ã¹ã¦ã®ä¼æ¥­ã¨æ–½è¨­ã‚’ç¢ºèª
SELECT 
  c.slug AS company,
  f.slug AS facility,
  f.is_headquarters AS is_hq,
  f.name AS facility_name
FROM companies c
JOIN facilities f ON f.company_id = c.id
ORDER BY c.slug, f.is_headquarters DESC, f.name;
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
```
 company    | facility          | is_hq | facility_name
------------+-------------------+-------+------------------------
 nasreco    | tokyo-main        | t     | æ±äº¬æœ¬é™¢
 nasreco    | test-clinic       | f     | ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯
 shakenfuku | headquarters      | t     | ç¤¾ä¼šç¦ç¥‰ç·åˆç ”ç©¶æ‰€æœ¬ç¤¾
 shakenfuku | mint-iruma        | f     | ãƒŸãƒ³ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯å…¥é–“
 shakenfuku | royal-kazo        | f     | ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ¬ã‚¸ãƒ‡ãƒ³ã‚¹åŠ é ˆ
 shakenfuku | royal-omiya       | f     | ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ¬ã‚¸ãƒ‡ãƒ³ã‚¹å¤§å®®
 tokai      | headquarters      | t     | æ±æµ·ã‚°ãƒ«ãƒ¼ãƒ—æœ¬ç¤¾
 tokai      | genki-kamifukuoka | f     | å…ƒæ°—ã‚¯ãƒªãƒ‹ãƒƒã‚¯ä¸Šç¦å²¡
 tokai      | mint-koshigaya    | f     | ãƒŸãƒ³ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯è¶Šè°·
 tokai      | mint-minami       | f     | ãƒŸãƒ³ãƒˆã‚¯ãƒªãƒ‹ãƒƒã‚¯å—æµ¦å’Œ
```

## ğŸ“ ã¾ã¨ã‚

Replitç’°å¢ƒã§ã¯:

âœ… **ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ã¨ãƒ‘ã‚¹æ–¹å¼ã®ä¸¡ç«‹**
- ãƒ«ãƒ¼ãƒˆURLï¼ˆ`/`ï¼‰â†’ å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
- æ—¢çŸ¥ãƒšãƒ¼ã‚¸ï¼ˆ`/patients`ï¼‰â†’ ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- ãƒ†ãƒŠãƒ³ãƒˆãƒ‘ã‚¹ï¼ˆ`/tokai/mint-koshigaya`ï¼‰â†’ ãƒ‘ã‚¹æ–¹å¼

âœ… **è‡ªå‹•æ¤œå‡º**
- URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è‡ªå‹•çš„ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–¹å¼ã‚’åˆ¤å®š
- é–‹ç™ºè€…ãŒæ„è­˜ã›ãšä¸¡æ–¹å¼ã‚’ä½¿ç”¨å¯èƒ½

âœ… **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“**
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
- ã©ã®ãƒ‘ã‚¹ãŒã©ã®æ–¹å¼ã§å‡¦ç†ã•ã‚ŒãŸã‹æ˜ç¢º

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ã¦ã€ãƒ«ãƒ¼ãƒˆURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¦ãã ã•ã„ï¼
