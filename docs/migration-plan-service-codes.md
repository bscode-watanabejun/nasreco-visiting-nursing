# 本番環境サービスコードマスタ入れ替え 移行計画書

## 1. 移行概要

### 1.1 目的
本番環境の誤ったサービスコードマスタ（31から始まるコード）を、開発環境の正しいサービスコードマスタ（51から始まるコード）に入れ替える。

### 1.2 移行対象
- **サービスコードマスタ**: `nursing_service_codes` テーブル
- **影響を受けるデータ**: 
  - `nursing_records` テーブル（訪問記録）: 9件
  - `bonus_calculation_history` テーブル（加算計算履歴）: 0件

### 1.3 移行スコープ
- ✅ サービスコードマスタの入れ替え
- ✅ 既存の訪問記録のサービスコードID参照の更新
- ✅ 誤ったコードの無効化または削除
- ❌ 月次レセプトの再計算（未作成のため不要）

## 2. 現状分析

### 2.1 本番環境の現状
- **サービスコードマスタ**: 21件（すべて31から始まる誤ったコード）
- **使用されているサービスコードID**: 1件（`a4d94b8d...` → `311000110`）
- **訪問記録で使用**: 9件
- **加算計算履歴で使用**: 0件

### 2.2 開発環境の現状
- **サービスコードマスタ**: 1275件
- **正しいコード（51から始まる）**: 46件
- **マッピング成功**: 18件 / 21件

### 2.3 マッピング結果
| 誤ったコード | 正しいコード | 正しいコードID | 使用状況 |
|------------|------------|--------------|---------|
| 311000110 | 510000110 | f9940fce-d0fb-47f4-a4ee-e06b7e2664a2 | ✅ 9件使用中 |

## 3. 移行手順

### 3.1 事前準備

#### 3.1.1 バックアップ取得
```sql
-- 本番環境のバックアップ（手動実行）
-- 1. サービスコードマスタのバックアップ
CREATE TABLE nursing_service_codes_backup_YYYYMMDD AS 
SELECT * FROM nursing_service_codes;

-- 2. 訪問記録のバックアップ
CREATE TABLE nursing_records_backup_YYYYMMDD AS 
SELECT * FROM nursing_records WHERE service_code_id IS NOT NULL;

-- 3. 加算計算履歴のバックアップ
CREATE TABLE bonus_calculation_history_backup_YYYYMMDD AS 
SELECT * FROM bonus_calculation_history WHERE service_code_id IS NOT NULL;
```

#### 3.1.2 影響範囲の最終確認
- [ ] 訪問記録の件数確認（9件）
- [ ] 患者数の確認（2人）
- [ ] 月次レセプトの未作成確認（0件）
- [ ] 使用されているサービスコードIDの確認（1件）

### 3.2 移行実行手順

#### ステップ1: 開発環境のサービスコードマスタを本番環境にコピー
**目的**: 正しいサービスコードマスタを本番環境に投入

**実行内容**:
1. 開発環境から正しいサービスコードマスタをエクスポート
2. 本番環境にインポート（既存のコードと重複チェック）

**注意事項**:
- 既存のコード（31から始まる）は削除せず、後で無効化
- IDの重複を避けるため、開発環境のIDをそのまま使用

**実行スクリプト**: `scripts/migrate-service-codes-to-production.ts`

#### ステップ2: 既存の訪問記録のサービスコードID参照を更新
**目的**: 誤ったコードIDを正しいコードIDに更新

**実行内容**:
```sql
-- 311000110 のID → 510000110 のID に更新
UPDATE nursing_records
SET service_code_id = 'f9940fce-d0fb-47f4-a4ee-e06b7e2664a2'
WHERE service_code_id = 'a4d94b8d...'; -- 実際のIDに置き換え
```

**影響範囲**:
- 訪問記録: 9件
- 患者: 2人

**実行スクリプト**: `scripts/update-service-code-references.ts`

#### ステップ3: 誤ったコードの無効化
**目的**: 31から始まる誤ったコードを無効化（削除ではなく無効化で履歴保持）

**実行内容**:
```sql
-- 31から始まるコードを無効化
UPDATE nursing_service_codes
SET is_active = false
WHERE service_code LIKE '31%';
```

**注意事項**:
- 削除ではなく無効化を選択（履歴保持のため）
- 外部キー制約により、参照が残っている場合は削除できない

**実行スクリプト**: `scripts/deactivate-wrong-service-codes.ts`

#### ステップ4: データ整合性の確認
**目的**: 移行後のデータ整合性を確認

**確認項目**:
- [ ] 訪問記録のサービスコードIDが正しく更新されているか
- [ ] サービスコードマスタに正しいコードが存在するか
- [ ] 誤ったコードが無効化されているか
- [ ] 外部キー制約が正しく機能しているか

**実行スクリプト**: `scripts/verify-migration.ts`

### 3.3 移行後の検証

#### 3.3.1 データ検証
- [ ] 訪問記録画面でサービスコードが正しく表示されるか
- [ ] サービスコードの名称が正しいか（`510000110` → `訪問看護基本療養費１（保健師、助産師又は看護師による場合（ハを除く。））（週３日目まで）`）
- [ ] 月次レセプト作成時に正しいサービスコードが使用されるか

#### 3.3.2 機能検証
- [ ] 訪問記録の編集が正常に動作するか
- [ ] サービスコードの選択が正常に動作するか
- [ ] レセプトCSV出力が正常に動作するか

## 4. リスク分析と対策

### 4.1 リスク一覧

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| データ移行中のエラー | 高 | 低 | トランザクション使用、バックアップ取得 |
| サービスコードIDの更新漏れ | 中 | 低 | 事前に影響範囲を確認、更新後の検証 |
| 外部キー制約違反 | 高 | 低 | 参照を先に更新してからマスタを更新 |
| 月次レセプトへの影響 | 低 | 低 | 月次レセプト未作成のため影響なし |
| 既存データの不整合 | 中 | 低 | 移行後の整合性チェック |

### 4.2 ロールバック計画

#### 4.2.1 ロールバック手順
1. バックアップテーブルからデータを復元
2. サービスコードマスタを元に戻す
3. 訪問記録のサービスコードIDを元に戻す

#### 4.2.2 ロールバック条件
- データ整合性エラーが発生した場合
- 機能検証で重大な問題が発見された場合
- ユーザーからの報告で重大な問題が発見された場合

## 5. 実行タイミング

### 5.1 推奨実行時間
- **実行日時**: 業務時間外（夜間または休日）
- **実行時間**: 約30分（バックアップ含む）

### 5.2 実行前の確認事項
- [ ] バックアップが正常に取得できているか
- [ ] 影響範囲の最終確認が完了しているか
- [ ] 移行スクリプトの動作確認が完了しているか
- [ ] ロールバック手順の確認が完了しているか

## 6. 実行後のモニタリング

### 6.1 モニタリング項目
- エラーログの確認
- 訪問記録画面の動作確認
- 月次レセプト作成時の動作確認
- ユーザーからの報告の確認

### 6.2 モニタリング期間
- **即座**: 移行直後の動作確認
- **1週間**: 日常業務での動作確認
- **1ヶ月**: 月次レセプト作成時の動作確認

## 7. 実行チェックリスト

### 7.1 事前準備
- [ ] バックアップ取得
- [ ] 影響範囲の最終確認
- [ ] 移行スクリプトの動作確認
- [ ] ロールバック手順の確認

### 7.2 移行実行
- [ ] ステップ1: サービスコードマスタのコピー
- [ ] ステップ2: 訪問記録のサービスコードID更新
- [ ] ステップ3: 誤ったコードの無効化
- [ ] ステップ4: データ整合性の確認

### 7.3 移行後検証
- [ ] データ検証
- [ ] 機能検証
- [ ] モニタリング開始

## 8. 関連スクリプト

### 8.1 移行スクリプト
- `scripts/migrate-service-codes-to-production.ts` - サービスコードマスタの移行
- `scripts/update-service-code-references.ts` - 訪問記録の参照更新
- `scripts/deactivate-wrong-service-codes.ts` - 誤ったコードの無効化
- `scripts/verify-migration.ts` - 移行後の検証

### 8.2 確認スクリプト
- `scripts/check-production-service-code-usage.ts` - 使用状況確認
- `scripts/check-detailed-impact.ts` - 影響範囲の詳細確認
- `scripts/create-accurate-service-code-mapping.ts` - マッピング確認

## 9. 承認と実行

### 9.1 承認者
- [ ] システム管理者
- [ ] 業務責任者

### 9.2 実行者
- システム管理者（技術的な実行）
- 業務責任者（業務的な確認）

## 10. 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|--------|
| 2025-11-XX | 初版作成 | - |

