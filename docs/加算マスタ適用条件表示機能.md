# 加算マスタ管理画面 - 適用条件表示機能

**実装日**: 2025-10-24
**対象画面**: 加算マスタ管理 > 編集ダイアログ > 詳細設定タブ

---

## 📋 機能概要

加算マスタの `predefined_conditions` フィールドを解析し、人間が読みやすい日本語で適用条件を自動表示する機能。

### ユーザーメリット

| 項目 | 詳細 |
|------|------|
| **可視化** | プログラム内の条件が人間が読める形で表示される |
| **メンテナンス不要** | `predefined_conditions` から自動生成されるため手動更新不要 |
| **柔軟な補足説明** | 備考欄で追加の説明を記載可能 |
| **条件変更時も安心** | データベースの条件が変わると自動で表示も更新 |

---

## 🎯 表示ルール

### 基本原則

条件の設定場所に応じて、接頭語を統一：

| 条件の場所 | 接頭語 | 例 |
|-----------|--------|-----|
| 訪問記録のチェックボックス | **訪問記録の** | 訪問記録の「退院日当日の訪問」にチェックあり |
| 訪問記録の入力フィールド | **訪問記録の** | 訪問記録の「緊急訪問の理由」に入力あり |
| 訪問時間・時刻 | **訪問〜** | 訪問時間が90分以上 |
| 施設体制フラグ | **施設管理の** | 施設管理の「24時間対応体制加算（基本）」が有効 |
| 患者マスタ設定 | **患者に** | 患者に建物（施設）が設定されている |

---

## 📊 パターン別表示マップ

### Phase 2-A: 訪問記録のチェックボックス条件

| パターン名 | true の場合 | false の場合 |
|-----------|------------|-------------|
| `is_discharge_date` | 訪問記録の「退院日当日の訪問」にチェックあり | 訪問記録の「退院日当日の訪問」にチェックなし |
| `is_first_visit_of_plan` | 訪問記録の「新規計画書作成後の初回訪問」にチェックあり | 訪問記録の「新規計画書作成後の初回訪問」にチェックなし |
| `has_collaboration_record` | 訪問記録の「多職種連携記録」にチェックあり | 訪問記録の「多職種連携記録」にチェックなし |
| `is_terminal_care` | 訪問記録の「ターミナルケア」にチェックあり | 訪問記録の「ターミナルケア」にチェックなし |

### Phase 2-A: 訪問時間の条件

| パターン名 | true の場合 | false の場合 |
|-----------|------------|-------------|
| `care_visit_duration_90plus` | 訪問時間が90分以上 | 訪問時間が90分未満 |
| `care_early_morning_time` | 訪問時刻が早朝（6:00-8:00） | 訪問時刻が早朝（6:00-8:00）以外 |
| `care_night_time` | 訪問時刻が夜間（18:00-22:00） | 訪問時刻が夜間（18:00-22:00）以外 |
| `care_late_night_time` | 訪問時刻が深夜（22:00-6:00） | 訪問時刻が深夜（22:00-6:00）以外 |

### Phase 2-1: 施設体制フラグ条件

| パターン名 | true の場合 | false の場合 |
|-----------|------------|-------------|
| `has_24h_support_system` | 施設管理の「24時間対応体制加算（基本）」が有効 | 施設管理の「24時間対応体制加算（基本）」が無効 |
| `has_24h_support_system_enhanced` | 施設管理の「24時間対応体制加算（看護業務負担軽減）」が有効 | 施設管理の「24時間対応体制加算（看護業務負担軽減）」が無効 |
| `has_emergency_support_system` | 施設管理の「緊急時訪問看護加算（I）」が有効 | 施設管理の「緊急時訪問看護加算（I）」が無効 |
| `has_emergency_support_system_enhanced` | 施設管理の「緊急時訪問看護加算（II）」が有効 | 施設管理の「緊急時訪問看護加算（II）」が無効 |

### Phase 1: 基本的な条件

| パターン名 | true の場合 | false の場合 |
|-----------|------------|-------------|
| `field_not_empty` | 訪問記録の「[フィールド名]」に入力あり | 訪問記録の「[フィールド名]」に入力なし |
| `is_second_visit` | 当日2回目の訪問 | 当日2回目の訪問ではない |
| `has_building` | 患者に建物（施設）が設定されている | 患者に建物（施設）が設定されていない |

---

## 💻 実装詳細

### ファイル

`client/src/components/BonusMasterManagement.tsx`

### 主要コンポーネント

```typescript
function PredefinedConditionsDisplay({ conditions }: { conditions: unknown }) {
  const conditionsArray = conditions as any[];

  // パターン名から人間が読みやすい具体的な表現を生成
  const getReadableCondition = (condition: any): string => {
    const pattern = condition.pattern || condition.type;
    const operator = condition.operator;
    const value = condition.value;

    // パターンごとの具体的な表現マップ
    const patternDescriptions: Record<string, { withCheck: string; withoutCheck: string }> = {
      // ... マッピング辞書 ...
    };

    // パターンが定義されている場合
    if (pattern && patternDescriptions[pattern]) {
      // operator と value が設定されている場合
      if (operator === "equals") {
        return value === true
          ? patternDescriptions[pattern].withCheck
          : patternDescriptions[pattern].withoutCheck;
      }
      // operator が設定されていない場合（デフォルトで true とみなす）
      if (!operator || operator === undefined) {
        return patternDescriptions[pattern].withCheck;
      }
    }

    // 数値比較や他の演算子の処理
    // ...

    return pattern || "条件説明なし";
  };

  return (
    <div className="space-y-2">
      <Label>適用条件</Label>
      <div className="border rounded-md p-3 bg-muted/50 space-y-2">
        {/* 条件リストの表示 */}
      </div>
      <p className="text-xs text-muted-foreground mt-1">
        ※ 適用条件はプログラムで管理されています。詳細な補足説明が必要な場合は備考欄をご利用ください。
      </p>
    </div>
  );
}
```

### 条件形式のサポート

#### 形式1: pattern + operator + value（Phase 2-A）

```json
{
  "pattern": "is_discharge_date",
  "operator": "equals",
  "value": true,
  "description": "退院日当日の訪問"
}
```

**表示**: 訪問記録の「退院日当日の訪問」にチェックあり

#### 形式2: type のみ（Phase 2-1）

```json
{
  "type": "has_emergency_support_system"
}
```

**表示**: 施設管理の「緊急時訪問看護加算（I）」が有効

---

## 📖 表示例

### 退院時共同指導加算（医療保険）

**データベース:**
```json
[
  {
    "pattern": "is_discharge_date",
    "operator": "equals",
    "value": true,
    "description": "退院日当日の訪問"
  },
  {
    "pattern": "has_collaboration_record",
    "operator": "equals",
    "value": true,
    "description": "多職種連携記録あり"
  }
]
```

**画面表示:**
```
適用条件
1. 訪問記録の「退院日当日の訪問」にチェックあり
2. 訪問記録の「多職種連携記録」にチェックあり
```

---

### 初回加算（I）（介護保険）

**データベース:**
```json
[
  {
    "pattern": "is_first_visit_of_plan",
    "operator": "equals",
    "value": true,
    "description": "新規計画初回訪問"
  },
  {
    "pattern": "care_visit_duration_90plus",
    "operator": "equals",
    "value": false,
    "description": "訪問時間が90分未満"
  }
]
```

**画面表示:**
```
適用条件
1. 訪問記録の「新規計画書作成後の初回訪問」にチェックあり
2. 訪問時間が90分未満
```

---

### 24時間対応体制加算（基本）

**データベース:**
```json
[
  {
    "type": "has_24h_support_system"
  }
]
```

**画面表示:**
```
適用条件
1. 施設管理の「24時間対応体制加算（基本）」が有効
```

---

## 🔧 新しいパターンの追加方法

### 手順

1. **bonus-engine.ts に評価関数を追加**

```typescript
function evaluateNewPattern(context: BonusCalculationContext): ConditionEvaluationResult {
  // 条件評価ロジック
  return {
    passed: true/false,
    reason: "条件の説明",
  };
}
```

2. **evaluatePredefinedCondition の switch に追加**

```typescript
case "new_pattern":
  result = evaluateNewPattern(context);
  break;
```

3. **BonusMasterManagement.tsx のマッピング辞書に追加**

```typescript
const patternDescriptions: Record<string, { withCheck: string; withoutCheck: string }> = {
  // ...既存のパターン...
  new_pattern: {
    withCheck: '訪問記録の「新しい条件」にチェックあり',
    withoutCheck: '訪問記録の「新しい条件」にチェックなし',
  },
};
```

4. **加算マスタに predefined_conditions を設定**

```sql
UPDATE bonus_master
SET predefined_conditions = '[
  {
    "pattern": "new_pattern",
    "operator": "equals",
    "value": true,
    "description": "新しい条件"
  }
]'::jsonb
WHERE bonus_code = 'your_bonus_code';
```

---

## 🎨 UI/UX 設計

### 配置
- 加算マスタ編集ダイアログ > 詳細設定タブの最上部
- 備考フィールドの上に配置

### スタイル
- 背景: `bg-muted/50`（薄いグレー）
- 枠線: 角丸ボーダー
- 番号バッジ: `outline` バリアント
- 注釈: 小さいグレーテキスト

### アクセシビリティ
- 読み取り専用（編集不可）
- スクリーンリーダー対応
- 明確な視覚的階層

---

## 📝 今後の拡張案

### 優先度: 高
1. **条件の詳細説明ツールチップ** - ホバーで詳細情報を表示
2. **条件の検証機能** - 設定された条件が実装済みかチェック

### 優先度: 中
3. **条件のグループ化** - AND/OR 条件の視覚的グループ化
4. **条件の編集UI** - predefined_conditions の GUI エディタ

### 優先度: 低
5. **条件の検索機能** - パターン名で加算を検索
6. **条件の一覧エクスポート** - 全加算の条件をCSV出力

---

**作成者**: Claude Code
**最終更新**: 2025-10-24
