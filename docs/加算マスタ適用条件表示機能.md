# åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ - é©ç”¨æ¡ä»¶è¡¨ç¤ºæ©Ÿèƒ½

**å®Ÿè£…æ—¥**: 2025-10-24
**å¯¾è±¡ç”»é¢**: åŠ ç®—ãƒã‚¹ã‚¿ç®¡ç† > ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° > è©³ç´°è¨­å®šã‚¿ãƒ–

---

## ğŸ“‹ æ©Ÿèƒ½æ¦‚è¦

åŠ ç®—ãƒã‚¹ã‚¿ã® `predefined_conditions` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è§£æã—ã€äººé–“ãŒèª­ã¿ã‚„ã™ã„æ—¥æœ¬èªã§é©ç”¨æ¡ä»¶ã‚’è‡ªå‹•è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆ

| é …ç›® | è©³ç´° |
|------|------|
| **å¯è¦–åŒ–** | ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã®æ¡ä»¶ãŒäººé–“ãŒèª­ã‚ã‚‹å½¢ã§è¡¨ç¤ºã•ã‚Œã‚‹ |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸è¦** | `predefined_conditions` ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚æ‰‹å‹•æ›´æ–°ä¸è¦ |
| **æŸ”è»Ÿãªè£œè¶³èª¬æ˜** | å‚™è€ƒæ¬„ã§è¿½åŠ ã®èª¬æ˜ã‚’è¨˜è¼‰å¯èƒ½ |
| **æ¡ä»¶å¤‰æ›´æ™‚ã‚‚å®‰å¿ƒ** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¡ä»¶ãŒå¤‰ã‚ã‚‹ã¨è‡ªå‹•ã§è¡¨ç¤ºã‚‚æ›´æ–° |

---

## ğŸ¯ è¡¨ç¤ºãƒ«ãƒ¼ãƒ«

### åŸºæœ¬åŸå‰‡

æ¡ä»¶ã®è¨­å®šå ´æ‰€ã«å¿œã˜ã¦ã€æ¥é ­èªã‚’çµ±ä¸€ï¼š

| æ¡ä»¶ã®å ´æ‰€ | æ¥é ­èª | ä¾‹ |
|-----------|--------|-----|
| è¨ªå•è¨˜éŒ²ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ | **è¨ªå•è¨˜éŒ²ã®** | è¨ªå•è¨˜éŒ²ã®ã€Œé€€é™¢æ—¥å½“æ—¥ã®è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š |
| è¨ªå•è¨˜éŒ²ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | **è¨ªå•è¨˜éŒ²ã®** | è¨ªå•è¨˜éŒ²ã®ã€Œç·Šæ€¥è¨ªå•ã®ç†ç”±ã€ã«å…¥åŠ›ã‚ã‚Š |
| è¨ªå•æ™‚é–“ãƒ»æ™‚åˆ» | **è¨ªå•ã€œ** | è¨ªå•æ™‚é–“ãŒ90åˆ†ä»¥ä¸Š |
| æ–½è¨­ä½“åˆ¶ãƒ•ãƒ©ã‚° | **æ–½è¨­ç®¡ç†ã®** | æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ã€ãŒæœ‰åŠ¹ |
| æ‚£è€…ãƒã‚¹ã‚¿è¨­å®š | **æ‚£è€…ã«** | æ‚£è€…ã«å»ºç‰©ï¼ˆæ–½è¨­ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ |

---

## ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥è¡¨ç¤ºãƒãƒƒãƒ—

### Phase 2-A: è¨ªå•è¨˜éŒ²ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ¡ä»¶

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | true ã®å ´åˆ | false ã®å ´åˆ |
|-----------|------------|-------------|
| `is_discharge_date` | è¨ªå•è¨˜éŒ²ã®ã€Œé€€é™¢æ—¥å½“æ—¥ã®è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š | è¨ªå•è¨˜éŒ²ã®ã€Œé€€é™¢æ—¥å½“æ—¥ã®è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ãªã— |
| `is_first_visit_of_plan` | è¨ªå•è¨˜éŒ²ã®ã€Œæ–°è¦è¨ˆç”»æ›¸ä½œæˆå¾Œã®åˆå›è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š | è¨ªå•è¨˜éŒ²ã®ã€Œæ–°è¦è¨ˆç”»æ›¸ä½œæˆå¾Œã®åˆå›è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ãªã— |
| `has_collaboration_record` | è¨ªå•è¨˜éŒ²ã®ã€Œå¤šè·ç¨®é€£æºè¨˜éŒ²ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š | è¨ªå•è¨˜éŒ²ã®ã€Œå¤šè·ç¨®é€£æºè¨˜éŒ²ã€ã«ãƒã‚§ãƒƒã‚¯ãªã— |
| `is_terminal_care` | è¨ªå•è¨˜éŒ²ã®ã€Œã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š | è¨ªå•è¨˜éŒ²ã®ã€Œã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ã€ã«ãƒã‚§ãƒƒã‚¯ãªã— |

### Phase 2-A: è¨ªå•æ™‚é–“ã®æ¡ä»¶

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | true ã®å ´åˆ | false ã®å ´åˆ |
|-----------|------------|-------------|
| `care_visit_duration_90plus` | è¨ªå•æ™‚é–“ãŒ90åˆ†ä»¥ä¸Š | è¨ªå•æ™‚é–“ãŒ90åˆ†æœªæº€ |
| `care_early_morning_time` | è¨ªå•æ™‚åˆ»ãŒæ—©æœï¼ˆ6:00-8:00ï¼‰ | è¨ªå•æ™‚åˆ»ãŒæ—©æœï¼ˆ6:00-8:00ï¼‰ä»¥å¤– |
| `care_night_time` | è¨ªå•æ™‚åˆ»ãŒå¤œé–“ï¼ˆ18:00-22:00ï¼‰ | è¨ªå•æ™‚åˆ»ãŒå¤œé–“ï¼ˆ18:00-22:00ï¼‰ä»¥å¤– |
| `care_late_night_time` | è¨ªå•æ™‚åˆ»ãŒæ·±å¤œï¼ˆ22:00-6:00ï¼‰ | è¨ªå•æ™‚åˆ»ãŒæ·±å¤œï¼ˆ22:00-6:00ï¼‰ä»¥å¤– |

### Phase 2-1: æ–½è¨­ä½“åˆ¶ãƒ•ãƒ©ã‚°æ¡ä»¶

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | true ã®å ´åˆ | false ã®å ´åˆ |
|-----------|------------|-------------|
| `has_24h_support_system` | æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ã€ãŒæœ‰åŠ¹ | æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ã€ãŒç„¡åŠ¹ |
| `has_24h_support_system_enhanced` | æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆçœ‹è­·æ¥­å‹™è² æ‹…è»½æ¸›ï¼‰ã€ãŒæœ‰åŠ¹ | æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆçœ‹è­·æ¥­å‹™è² æ‹…è»½æ¸›ï¼‰ã€ãŒç„¡åŠ¹ |
| `has_emergency_support_system` | æ–½è¨­ç®¡ç†ã®ã€Œç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—ï¼ˆIï¼‰ã€ãŒæœ‰åŠ¹ | æ–½è¨­ç®¡ç†ã®ã€Œç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—ï¼ˆIï¼‰ã€ãŒç„¡åŠ¹ |
| `has_emergency_support_system_enhanced` | æ–½è¨­ç®¡ç†ã®ã€Œç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—ï¼ˆIIï¼‰ã€ãŒæœ‰åŠ¹ | æ–½è¨­ç®¡ç†ã®ã€Œç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—ï¼ˆIIï¼‰ã€ãŒç„¡åŠ¹ |

### Phase 1: åŸºæœ¬çš„ãªæ¡ä»¶

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | true ã®å ´åˆ | false ã®å ´åˆ |
|-----------|------------|-------------|
| `field_not_empty` | è¨ªå•è¨˜éŒ²ã®ã€Œ[ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å]ã€ã«å…¥åŠ›ã‚ã‚Š | è¨ªå•è¨˜éŒ²ã®ã€Œ[ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å]ã€ã«å…¥åŠ›ãªã— |
| `is_second_visit` | å½“æ—¥2å›ç›®ã®è¨ªå• | å½“æ—¥2å›ç›®ã®è¨ªå•ã§ã¯ãªã„ |
| `has_building` | æ‚£è€…ã«å»ºç‰©ï¼ˆæ–½è¨­ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ | æ‚£è€…ã«å»ºç‰©ï¼ˆæ–½è¨­ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ |

---

## ğŸ’» å®Ÿè£…è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«

`client/src/components/BonusMasterManagement.tsx`

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
function PredefinedConditionsDisplay({ conditions }: { conditions: unknown }) {
  const conditionsArray = conditions as any[];

  // ãƒ‘ã‚¿ãƒ¼ãƒ³åã‹ã‚‰äººé–“ãŒèª­ã¿ã‚„ã™ã„å…·ä½“çš„ãªè¡¨ç¾ã‚’ç”Ÿæˆ
  const getReadableCondition = (condition: any): string => {
    const pattern = condition.pattern || condition.type;
    const operator = condition.operator;
    const value = condition.value;

    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å…·ä½“çš„ãªè¡¨ç¾ãƒãƒƒãƒ—
    const patternDescriptions: Record<string, { withCheck: string; withoutCheck: string }> = {
      // ... ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ ...
    };

    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (pattern && patternDescriptions[pattern]) {
      // operator ã¨ value ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (operator === "equals") {
        return value === true
          ? patternDescriptions[pattern].withCheck
          : patternDescriptions[pattern].withoutCheck;
      }
      // operator ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ true ã¨ã¿ãªã™ï¼‰
      if (!operator || operator === undefined) {
        return patternDescriptions[pattern].withCheck;
      }
    }

    // æ•°å€¤æ¯”è¼ƒã‚„ä»–ã®æ¼”ç®—å­ã®å‡¦ç†
    // ...

    return pattern || "æ¡ä»¶èª¬æ˜ãªã—";
  };

  return (
    <div className="space-y-2">
      <Label>é©ç”¨æ¡ä»¶</Label>
      <div className="border rounded-md p-3 bg-muted/50 space-y-2">
        {/* æ¡ä»¶ãƒªã‚¹ãƒˆã®è¡¨ç¤º */}
      </div>
      <p className="text-xs text-muted-foreground mt-1">
        â€» é©ç”¨æ¡ä»¶ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ãªè£œè¶³èª¬æ˜ãŒå¿…è¦ãªå ´åˆã¯å‚™è€ƒæ¬„ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
      </p>
    </div>
  );
}
```

### æ¡ä»¶å½¢å¼ã®ã‚µãƒãƒ¼ãƒˆ

#### å½¢å¼1: pattern + operator + valueï¼ˆPhase 2-Aï¼‰

```json
{
  "pattern": "is_discharge_date",
  "operator": "equals",
  "value": true,
  "description": "é€€é™¢æ—¥å½“æ—¥ã®è¨ªå•"
}
```

**è¡¨ç¤º**: è¨ªå•è¨˜éŒ²ã®ã€Œé€€é™¢æ—¥å½“æ—¥ã®è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š

#### å½¢å¼2: type ã®ã¿ï¼ˆPhase 2-1ï¼‰

```json
{
  "type": "has_emergency_support_system"
}
```

**è¡¨ç¤º**: æ–½è¨­ç®¡ç†ã®ã€Œç·Šæ€¥æ™‚è¨ªå•çœ‹è­·åŠ ç®—ï¼ˆIï¼‰ã€ãŒæœ‰åŠ¹

---

## ğŸ“– è¡¨ç¤ºä¾‹

### é€€é™¢æ™‚å…±åŒæŒ‡å°åŠ ç®—ï¼ˆåŒ»ç™‚ä¿é™ºï¼‰

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
```json
[
  {
    "pattern": "is_discharge_date",
    "operator": "equals",
    "value": true,
    "description": "é€€é™¢æ—¥å½“æ—¥ã®è¨ªå•"
  },
  {
    "pattern": "has_collaboration_record",
    "operator": "equals",
    "value": true,
    "description": "å¤šè·ç¨®é€£æºè¨˜éŒ²ã‚ã‚Š"
  }
]
```

**ç”»é¢è¡¨ç¤º:**
```
é©ç”¨æ¡ä»¶
1. è¨ªå•è¨˜éŒ²ã®ã€Œé€€é™¢æ—¥å½“æ—¥ã®è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š
2. è¨ªå•è¨˜éŒ²ã®ã€Œå¤šè·ç¨®é€£æºè¨˜éŒ²ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š
```

---

### åˆå›åŠ ç®—ï¼ˆIï¼‰ï¼ˆä»‹è­·ä¿é™ºï¼‰

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
```json
[
  {
    "pattern": "is_first_visit_of_plan",
    "operator": "equals",
    "value": true,
    "description": "æ–°è¦è¨ˆç”»åˆå›è¨ªå•"
  },
  {
    "pattern": "care_visit_duration_90plus",
    "operator": "equals",
    "value": false,
    "description": "è¨ªå•æ™‚é–“ãŒ90åˆ†æœªæº€"
  }
]
```

**ç”»é¢è¡¨ç¤º:**
```
é©ç”¨æ¡ä»¶
1. è¨ªå•è¨˜éŒ²ã®ã€Œæ–°è¦è¨ˆç”»æ›¸ä½œæˆå¾Œã®åˆå›è¨ªå•ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š
2. è¨ªå•æ™‚é–“ãŒ90åˆ†æœªæº€
```

---

### 24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
```json
[
  {
    "type": "has_24h_support_system"
  }
]
```

**ç”»é¢è¡¨ç¤º:**
```
é©ç”¨æ¡ä»¶
1. æ–½è¨­ç®¡ç†ã®ã€Œ24æ™‚é–“å¯¾å¿œä½“åˆ¶åŠ ç®—ï¼ˆåŸºæœ¬ï¼‰ã€ãŒæœ‰åŠ¹
```

---

## ğŸ”§ æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ æ–¹æ³•

### æ‰‹é †

1. **bonus-engine.ts ã«è©•ä¾¡é–¢æ•°ã‚’è¿½åŠ **

```typescript
function evaluateNewPattern(context: BonusCalculationContext): ConditionEvaluationResult {
  // æ¡ä»¶è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
  return {
    passed: true/false,
    reason: "æ¡ä»¶ã®èª¬æ˜",
  };
}
```

2. **evaluatePredefinedCondition ã® switch ã«è¿½åŠ **

```typescript
case "new_pattern":
  result = evaluateNewPattern(context);
  break;
```

3. **BonusMasterManagement.tsx ã®ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ã«è¿½åŠ **

```typescript
const patternDescriptions: Record<string, { withCheck: string; withoutCheck: string }> = {
  // ...æ—¢å­˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³...
  new_pattern: {
    withCheck: 'è¨ªå•è¨˜éŒ²ã®ã€Œæ–°ã—ã„æ¡ä»¶ã€ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š',
    withoutCheck: 'è¨ªå•è¨˜éŒ²ã®ã€Œæ–°ã—ã„æ¡ä»¶ã€ã«ãƒã‚§ãƒƒã‚¯ãªã—',
  },
};
```

4. **åŠ ç®—ãƒã‚¹ã‚¿ã« predefined_conditions ã‚’è¨­å®š**

```sql
UPDATE bonus_master
SET predefined_conditions = '[
  {
    "pattern": "new_pattern",
    "operator": "equals",
    "value": true,
    "description": "æ–°ã—ã„æ¡ä»¶"
  }
]'::jsonb
WHERE bonus_code = 'your_bonus_code';
```

---

## ğŸ¨ UI/UX è¨­è¨ˆ

### é…ç½®
- åŠ ç®—ãƒã‚¹ã‚¿ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° > è©³ç´°è¨­å®šã‚¿ãƒ–ã®æœ€ä¸Šéƒ¨
- å‚™è€ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸Šã«é…ç½®

### ã‚¹ã‚¿ã‚¤ãƒ«
- èƒŒæ™¯: `bg-muted/50`ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
- æ ç·š: è§’ä¸¸ãƒœãƒ¼ãƒ€ãƒ¼
- ç•ªå·ãƒãƒƒã‚¸: `outline` ãƒãƒªã‚¢ãƒ³ãƒˆ
- æ³¨é‡ˆ: å°ã•ã„ã‚°ãƒ¬ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ

### ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
- èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆç·¨é›†ä¸å¯ï¼‰
- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œ
- æ˜ç¢ºãªè¦–è¦šçš„éšå±¤

---

## ğŸ“ ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

### å„ªå…ˆåº¦: é«˜
1. **æ¡ä»¶ã®è©³ç´°èª¬æ˜ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—** - ãƒ›ãƒãƒ¼ã§è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
2. **æ¡ä»¶ã®æ¤œè¨¼æ©Ÿèƒ½** - è¨­å®šã•ã‚ŒãŸæ¡ä»¶ãŒå®Ÿè£…æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯

### å„ªå…ˆåº¦: ä¸­
3. **æ¡ä»¶ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–** - AND/OR æ¡ä»¶ã®è¦–è¦šçš„ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
4. **æ¡ä»¶ã®ç·¨é›†UI** - predefined_conditions ã® GUI ã‚¨ãƒ‡ã‚£ã‚¿

### å„ªå…ˆåº¦: ä½
5. **æ¡ä»¶ã®æ¤œç´¢æ©Ÿèƒ½** - ãƒ‘ã‚¿ãƒ¼ãƒ³åã§åŠ ç®—ã‚’æ¤œç´¢
6. **æ¡ä»¶ã®ä¸€è¦§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** - å…¨åŠ ç®—ã®æ¡ä»¶ã‚’CSVå‡ºåŠ›

---

**ä½œæˆè€…**: Claude Code
**æœ€çµ‚æ›´æ–°**: 2025-10-24
