<!-- 9774256e-44cb-49d6-85af-d0770c9941c7 1f71bf36-278f-43e1-ac1e-1826a77ac141 -->
# KAレコードの訪問看護療養費コード修正プラン

## 問題点

現在、KAレコードの訪問看護療養費コードが`000000000`を出力していますが、これはサービスコードマスタに存在しない無効なコードです。

## 原因

- `nursingRecords`テーブルの`serviceCodeId`は`nursingServiceCodes`テーブルの`id`（UUID）への参照
- 実際のサービスコード（9桁）は`nursingServiceCodes.serviceCode`フィールドに格納されている
- 現在の実装では、`record.serviceCodeId`（UUID）をそのまま使用しているため、デフォルト値`'000000000'`が使用されている

## 修正内容

### 1. 訪問記録取得時にサービスコードリレーションを含める

`server/routes.ts`の`nursingRecords`取得時に、`serviceCode`リレーションを含めて取得する

### 2. CSVデータ構築時に実際のサービスコードを取得

`nursingRecords`マッピング時に、`record.serviceCode?.serviceCode`から実際の9桁サービスコードを取得する

### 3. デフォルト値の見直し

サービスコードが取得できない場合のデフォルト値を、有効なサービスコードに変更するか、エラーを返す

## 実装ファイル

- `server/routes.ts`: CSVエクスポートエンドポイントの修正

## 注意点

- Drizzleのリレーションを使用してサービスコードを取得する
- サービスコードが存在しない場合は適切にエラーハンドリングする